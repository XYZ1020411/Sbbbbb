<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šåŠŸèƒ½ç™»éŒ„ç³»çµ±</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            color: #333; 
            margin: 0; 
            padding: 0; 
            background-color: #FFD700; /* é‡‘é»ƒè‰²èƒŒæ™¯ */
            font-size: 18px; /* æ”¾å¤§å­—é«” */
        }
        .container { 
            background: rgba(255,255,255,0.9); 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); 
            margin: 20px auto; 
            padding: 20px; 
            max-width: 400px; 
        }
        h2 { text-align: center; color: #b30000; font-size: 24px; }
        h3 { font-size: 20px; }
        input, textarea { 
            width: 100%; 
            padding: 10px; 
            margin: 10px 0; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            font-size: 16px;
        }
        button { 
            background-color: #FFA500; 
            color: black; 
            border: none; 
            padding: 10px; 
            border-radius: 4px; 
            cursor: pointer; 
            width: 100%; 
            margin: 5px 0; 
            transition: background-color 0.3s; 
            font-size: 16px;
        }
        button:hover { background-color: #FF8C00; }
        .hidden { display: none; }
        .cart-item { background: #e6ffe6; padding: 10px; margin: 5px 0; border-radius: 4px; }
        .message-item { background: #f9f9f9; padding: 10px; margin: 5px 0; border-radius: 4px; }
        .reply-item { background: #e6f7ff; padding: 10px; margin: 5px 0; border-radius: 4px; border-left: 4px solid #007bff; }
        .chat-container { max-height: 200px; overflow-y: auto; border: 1px solid #ccc; border-radius: 4px; padding: 10px; margin-bottom: 10px; }
        .chat-message { margin-bottom: 10px; font-size: 16px; }
        .chat-message.user { text-align: right; }
        .chat-message.ai { text-align: left; }
        .announcement { background: #fff3e0; padding: 10px; border-radius: 4px; margin-bottom: 10px; font-size: 16px; }
        .time-display { text-align: center; font-size: 1.2em; margin-bottom: 10px; }
        #barcodeContainer {
            text-align: center;
            margin: 20px 0;
        }
        #barcodeContainer img {
            max-width: 100%;
            height: auto;
        }
        .progress-container {
            width: 100%;
            background-color: #ddd;
            border-radius: 5px;
            margin: 10px 0;
        }
        .progress-bar {
            height: 20px;
            background-color: #4CAF50;
            border-radius: 5px;
            text-align: center;
            line-height: 20px;
            color: white;
            transition: width 0.3s;
        }
        .vip-level {
            font-weight: bold;
            color: #b30000;
            margin: 10px 0;
            text-align: center;
            font-size: 18px;
        }
        .vip-benefits {
            background-color: #fff3e0;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 16px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
</head>
<body>
    <!-- ç™»éŒ„é¸é …é¸æ“‡ç•Œé¢ -->
    <div class="container" id="loginOptionContainer">
        <h2>è«‹é¸æ“‡ç™»éŒ„é¡å‹</h2>
        <button onclick="showLoginForm('vip')">VIP æœƒå“¡ç™»éŒ„</button>
        <button onclick="showLoginForm('normal')">æ™®é€šå®¢æˆ¶ç™»éŒ„</button>
        <button onclick="showLoginForm('admin')">ç®¡ç†å“¡ç™»éŒ„</button>
    </div>

    <!-- VIP ç™»éŒ„ç•Œé¢ -->
    <div class="container hidden" id="vipLoginContainer">
        <h2>VIP æœƒå“¡ç™»éŒ„</h2>
        <input type="text" id="vipUsername" placeholder="VIP å¸³è™Ÿ">
        <input type="password" id="vipPassword" placeholder="VIP å¯†ç¢¼">
        <button onclick="vipLogin()">VIP ç™»éŒ„</button>
        <button onclick="backToLoginOptions()">è¿”å›</button>
    </div>

    <!-- æ™®é€šå®¢æˆ¶ç™»éŒ„ç•Œé¢ -->
    <div class="container hidden" id="normalLoginContainer">
        <h2>æ™®é€šå®¢æˆ¶ç™»éŒ„</h2>
        <input type="text" id="normalUsername" placeholder="ç”¨æˆ¶å">
        <input type="password" id="normalPassword" placeholder="å¯†ç¢¼">
        <button onclick="normalLogin()">ç™»éŒ„</button>
        <button onclick="toggleVisibility('registerContainer', true)">è¨»å†Šæ–°å¸³è™Ÿ</button>
        <button onclick="backToLoginOptions()">è¿”å›</button>
    </div>

    <!-- ç®¡ç†å“¡ç™»éŒ„ç•Œé¢ -->
    <div class="container hidden" id="adminLoginContainer">
        <h2>ç®¡ç†å“¡ç™»éŒ„</h2>
        <input type="text" id="adminUsername" placeholder="ç®¡ç†å“¡å¸³è™Ÿ">
        <input type="password" id="adminPassword" placeholder="ç®¡ç†å“¡å¯†ç¢¼">
        <button onclick="adminLogin()">ç®¡ç†å“¡ç™»éŒ„</button>
        <button onclick="backToLoginOptions()">è¿”å›</button>
    </div>

    <!-- è¨»å†Šç•Œé¢ -->
    <div class="container hidden" id="registerContainer">
        <h2>è¨»å†Šæ–°å¸³è™Ÿ</h2>
        <input type="text" id="newUsername" placeholder="ç”¨æˆ¶å">
        <input type="password" id="newPassword" placeholder="å¯†ç¢¼">
        <button onclick="register()">è¨»å†Š</button>
        <button onclick="toggleVisibility('registerContainer', false)">è¿”å›</button>
    </div>

    <!-- VIP åŠŸèƒ½ç•Œé¢ -->
    <div class="container hidden" id="vipContainer">
        <h2 id="vipTitle">ğŸ›ï¸ å°Šè²´çš„ VIP æœƒå“¡æ‚¨å¥½ï¼</h2>
        <div class="vip-level" id="vipLevelDisplay"></div>
        <div class="time-display" id="currentTime"></div>
        <div id="announcementContainer" class="announcement"></div>
        
        <div class="progress-container">
            <div id="pointsProgress" class="progress-bar"></div>
        </div>
        
        <div class="vip-benefits" id="vipBenefits"></div>
        
        <button onclick="vipCheckIn()" id="checkInButton">æ¯æ—¥ç°½åˆ°</button>
        <button onclick="viewPoints()">æŸ¥çœ‹é»æ•¸</button>
        
        <h3>VIP å°ˆå±¬å•†å“</h3>
        <div id="redeemItemsContainer"></div>
        
        <h3>è³¼ç‰©è»Š</h3>
        <div id="cartContainer"></div>
        <button onclick="vipCheckout()">VIP çµå¸³ (8æŠ˜)</button>
        
        <h3>VIP åˆ®åˆ®æ¨‚</h3>
        <button onclick="vipBuyScratchCard()">è³¼è²·åˆ®åˆ®æ¨‚ï¼ˆ5 é»ï¼‰</button>
        <div id="scratchCard"><div id="scratchResult"></div></div>
        
        <h3>å…Œæ›ç¢¼</h3>
        <input type="text" id="redeemCode" placeholder="è¼¸å…¥å…Œæ›ç¢¼">
        <button onclick="redeemWithCode()">å…Œæ›ç¢¼å…Œæ›</button>
        
        <h3>å®¶å‹™å·</h3>
        <textarea id="houseworkInput" placeholder="è«‹è¼¸å…¥å®¶å‹™å…§å®¹..."></textarea>
        <button onclick="generateHouseworkBarcode()">ç”Ÿæˆå®¶å‹™å·æ¢ç¢¼</button>
        <div id="barcodeContainer"></div>
    </div>

    <!-- æ™®é€šå®¢æˆ¶åŠŸèƒ½ç•Œé¢ -->
    <div class="container hidden" id="customerContainer">
        <h2 id="customerTitle">å®¢æˆ¶åŠŸèƒ½</h2>
        <div class="vip-level" id="customerLevelDisplay"></div>
        <div class="time-display" id="currentTime"></div>
        <div id="announcementContainer" class="announcement"></div>
        
        <div class="progress-container">
            <div id="customerPointsProgress" class="progress-bar"></div>
        </div>
        
        <button onclick="checkIn()" id="customerCheckInButton">æ¯æ—¥ç°½åˆ°</button>
        <button onclick="viewPoints()">æŸ¥çœ‹é»æ•¸</button>
        <button onclick="toggleVisibility('changePasswordContainer', true)">æ›´æ”¹å¯†ç¢¼</button>
        
        <h3>å¯å…Œæ›ç‰©å“</h3>
        <div id="redeemItemsContainer"></div>
        
        <h3>è³¼ç‰©è»Š</h3>
        <div id="cartContainer"></div>
        <button onclick="checkout()">çµå¸³</button>
        
        <h3>åˆ®åˆ®æ¨‚</h3>
        <button onclick="buyScratchCard()">è³¼è²·åˆ®åˆ®æ¨‚ï¼ˆ10 é»ï¼‰</button>
        <div id="scratchCard"><div id="scratchResult"></div></div>
        
        <h3>å…Œæ›ç¢¼</h3>
        <input type="text" id="redeemCode" placeholder="è¼¸å…¥å…Œæ›ç¢¼">
        <button onclick="redeemWithCode()">å…Œæ›ç¢¼å…Œæ›</button>
    </div>

    <!-- æ›´æ”¹å¯†ç¢¼ç•Œé¢ -->
    <div class="container hidden" id="changePasswordContainer">
        <h2>æ›´æ”¹å¯†ç¢¼</h2>
        <input type="password" id="oldPassword" placeholder="èˆŠå¯†ç¢¼">
        <input type="password" id="newPassword" placeholder="æ–°å¯†ç¢¼">
        <button onclick="changePassword()">æ›´æ”¹å¯†ç¢¼</button>
        <button onclick="toggleVisibility('changePasswordContainer', false)">è¿”å›</button>
    </div>

    <!-- ç®¡ç†å“¡åŠŸèƒ½ç•Œé¢ -->
    <div class="container hidden" id="adminContainer">
        <h2>ç®¡ç†å“¡åŠŸèƒ½</h2>
        <div class="time-display" id="adminTime"></div>
        <button onclick="viewUsers()">æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ¶</button>
        
        <h3>æ–°å¢å¯å…Œæ›ç‰©å“</h3>
        <input type="text" id="itemName" placeholder="ç‰©å“åç¨±">
        <input type="number" id="itemCost" placeholder="æ‰€éœ€é»æ•¸" min="1">
        <button onclick="addRedeemItem()">æ–°å¢ç‰©å“</button>
        
        <h3>åˆªé™¤å¯å…Œæ›ç‰©å“</h3>
        <input type="text" id="deleteItemName" placeholder="ç‰©å“åç¨±">
        <button onclick="deleteRedeemItem()">åˆªé™¤ç‰©å“</button>
        
        <h3>æ–°å¢å…Œæ›ç¢¼</h3>
        <input type="text" id="newRedeemCode" placeholder="è¼¸å…¥å…Œæ›ç¢¼">
        <input type="number" id="redeemPoints" placeholder="ç²å¾—é»æ•¸" min="1">
        <button onclick="addRedeemCode()">æ–°å¢å…Œæ›ç¢¼</button>
        
        <h3>æƒææ¢ç¢¼</h3>
        <input type="text" id="barcodeInput" placeholder="è«‹æƒææ¢ç¢¼">
        <button onclick="scanBarcode()">æƒæ</button>
        <div id="barcodeResult"></div>
    </div>

<script>
// åˆå§‹åŒ–æ•¸æ“š
let currentUser = null;
let redeemItems = { 
    "VIP å•†å“A": { cost: 200, original: 250 }, 
    "VIP å•†å“B": { cost: 400, original: 500 },
    "å®¶å‹™å·": { cost: 100, original: 100, isVIP: true },
    "æ™®é€šå•†å“A": { cost: 20, original: 20 },
    "æ™®é€šå•†å“B": { cost: 50, original: 50 }
};
let redeemCodes = [{code: "vip6666", points: 10000}];
let cart = [];
let registeredUsers = JSON.parse(localStorage.getItem('registeredUsers')) || {
    "vip8888": {
        password: "vip8888",
        email: "vip8888@vip.com",
        points: 50000,
        vipLevel: 1,
        lastCheckIn: null
    },
    "001": {
        password: "001",
        email: "001@example.com",
        points: 10000000000000000000,
        vipLevel: 0,
        lastCheckIn: null
    },
    "002": {
        password: "002",
        email: "admin@example.com",
        points: 0,
        isAdmin: true
    }
};

// VIPç­‰ç´šç³»çµ±
const VIP_LEVELS = {
    0: { name: "æ™®é€šç”¨æˆ¶", nextLevelPoints: 10000, checkInPoints: 100 },
    1: { name: "æ™®é€šVIP", nextLevelPoints: 100000, checkInPoints: 1000 },
    2: { name: "é’éŠ…VIP", nextLevelPoints: 500000, checkInPoints: 5000 },
    3: { name: "ç™½éŠ€VIP", nextLevelPoints: 1000000, checkInPoints: 10000 },
    4: { name: "é»ƒé‡‘VIP", nextLevelPoints: 5000000, checkInPoints: 50000 },
    5: { name: "ç™½é‡‘VIP", nextLevelPoints: 10000000, checkInPoints: 100000 },
    6: { name: "é‘½çŸ³VIP", nextLevelPoints: 50000000, checkInPoints: 500000 },
    7: { name: "è‡³å°ŠVIP", nextLevelPoints: 100000000, checkInPoints: 1000000 },
    8: { name: "è¶…ç´šå°Šè²´VIP", nextLevelPoints: Infinity, checkInPoints: 5000000 }
};

// è¨ˆç®—VIPç­‰ç´š
function calculateVipLevel(points) {
    let level = 0;
    for (let i = 1; i <= 8; i++) {
        if (points >= VIP_LEVELS[i-1].nextLevelPoints) {
            level = i;
        } else {
            break;
        }
    }
    return level;
}

// æ›´æ–°VIPç­‰ç´šé¡¯ç¤º
function updateVipDisplay() {
    if (!currentUser) return;
    
    const level = currentUser.vipLevel || 0;
    const levelInfo = VIP_LEVELS[level];
    const nextLevelInfo = VIP_LEVELS[level + 1] || { nextLevelPoints: "å·²é”æœ€é«˜ç­‰ç´š" };
    
    const progressPercentage = level === 8 ? 100 : 
        Math.min(100, (currentUser.points / levelInfo.nextLevelPoints) * 100);
    
    const progressBar = document.getElementById(currentUser.isAdmin ? 'customerPointsProgress' : 'pointsProgress');
    if (progressBar) {
        progressBar.style.width = `${progressPercentage}%`;
        progressBar.textContent = `${Math.floor(progressPercentage)}%`;
    }
    
    const levelDisplay = document.getElementById(currentUser.isAdmin ? 'customerLevelDisplay' : 'vipLevelDisplay');
    if (levelDisplay) {
        levelDisplay.innerHTML = `
            <span style="color: ${getLevelColor(level)}">${levelInfo.name} (ç­‰ç´š ${level})</span><br>
            ç•¶å‰é»æ•¸: ${currentUser.points.toLocaleString()}<br>
            ${level < 8 ? `ä¸‹ä¸€ç­‰ç´šéœ€è¦: ${levelInfo.nextLevelPoints.toLocaleString()} é»` : 'å·²é”æœ€é«˜ç­‰ç´š'}
        `;
    }
    
    const checkInButton = document.getElementById(currentUser.isAdmin ? 'customerCheckInButton' : 'checkInButton');
    if (checkInButton) {
        checkInButton.textContent = `æ¯æ—¥ç°½åˆ° (${levelInfo.checkInPoints.toLocaleString()} é»)`;
    }
    
    const benefitsContainer = document.getElementById('vipBenefits');
    if (benefitsContainer) {
        benefitsContainer.innerHTML = `
            <strong>VIP å°ˆå±¬å„ªæƒ :</strong><br>
            â€¢ ç°½åˆ°çå‹µ: ${levelInfo.checkInPoints.toLocaleString()} é»<br>
            â€¢ è³¼ç‰©æŠ˜æ‰£: ${getDiscountForLevel(level)}æŠ˜<br>
            â€¢ åˆ®åˆ®æ¨‚åƒ¹æ ¼: ${getScratchCardPrice(level)} é»
        `;
    }
    
    const titleElement = document.getElementById(currentUser.isAdmin ? 'customerTitle' : 'vipTitle');
    if (titleElement) {
        const emoji = level >= 5 ? "ğŸ‘‘" : level >= 3 ? "ğŸ’" : "ğŸ›ï¸";
        titleElement.textContent = `${emoji} ${levelInfo.name} ${currentUser.username} æ‚¨å¥½ï¼`;
    }
}

// ç²å–ç­‰ç´šå°æ‡‰çš„é¡è‰²
function getLevelColor(level) {
    const colors = [
        "#000000", // æ™®é€š
        "#2ecc71", // æ™®é€šVIP
        "#3498db", // é’éŠ…
        "#95a5a6", // ç™½éŠ€
        "#f1c40f", // é»ƒé‡‘
        "#e67e22", // ç™½é‡‘
        "#e74c3c", // é‘½çŸ³
        "#9b59b6", // è‡³å°Š
        "#ff0000"  // è¶…ç´šå°Šè²´
    ];
    return colors[level] || "#000000";
}

// ç²å–ç­‰ç´šå°æ‡‰çš„æŠ˜æ‰£
function getDiscountForLevel(level) {
    const discounts = [10, 9.5, 9, 8.5, 8, 7.5, 7, 6.5, 6];
    return discounts[level] || 10;
}

// ç²å–ç­‰ç´šå°æ‡‰çš„åˆ®åˆ®æ¨‚åƒ¹æ ¼
function getScratchCardPrice(level) {
    const prices = [10, 9, 8, 7, 6, 5, 4, 3, 2];
    return prices[level] || 10;
}

// æª¢æŸ¥ä¸¦å‡ç´šVIPç­‰ç´š
function checkAndUpgradeVipLevel() {
    if (!currentUser) return;
    
    const newLevel = calculateVipLevel(currentUser.points);
    if (newLevel > (currentUser.vipLevel || 0)) {
        currentUser.vipLevel = newLevel;
        updateUserData();
        
        const levelInfo = VIP_LEVELS[newLevel];
        alert(`ğŸ‰ æ­å–œæ‚¨å‡ç´šç‚º ${levelInfo.name}ï¼\næ‚¨ç¾åœ¨å¯ä»¥äº«å—æ›´å¤šå°ˆå±¬å„ªæƒ ï¼`);
        
        // å‡ç´šçå‹µ
        const upgradeBonus = levelInfo.checkInPoints * 10;
        currentUser.points += upgradeBonus;
        alert(`ğŸ ç²å¾—å‡ç´šçå‹µ ${upgradeBonus.toLocaleString()} é»ï¼`);
    }
    
    updateVipDisplay();
}

// ================= æ¢ç¢¼åŠŸèƒ½ =================
function generateBarcode(data, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = `<svg id="barcode"></svg>`;
    JsBarcode("#barcode", data, {
        format: "CODE128",
        displayValue: true,
        fontSize: 16,
        lineColor: "#000",
        width: 2,
        height: 50
    });
}

function scanBarcode() {
    const barcode = document.getElementById('barcodeInput').value.trim();
    if (!barcode) return alert("è«‹è¼¸å…¥æ¢ç¢¼ï¼");
    document.getElementById('barcodeResult').textContent = `æƒæçµæœï¼š${barcode}`;
    document.getElementById('barcodeInput').value = '';
}

function generateHouseworkBarcode() {
    const housework = document.getElementById('houseworkInput').value.trim();
    if (!housework) return alert("è«‹è¼¸å…¥å®¶å‹™å…§å®¹ï¼");
    generateBarcode(`HOUSEWORK:${housework}`, 'barcodeContainer');
    document.getElementById('houseworkInput').value = '';
    alert("âœ… å®¶å‹™å·æ¢ç¢¼å·²ç”Ÿæˆï¼Œæ­¤å®¶å‹™å·å·²ä½œå»¢ï¼");
}

// ================= ç®¡ç†å“¡åŠŸèƒ½ =================
function addRedeemItem() {
    const itemName = document.getElementById('itemName').value.trim();
    const itemCost = parseInt(document.getElementById('itemCost').value.trim());
    if (!itemName || isNaN(itemCost)) return alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ç‰©å“åç¨±å’Œé»æ•¸ï¼");
    redeemItems[itemName] = { cost: itemCost, original: itemCost };
    generateBarcode(`ADD_ITEM:${itemName}:${itemCost}`, 'barcodeContainer');
    alert("âœ… ç‰©å“æ–°å¢æˆåŠŸï¼");
}

function deleteRedeemItem() {
    const itemName = document.getElementById('deleteItemName').value.trim();
    if (!redeemItems[itemName]) return alert("ç‰©å“ä¸å­˜åœ¨ï¼");
    delete redeemItems[itemName];
    generateBarcode(`DELETE_ITEM:${itemName}`, 'barcodeContainer');
    alert("âœ… ç‰©å“åˆªé™¤æˆåŠŸï¼");
}

function addRedeemCode() {
    const code = document.getElementById('newRedeemCode').value.trim();
    const points = parseInt(document.getElementById('redeemPoints').value.trim());
    if (!code || isNaN(points)) return alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„å…Œæ›ç¢¼å’Œé»æ•¸ï¼");
    redeemCodes.push({ code, points });
    generateBarcode(`ADD_CODE:${code}:${points}`, 'barcodeContainer');
    alert("âœ… å…Œæ›ç¢¼æ–°å¢æˆåŠŸï¼");
}

// ================= å…¶ä»–åŠŸèƒ½ =================
function vipCheckout() {
    if (cart.length === 0) return alert("è³¼ç‰©è»Šç‚ºç©ºï¼");
    generateBarcode(`CHECKOUT:${currentUser.username}:${JSON.stringify(cart)}`, 'barcodeContainer');
    cart = [];
    alert("âœ… çµå¸³æˆåŠŸï¼è«‹å‡ºç¤ºæ¢ç¢¼ä¾›ç®¡ç†å“¡æƒæã€‚");
}

// ================= é€šç”¨åŠŸèƒ½ =================
function toggleVisibility(elementId, show) {
    document.getElementById(elementId).classList.toggle('hidden', !show);
}

function updateUserData() {
    registeredUsers[currentUser.username] = currentUser;
    localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
}

// ================= ç™»éŒ„é¸æ“‡åŠŸèƒ½ =================
function showLoginForm(type) {
    toggleVisibility('loginOptionContainer', false);
    if (type === 'vip') {
        toggleVisibility('vipLoginContainer', true);
    } else if (type === 'normal') {
        toggleVisibility('normalLoginContainer', true);
    } else if (type === 'admin') {
        toggleVisibility('adminLoginContainer', true);
    }
}

function backToLoginOptions() {
    toggleVisibility('vipLoginContainer', false);
    toggleVisibility('normalLoginContainer', false);
    toggleVisibility('adminLoginContainer', false);
    toggleVisibility('registerContainer', false);
    toggleVisibility('loginOptionContainer', true);
}

// ================= VIP ç™»éŒ„åŠŸèƒ½ =================
function vipLogin() {
    const username = document.getElementById('vipUsername').value.trim();
    const password = document.getElementById('vipPassword').value.trim();
    if(registeredUsers[username] && registeredUsers[username].password === password && (registeredUsers[username].vipLevel > 0 || registeredUsers[username].isAdmin)) {
        currentUser = { username, ...registeredUsers[username] };
        toggleVisibility('vipLoginContainer', false);
        toggleVisibility('vipContainer', true);
        updateVipDisplay();
        displayRedeemItems();
    } else {
        alert("VIP å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ï¼");
    }
}

// ================= æ™®é€šå®¢æˆ¶ç™»éŒ„åŠŸèƒ½ =================
function normalLogin() {
    const username = document.getElementById('normalUsername').value.trim();
    const password = document.getElementById('normalPassword').value.trim();
    if(registeredUsers[username] && registeredUsers[username].password === password) {
        currentUser = { username, ...registeredUsers[username] };
        toggleVisibility('normalLoginContainer', false);
        toggleVisibility('customerContainer', true);
        checkAndUpgradeVipLevel();
        displayRedeemItems();
    } else {
        alert("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ï¼");
    }
}

// ================= ç®¡ç†å“¡ç™»éŒ„åŠŸèƒ½ =================
function adminLogin() {
    const username = document.getElementById('adminUsername').value.trim();
    const password = document.getElementById('adminPassword').value.trim();
    if(registeredUsers[username] && registeredUsers[username].password === password && registeredUsers[username].isAdmin) {
        currentUser = { username, ...registeredUsers[username] };
        toggleVisibility('adminLoginContainer', false);
        toggleVisibility('adminContainer', true);
        document.getElementById('adminContainer').querySelector('h2').textContent = 
            `ğŸ‰ ç®¡ç†å“¡ ${currentUser.username}ï¼Œæ­¡è¿ç™»å…¥ï¼`;
    } else {
        alert("ç®¡ç†å“¡å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ï¼");
    }
}

// ================= è¨»å†ŠåŠŸèƒ½ =================
function register() {
    const username = document.getElementById('newUsername').value.trim();
    const password = document.getElementById('newPassword').value.trim();
    if (!username || !password) return alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ç”¨æˆ¶åå’Œå¯†ç¢¼ï¼");
    if (registeredUsers[username]) return alert("ç”¨æˆ¶åå·²å­˜åœ¨ï¼");
    registeredUsers[username] = { password, points: 0, vipLevel: 0 };
    localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
    alert="âœ… è¨»å†ŠæˆåŠŸï¼";
    toggleVisibility('registerContainer', false);
    toggleVisibility('loginOptionContainer', true);
}

// ================= æ›´æ”¹å¯†ç¢¼åŠŸèƒ½ =================
function changePassword() {
    const oldPassword = document.getElementById('oldPassword').value.trim();
    const newPassword = document.getElementById('newPassword'). value.trim();
    if (!oldPassword || !newPassword) return alert("è«‹è¼¸å…¥èˆŠå¯†ç¢¼å’Œæ–°å¯†ç¢¼ï¼");
    if (currentUser.password !== oldPassword) return alert("èˆŠå¯†ç¢¼éŒ¯èª¤ï¼");
    currentUser.password = newPassword;
    updateUserData();
    alert="âœ… å¯†ç¢¼æ›´æ”¹æˆåŠŸï¼";
    toggleVisibility('changePasswordContainer', false);
}

// ================= é¡¯ç¤ºå¯å…Œæ›ç‰©å“ =================
function displayRedeemItems() {
    const container = document.getElementById('redeemItemsContainer');
    container.innerHTML = '';
    for (const [item, details] of Object.entries(redeemItems)) {
        if (currentUser.vipLevel > 0 || !details.isVIP) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'cart-item';
            itemDiv.innerHTML = `
                <strong>${item}</strong> - ${details.cost} é»
                <button onclick="addToCart('${item}')">åŠ å…¥è³¼ç‰©è»Š</button>
            `;
            container.appendChild(itemDiv);
        }
    }
}

// ================= è³¼ç‰©è»ŠåŠŸèƒ½ =================
function addToCart(item) {
    if (!redeemItems[item]) return alert("ç‰©å“ä¸å­˜åœ¨ï¼");
    cart.push(item);
    const cartContainer = document.getElementById('cartContainer');
    const itemDiv = document.createElement('div');
    itemDiv.className = 'cart-item';
    itemDiv.innerHTML = `
        <strong>${item}</strong> - ${redeemItems[item].cost} é»
        <button onclick="removeFromCart('${item}')">ç§»é™¤</button>
    `;
    cartContainer.appendChild(itemDiv);
}

function removeFromCart(item) {
    cart = cart.filter(i => i !== item);
    const cartContainer = document.getElementById('cartContainer');
    cartContainer.innerHTML = '';
    cart.forEach(i => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'cart-item';
        itemDiv.innerHTML = `
            <strong>${i}</strong> - ${redeemItems[i].cost} é»
            <button onclick="removeFromCart('${i}')">ç§»é™¤</button>
        `;
        cartContainer.appendChild(itemDiv);
    });
}

// ================= ç°½åˆ°åŠŸèƒ½ =================
function vipCheckIn() {
    if (currentUser.lastCheckIn === new Date().toDateString()) return alert("ä»Šæ—¥å·²ç°½åˆ°ï¼");
    const level = currentUser.vipLevel || 0;
    const pointsToAdd = VIP_LEVELS[level].checkInPoints;
    currentUser.points += pointsToAdd;
    currentUser.lastCheckIn = new Date().toDateString();
    updateUserData();
    checkAndUpgradeVipLevel();
    alert="âœ… ç°½åˆ°æˆåŠŸï¼Œç²å¾— ${pointsToAdd.toLocaleString()} é»ï¼";
}

function checkIn() {
    if (currentUser.lastCheckIn === new Date().toDateString()) return alert("ä»Šæ—¥å·²ç°½åˆ°ï¼");
    const level = currentUser.vipLevel || 0;
    const pointsToAdd = VIP_LEVELS[level].checkInPoints;
    currentUser.points += pointsToAdd;
    currentUser.lastCheckIn = new Date().toDateString();
    updateUserData();
    checkAndUpgradeVipLevel();
    alert="âœ… ç°½åˆ°æˆåŠŸï¼Œç²å¾— ${pointsToAdd.toLocaleString()} é»ï¼";
}

// ================= æŸ¥çœ‹é»æ•¸ =================
function viewPoints() {
    const level = currentUser.vipLevel || 0;
    const levelInfo = VIP_LEVELS[level];
    const nextLevelInfo = VIP_LEVELS[level + 1] || { nextLevelPoints: "å·²é”æœ€é«˜ç­‰ç´š" };
    
    alert="æ‚¨ç›®å‰çš„é»æ•¸ç‚ºï¼š${currentUser.points.toLocaleString()} é»\n
VIP ç­‰ç´š: ${levelInfo.name} (ç­‰ç´š ${level})\n
${level < 8 ? `ä¸‹ä¸€ç­‰ç´šéœ€è¦: ${levelInfo.nextLevelPoints.toLocaleString()} é»` : 'å·²é”æœ€é«˜ç­‰ç´š'}\n
é‚„å·® ${(levelInfo.nextLevelPoints - currentUser.points).toLocaleString()} é»";
}

// ================= åˆ®åˆ®æ¨‚åŠŸèƒ½ =================
function vipBuyScratchCard() {
    const level = currentUser.vipLevel || 0;
    const price = getScratchCardPrice(level);
    if (currentUser.points < price) return alert("é»æ•¸ä¸è¶³ï¼");
    currentUser.points -= price;
    updateUserData();
    const reward = Math.floor(Math.random() * (VIP_LEVELS[level].checkInPoints * 10));
    currentUser.points += reward;
    document.getElementById('scratchResult').textContent = `æ­å–œä¸­çï¼ç²å¾— ${reward.toLocaleString()} é»ï¼`;
    checkAndUpgradeVipLevel();
}

function buyScratchCard() {
    const level = currentUser.vipLevel || 0;
    const price = getScratchCardPrice(level);
    if (currentUser.points < price) return alert("é»æ•¸ä¸è¶³ï¼");
    currentUser.points -= price;
    updateUserData();
    const reward = Math.floor(Math.random() * (VIP_LEVELS[level].checkInPoints * 10));
    currentUser.points += reward;
    document.getElementById('scratchResult').textContent = `æ­å–œä¸­çï¼ç²å¾— ${reward.toLocaleString()} é»ï¼`;
    checkAndUpgradeVipLevel();
}

// ================= å…Œæ›ç¢¼åŠŸèƒ½ =================
function redeemWithCode() {
    const code = document.getElementById('redeemCode').value.trim();
    const redeem = redeemCodes.find(r => r.code === code);
    if (!redeem) return alert("ç„¡æ•ˆçš„å…Œæ›ç¢¼ï¼");
    currentUser.points += redeem.points;
    updateUserData();
    checkAndUpgradeVipLevel();
    alert="âœ… å…Œæ›æˆåŠŸï¼Œç²å¾— ${redeem.points} é»ï¼";
    document.getElementById('redeemCode').value = '';
}

// ================= æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ¶ =================
function viewUsers() {
    let userList = "æ‰€æœ‰ç”¨æˆ¶ï¼š\n";
    for (const [username, details] of Object.entries(registeredUsers)) {
        const level = details.vipLevel || 0;
        userList += `${username} - é»æ•¸ï¼š${details.points.toLocaleString()} - ç­‰ç´š: ${VIP_LEVELS[level].name}\n`;
    }
    alert=userList;
}

// åˆå§‹åŒ–æ™‚é–“é¡¯ç¤º
function updateTime() {
    const now = new Date();
    const timeString = now.toLocaleString('zh-TW');
    document.querySelectorAll('#currentTime, #adminTime').forEach(el => {
        el.textContent = timeString;
    });
    setTimeout(updateTime, 1000);
}

// é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
window.onload = function() {
    updateTime();
};
</script>
</body>
</html>
