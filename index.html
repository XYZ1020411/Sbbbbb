<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¶…ç´šVIPå®¢æˆ¶ç™»éŒ„ç³»çµ±</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            color: #333; 
            margin: 0; 
            padding: 0; 
            background-color: #FFD700;
            font-size: 18px;
        }
        .container { 
            background: rgba(255,255,255,0.9); 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); 
            margin: 20px auto; 
            padding: 20px; 
            max-width: 500px; 
        }
        h2 { text-align: center; color: #b30000; font-size: 24px; }
        h3 { font-size: 20px; }
        input, textarea, select { 
            width: 100%; 
            padding: 10px; 
            margin: 10px 0; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            font-size: 16px;
        }
        button { 
            background-color: #FFA500; 
            color: black; 
            border: none; 
            padding: 10px; 
            border-radius: 4px; 
            cursor: pointer; 
            width: 100%; 
            margin: 5px 0; 
            transition: background-color 0.3s; 
            font-size: 16px;
        }
        button:hover { background-color: #FF8C00; }
        .hidden { display: none; }
        .cart-item { background: #e6ffe6; padding: 10px; margin: 5px 0; border-radius: 4px; }
        .vip-level { 
            font-weight: bold; 
            color: #b30000; 
            margin: 10px 0; 
            text-align: center; 
            font-size: 18px; 
        }
        .progress-container {
            width: 100%;
            background-color: #ddd;
            border-radius: 5px;
            margin: 10px 0;
        }
        .progress-bar {
            height: 20px;
            background-color: #4CAF50;
            border-radius: 5px;
            text-align: center;
            line-height: 20px;
            color: white;
            transition: width 0.3s;
        }
        .level-description {
            margin: 15px 0;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
        .announcement {
            background: #fff3e0;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .announcement-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        .announcement-item:last-child {
            border-bottom: none;
        }
        .announcement-content {
            flex-grow: 1;
        }
        .announcement-date {
            color: #666;
            font-size: 0.8em;
            margin-left: 10px;
        }
        .time-display {
            text-align: center;
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        #updateStatus {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .redeem-code-container {
            margin: 10px 0;
            padding: 10px;
            background: #e6f7ff;
            border-radius: 4px;
        }
        .ai-chat-container {
            margin: 10px 0;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
        }
        .ai-message {
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
        }
        .ai-user {
            background: #e6ffe6;
            text-align: right;
        }
        .ai-bot {
            background: #e6f7ff;
            text-align: left;
        }
        .admin-controls {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        #loginError {
            color: red;
            text-align: center;
            margin: 10px 0;
        }
        .invoice-container {
            margin: 10px 0;
            padding: 10px;
            background: #fff3e0;
            border-radius: 4px;
        }
        .invoice-prize {
            color: #e53935;
            font-weight: bold;
        }
        .news-container, .weather-container {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .news-container {
            background: #f0f8ff;
        }
        .weather-container {
            background: #f0fff0;
        }
        .usage-code-container {
            margin: 10px 0;
            padding: 10px;
            background: #e6f7ff;
            border-radius: 4px;
        }
        .usage-code-item {
            padding: 10px;
            margin: 5px 0;
            background: #f5f5f5;
            border-radius: 4px;
        }
        .new-features-container {
            margin: 10px 0;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
        }
        .new-features-container h3 {
            margin-top: 0;
            color: #b30000;
        }
        .new-features-container button {
            margin: 5px;
            width: calc(50% - 10px);
            display: inline-block;
        }
    </style>
</head>
<body>
    <!-- ç™»å½•é€‰é¡¹é€‰æ‹©ç•Œé¢ -->
    <div class="container" id="loginOptionContainer">
        <h2>è¯·é€‰æ‹©ç™»å½•ç±»å‹</h2>
        <button id="vipLoginBtn">VIP ä¼šå‘˜ç™»å½•</button>
        <button id="normalLoginBtn">æ™®é€šå®¢æˆ·ç™»å½•</button>
        <button id="adminLoginBtn">ç®¡ç†å‘˜ç™»å½•</button>
    </div>

    <!-- VIP ç™»å½•ç•Œé¢ -->
    <div class="container hidden" id="vipLoginContainer">
        <h2>VIP ä¼šå‘˜ç™»å½•</h2>
        <input type="text" id="vipUsername" placeholder="VIP å¸å·">
        <input type="password" id="vipPassword" placeholder="VIP å¯†ç ">
        <button id="vipLoginSubmit">VIP ç™»å½•</button>
        <button id="vipBackBtn">è¿”å›</button>
    </div>

    <!-- æ™®é€šå®¢æˆ·ç™»å½•ç•Œé¢ -->
    <div class="container hidden" id="normalLoginContainer">
        <h2>æ™®é€šå®¢æˆ·ç™»å½•</h2>
        <input type="text" id="normalUsername" placeholder="ç”¨æˆ·å">
        <input type="password" id="normalPassword" placeholder="å¯†ç ">
        <div id="loginError"></div>
        <button id="normalLoginSubmit">ç™»å½•</button>
        <button id="normalRegisterBtn">æ³¨å†Œæ–°å¸å·</button>
        <button id="normalBackBtn">è¿”å›</button>
    </div>

    <!-- ç®¡ç†å‘˜ç™»å½•ç•Œé¢ -->
    <div class="container hidden" id="adminLoginContainer">
        <h2>ç®¡ç†å‘˜ç™»å½•</h2>
        <input type="text" id="adminUsername" placeholder="ç®¡ç†å‘˜å¸å·">
        <input type="password" id="adminPassword" placeholder="ç®¡ç†å‘˜å¯†ç ">
        <button id="adminLoginSubmit">ç®¡ç†å‘˜ç™»å½•</button>
        <button id="adminBackBtn">è¿”å›</button>
    </div>

    <!-- æ³¨å†Œç•Œé¢ -->
    <div class="container hidden" id="registerContainer">
        <h2>æ³¨å†Œæ–°å¸å·</h2>
        <input type="text" id="newUsername" placeholder="ç”¨æˆ·å">
        <input type="password" id="newPassword" placeholder="å¯†ç ">
        <input type="email" id="newEmail" placeholder="ç”µå­é‚®ä»¶">
        <button id="registerSubmit">æ³¨å†Œ</button>
        <button id="registerBackBtn">è¿”å›</button>
    </div>

    <!-- VIP åŠŸèƒ½ç•Œé¢ -->
    <div class="container hidden" id="vipContainer">
        <h2 id="vipTitle">VIP ä¼šå‘˜æ‚¨å¥½ï¼</h2>
        <div id="userAnnouncement" class="announcement">
            <h3>æœ€æ–°å…¬å‘Š</h3>
            <div id="announcementsList"></div>
        </div>
        <div class="time-display" id="userTime"></div>
        
        <!-- æ–°é—»å’Œå¤©æ°”æŒ‰é’® -->
        <div class="new-features-container">
            <h3>ä¿¡æ¯æœåŠ¡</h3>
            <button id="viewNewsBtn">æŸ¥çœ‹æ–°é—»</button>
            <button id="viewWeatherBtn">æŸ¥çœ‹å¤©æ°”</button>
        </div>
        
        <div class="vip-level" id="vipLevelDisplay"></div>
        <div class="progress-container">
            <div id="pointsProgress" class="progress-bar"></div>
        </div>
        
        <div class="level-description" id="levelDescription"></div>
        
        <button id="checkInBtn">æ¯æ—¥ç­¾åˆ°</button>
        <button id="viewLevelsBtn">æŸ¥çœ‹VIPç­‰çº§</button>
        <button id="redeemItemsBtn">å…‘æ¢å•†å“</button>
        <button id="scratchCardBtn">VIPåˆ®åˆ®ä¹</button>
        <button id="changePasswordBtn">æ›´æ”¹å¯†ç </button>
        <button id="redeemCodeBtn">è¾“å…¥å…‘æ¢ç </button>
        <button id="aiChatBtn">AIå®¢æœ</button>
        <button id="checkUpdatesBtn">æ£€æŸ¥æ›´æ–°</button>
        <button id="viewReceiptsBtn">æŸ¥çœ‹æ”¶ä»¶</button>
        <button id="viewInvoicesBtn">æŸ¥çœ‹å‘ç¥¨</button>
        <div id="updateStatus"></div>
        
        <!-- æ–°å¢åŠŸèƒ½åŒºåŸŸ -->
        <div class="new-features-container">
            <h3>é«˜çº§åŠŸèƒ½</h3>
            <button id="dailyBonusBtn">æ¯æ—¥é¢å¤–å¥–åŠ±</button>
            <button id="pointTransferBtn">ç‚¹æ•°è½¬è´¦</button>
            <button id="vipGiftBtn">VIPä¸“å±ç¤¼ç‰©</button>
        </div>
        
        <button id="logoutBtn">ç™»å‡º</button>
    </div>

    <!-- å…‘æ¢å•†å“ç•Œé¢ -->
    <div class="container hidden" id="redeemContainer">
        <h2>å…‘æ¢å•†å“</h2>
        <div id="redeemItemsList"></div>
        <h3>æˆ‘çš„è´­ç‰©è½¦</h3>
        <div id="cartItems"></div>
        <button id="checkoutBtn">ç»“å¸</button>
        <button id="redeemBackBtn">è¿”å›</button>
    </div>

    <!-- åˆ®åˆ®ä¹ç•Œé¢ -->
    <div class="container hidden" id="scratchCardContainer">
        <h2>VIPåˆ®åˆ®ä¹</h2>
        <div id="scratchCard">
            <p>åˆ®åˆ®ä¹æ¸¸æˆï¼Œæœ‰æœºä¼šèµ¢å¾—å¤§å¥–ï¼</p>
            <button id="playScratchBtn">è´­ä¹°åˆ®åˆ®ä¹ (<span id="scratchCardPrice">10</span> ç‚¹)</button>
            <div id="scratchResult"></div>
        </div>
        <button id="scratchBackBtn">è¿”å›</button>
    </div>

    <!-- æ›´æ”¹å¯†ç ç•Œé¢ -->
    <div class="container hidden" id="changePasswordContainer">
        <h2>æ›´æ”¹å¯†ç </h2>
        <input type="password" id="oldPassword" placeholder="æ—§å¯†ç ">
        <input type="password" id="newPassword" placeholder="æ–°å¯†ç ">
        <input type="password" id="confirmPassword" placeholder="ç¡®è®¤æ–°å¯†ç ">
        <button id="changePasswordSubmit">æ›´æ”¹å¯†ç </button>
        <button id="changePasswordBackBtn">è¿”å›</button>
    </div>

    <!-- æ‰€æœ‰VIPç­‰çº§æ˜¾ç¤º -->
    <div class="container hidden" id="allLevelsContainer">
        <h2>VIPç­‰çº§ç³»ç»Ÿ</h2>
        <div id="levelsList"></div>
        <button id="levelsBackBtn">è¿”å›</button>
    </div>

    <!-- å…¬å‘Šç®¡ç†ç•Œé¢ (ä»…ç®¡ç†å‘˜å¯è§) -->
    <div class="container hidden" id="announcementManagementContainer">
        <h2>å…¬å‘Šç®¡ç†</h2>
        <div id="announcementListForManagement"></div>
        <h3>æ–°å¢å…¬å‘Š</h3>
        <textarea id="newAnnouncementContent" placeholder="è¾“å…¥å…¬å‘Šå†…å®¹" rows="3"></textarea>
        <button id="addAnnouncementBtn">å‘å¸ƒå…¬å‘Š</button>
        <button id="announcementBackBtn">è¿”å›</button>
    </div>

    <!-- å…‘æ¢ç ç•Œé¢ -->
    <div class="container hidden" id="redeemCodeContainer">
        <h2>è¾“å…¥å…‘æ¢ç </h2>
        <input type="text" id="redeemCodeInput" placeholder="è¾“å…¥å…‘æ¢ç ">
        <button id="redeemCodeSubmit">å…‘æ¢</button>
        <div id="redeemCodeResult"></div>
        <button id="redeemCodeBackBtn">è¿”å›</button>
    </div>

    <!-- AIå®¢æœç•Œé¢ -->
    <div class="container hidden" id="aiChatContainer">
        <h2>AIå®¢æœ</h2>
        <div class="ai-chat-container" id="aiChatMessages">
            <div class="ai-message ai-bot">æ‚¨å¥½ï¼æˆ‘æ˜¯AIå®¢æœï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„ï¼Ÿ</div>
        </div>
        <input type="text" id="aiUserInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜">
        <button id="sendAiMessageBtn">å‘é€</button>
        <button id="aiChatBackBtn">è¿”å›</button>
    </div>

    <!-- ç®¡ç†å‘˜å•†å“ç®¡ç†ç•Œé¢ -->
    <div class="container hidden" id="itemManagementContainer">
        <h2>å•†å“ç®¡ç†</h2>
        <div id="itemListForManagement"></div>
        <h3>æ–°å¢å•†å“</h3>
        <input type="text" id="newItemName" placeholder="å•†å“åç§°">
        <input type="number" id="newItemCost" placeholder="æ‰€éœ€ç‚¹æ•°">
        <select id="newItemVipOnly">
            <option value="false">æ‰€æœ‰ç”¨æˆ·</option>
            <option value="true">ä»…é™VIP</option>
        </select>
        <button id="addItemBtn">æ–°å¢å•†å“</button>
        <button id="itemBackBtn">è¿”å›</button>
    </div>

    <!-- ç®¡ç†å‘˜å…‘æ¢ç ç®¡ç†ç•Œé¢ -->
    <div class="container hidden" id="codeManagementContainer">
        <h2>å…‘æ¢ç ç®¡ç†</h2>
        <div id="codeListForManagement"></div>
        <h3>æ–°å¢å…‘æ¢ç </h3>
        <input type="text" id="newCodeValue" placeholder="å…‘æ¢ç ">
        <input type="number" id="newCodePoints" placeholder="ç‚¹æ•°">
        <button id="addCodeBtn">æ–°å¢å…‘æ¢ç </button>
        <button id="codeBackBtn">è¿”å›</button>
    </div>

    <!-- æ”¶ä»¶ç•Œé¢ -->
    <div class="container hidden" id="receiptContainer">
        <h2>æˆ‘çš„æ”¶ä»¶</h2>
        <div id="receiptList"></div>
        <button id="receiptBackBtn">è¿”å›</button>
    </div>

    <!-- å‘ç¥¨ç•Œé¢ -->
    <div class="container hidden" id="invoiceContainer">
        <h2>æˆ‘çš„å‘ç¥¨</h2>
        <div id="invoiceList"></div>
        <button id="invoiceBackBtn">è¿”å›</button>
    </div>

    <!-- ä½¿ç”¨ç ç•Œé¢ -->
    <div class="container hidden" id="usageCodeContainer">
        <h2>ä½¿ç”¨å•†å“</h2>
        <input type="text" id="usageCodeInput" placeholder="è¾“å…¥ä½¿ç”¨ç ">
        <button id="usageCodeSubmit">ä½¿ç”¨</button>
        <div id="usageCodeResult"></div>
        <button id="usageCodeBackBtn">è¿”å›</button>
    </div>

    <!-- ç®¡ç†å‘˜ä½¿ç”¨ç ç®¡ç†ç•Œé¢ -->
    <div class="container hidden" id="usageCodeManagementContainer">
        <h2>ä½¿ç”¨ç ç®¡ç†</h2>
        <div id="usageCodeListForManagement"></div>
        <h3>æ–°å¢ä½¿ç”¨ç </h3>
        <input type="text" id="newUsageCodeValue" placeholder="ä½¿ç”¨ç ">
        <input type="text" id="newUsageCodeItem" placeholder="å•†å“åç§°">
        <button id="addUsageCodeBtn">æ–°å¢ä½¿ç”¨ç </button>
        <button id="usageCodeManagementBackBtn">è¿”å›</button>
    </div>

    <!-- æ–°é—»ç•Œé¢ -->
    <div class="container hidden" id="newsContainer">
        <h2>æœ€æ–°æ–°é—»</h2>
        <div id="newsList"></div>
        <button id="newsBackBtn">è¿”å›</button>
    </div>

    <!-- å¤©æ°”ç•Œé¢ -->
    <div class="container hidden" id="weatherContainer">
        <h2>å¤©æ°”é¢„æŠ¥</h2>
        <div id="weatherList"></div>
        <button id="weatherBackBtn">è¿”å›</button>
    </div>

<script>
// ================= ç³»ç»Ÿé…ç½® =================
const SYSTEM_CONFIG = {
    version: "1.8.0",
    lastUpdate: "2023-11-25",
    configUrl: "http://192.168.50.1/vip_system_config.json",
    dataUrl: "http://192.168.50.1/vip_system_data.json",
    syncUrl: "http://192.168.50.1/vip_system_sync.php"
};

// API é…ç½®
const API_CONFIG = {
    newsApiKey: "pub_77914c9ab741571647f817116519227c8df64",
    weatherApiKey: "f08876bf13681726c0c84bbb5af68d3e",
    newsApiUrl: "https://newsdata.io/api/1/news?apikey=",
    weatherApiUrl: "https://api.openweathermap.org/data/2.5/forecast?q=Taipei&units=metric&lang=zh_tw&appid="
};

// å°æ¹¾èŠ‚åº†æ—¥æœŸ (æœˆä»½æ˜¯0-11)
const TAIWAN_HOLIDAYS = [
    { name: "å…ƒæ—¦", date: new Date(new Date().getFullYear(), 0, 1) },
    { name: "æ˜¥èŠ‚", date: new Date(new Date().getFullYear(), 1, 10) }, // ç¤ºä¾‹æ—¥æœŸ
    { name: "æ¸…æ˜èŠ‚", date: new Date(new Date().getFullYear(), 3, 4) },
    { name: "4/11èŠ‚åº†", date: new Date(new Date().getFullYear(), 3, 11) }, // æ–°å¢4/11èŠ‚åº†
    { name: "ç«¯åˆèŠ‚", date: new Date(new Date().getFullYear(), 5, 14) }, // ç¤ºä¾‹æ—¥æœŸ
    { name: "ä¸­ç§‹èŠ‚", date: new Date(new Date().getFullYear(), 8, 29) }, // ç¤ºä¾‹æ—¥æœŸ
    { name: "åŒåèŠ‚", date: new Date(new Date().getFullYear(), 9, 10) }
];

// å‘ç¥¨å¥–é¡¹é…ç½®
const INVOICE_PRIZES = {
    "ç‰¹åˆ«å¥–": { amount: 10000000, probability: 0.000001 },
    "ç‰¹å¥–": { amount: 2000000, probability: 0.000005 },
    "å¤´å¥–": { amount: 200000, probability: 0.00001 },
    "äºŒå¥–": { amount: 40000, probability: 0.00005 },
    "ä¸‰å¥–": { amount: 10000, probability: 0.0001 },
    "å››å¥–": { amount: 4000, probability: 0.001 },
    "äº”å¥–": { amount: 1000, probability: 0.01 },
    "å…­å¥–": { amount: 200, probability: 0.1 }
};

// ================= VIPç­‰çº§ç³»ç»Ÿ =================
// æ™®é€šç”¨æˆ·ç­‰çº§ (0-99,999ç‚¹) å…±500çº§ï¼Œæ¯çº§200ç‚¹
const NORMAL_LEVELS = [];
for (let i = 0; i < 500; i++) {
    const points = i * 200;
    let name = "";
    
    // ç‰¹æ®Šåç§°ç­‰çº§
    switch(i) {
        case 0: name = "æˆ˜åœºèœé¸Ÿ"; break;
        case 1: name = "ç»·å¸¦å®ä¹ ç”Ÿ"; break;
        case 2: name = "æ‰‹æªæ–°æ‰‹"; break;
        case 3: name = "å¼¹å£³æ”¶é›†è€…"; break;
        case 4: name = "æˆ˜æœ¯è¹²ä¼è€…"; break;
        case 5: name = "èƒ½é‡é¥®æ–™è¯•å–å‘˜"; break;
        case 6: name = "é˜²å¼¹èƒŒå¿ƒå­¦å¾’"; break;
        case 7: name = "çº¢ç‚¹é•œä½“éªŒè€…"; break;
        case 8: name = "æ€¥æ•‘åŒ…å®ä¹ ç”Ÿ"; break;
        case 9: name = "çƒŸé›¾å¼¹æŠ•æ·æ‰‹"; break;
        case 495: name = "æˆ˜æœ¯å¤§å¸ˆå€™é€‰äºº"; break;
        case 496: name = "ç©ºæŠ•è¿½è¸ªè€…"; break;
        case 497: name = "æˆ˜åœºç”Ÿå­˜ä¸“å®¶"; break;
        case 498: name = "å‡†VIPæŒ‘æˆ˜è€…"; break;
        default: name = `ç­‰çº§ ${i+1}`;
    }
    
    NORMAL_LEVELS.push({
        level: i,
        name: name,
        points: points,
        color: i < 100 ? "#000000" : 
               i < 200 ? "#2ecc71" : 
               i < 300 ? "#3498db" : 
               i < 400 ? "#9b59b6" : "#e67e22",
        emoji: i < 100 ? "ğŸ‘¤" : 
               i < 200 ? "ğŸ‘" : 
               i < 300 ? "â­" : 
               i < 400 ? "ğŸŒŸ" : "ğŸ’",
        discount: 1 - (i * 0.0002),
        scratchPrice: 20 - Math.floor(i / 25),
        checkInPoints: 100 + Math.floor(i / 5) * 10 // ç­¾åˆ°ç‚¹æ•°éšç­‰çº§æå‡
    });
}

// VIPç­‰çº§ (100,000ç‚¹èµ·) å…±100çº§ï¼Œæ¯çº§100,000ç‚¹
const VIP_LEVELS = [];
for (let i = 0; i < 100; i++) {
    const points = 100000 + (i * 100000);
    let name = "";
    let group = "";
    
    // åˆ†ç»„å’Œå‘½å
    if (i < 10) {
        group = "åŸºç¡€ç‰¹ç§å…µ";
        switch(i) {
            case 0: name = "é˜²å¼¹è¡£æ–°å…µ"; break;
            case 1: name = "ç©ºæŠ•è¿½è¸ªè€…"; break;
            case 2: name = "æ­¢è¡€å¸¦åŒ»æŠ¤å…µ"; break;
            case 3: name = "æˆ˜æœ¯å¤´ç›”ä¾¦å¯Ÿå…µ"; break;
            case 4: name = "èƒ½é‡é¥®æ–™è¡¥ç»™å®˜"; break;
            case 5: name = "å…«å€é•œç‹™å‡»å­¦å¾’"; break;
            case 6: name = "ç ´ç‰‡æ‰‹æ¦´å¼¹ä¸“å®¶"; break;
            case 7: name = "å¹³åº•é”…è¿‘æˆ˜å£«"; break;
            case 8: name = "æˆ˜æœ¯èƒŒåŒ…è¿è¾“å®˜"; break;
            case 9: name = "æ¶ˆéŸ³å™¨æ½œè¡Œå…µ"; break;
        }
    } else if (i < 20) {
        group = "è¿›é˜¶çªå‡»æ‰‹";
        switch(i) {
            case 10: name = "å¿«é€Ÿå¼¹åŒ£çªå‡»å…µ"; break;
            case 11: name = "ç‡ƒçƒ§ç“¶ç«ç„°å…µ"; break;
            case 12: name = "åŒ»ç–—ç®±æ€¥æ•‘å®˜"; break;
            case 13: name = "çº¢ç‚¹ç„å‡†çªå‡»æ‰‹"; break;
            case 14: name = "æˆ˜æœ¯æªæ‰˜å·¥ç¨‹å¸ˆ"; break;
            case 15: name = "å‚ç›´æ¡æŠŠç¨³å®šå…µ"; break;
            case 16: name = "æ‰©å®¹å¼¹åŒ£ç«åŠ›æ‰‹"; break;
            case 17: name = "æˆ˜æœ¯é´ç–¾è¡Œå…µ"; break;
            case 18: name = "æˆ˜æœ¯æ‰‹å¥—æ”€çˆ¬è€…"; break;
            case 19: name = "æˆ˜æœ¯æŠ¤è†æ½œä¼è€…"; break;
        }
    } else if (i < 30) {
        group = "ç²¾è‹±ç‹™å‡»æ‰‹";
        switch(i) {
            case 20: name = "å…­å€é•œç‹™å‡»æ‰‹"; break;
            case 21: name = "æ “ç‹™å¤§å¸ˆ"; break;
            case 22: name = "æ¶ˆç„°å™¨éšè”½è€…"; break;
            case 23: name = "æˆ˜æœ¯æ©ä½“å»ºé€ è€…"; break;
            case 24: name = "é«˜å€é•œè§‚å¯Ÿå‘˜"; break;
            case 25: name = "æˆ˜æœ¯è¶´å°„ä¸“å®¶"; break;
            case 26: name = "æˆ˜æœ¯æ¢å¼¹è¾¾äºº"; break;
            case 27: name = "æˆ˜æœ¯è…°å°„ç‹è€…"; break;
            case 28: name = "æˆ˜æœ¯é—ªèº«æªé«˜æ‰‹"; break;
            case 29: name = "æˆ˜æœ¯é¢„ç„å®—å¸ˆ"; break;
        }
    } else if (i < 40) {
        group = "ç‰¹ç§æˆ˜æœ¯ä¸“å®¶";
        switch(i) {
            case 30: name = "æˆ˜æœ¯çƒŸé›¾æ©æŠ¤å®˜"; break;
            case 31: name = "æˆ˜æœ¯é—ªå…‰çªè¢­è€…"; break;
            case 32: name = "æˆ˜æœ¯éœ‡çˆ†å¼¹ä¸“å®¶"; break;
            case 33: name = "æˆ˜æœ¯ç‡ƒçƒ§ç“¶æŒ‡æŒ¥å®˜"; break;
            case 34: name = "æˆ˜æœ¯ç ´ç‰‡æ‰‹é›·å¤§å¸ˆ"; break;
            case 35: name = "æˆ˜æœ¯æŠ•æ·ç‰©å®—å¸ˆ"; break;
            case 36: name = "æˆ˜æœ¯è¿‘æˆ˜æ ¼æ–—å®¶"; break;
            case 37: name = "æˆ˜æœ¯è½½å…·é©¾é©¶å‘˜"; break;
            case 38: name = "æˆ˜æœ¯æ‘©æ‰˜è½¦ç‰¹æŠ€æ‰‹"; break;
            case 39: name = "æˆ˜æœ¯å‰æ™®è½¦æŒ‡æŒ¥å®˜"; break;
        }
    } else if (i < 50) {
        group = "æˆ˜åœºæŒ‡æŒ¥å®˜";
        switch(i) {
            case 40: name = "æˆ˜æœ¯ç©ºæŠ•å¬å”¤å¸ˆ"; break;
            case 41: name = "æˆ˜æœ¯ä¿¡å·æªä¸“å®¶"; break;
            case 42: name = "æˆ˜æœ¯è½°ç‚¸åŒºé¢„åˆ¤è€…"; break;
            case 43: name = "æˆ˜æœ¯æ¯’åœˆè®¡ç®—å¸ˆ"; break;
            case 44: name = "æˆ˜æœ¯å†³èµ›åœˆä¸»å®°"; break;
            case 45: name = "æˆ˜æœ¯å››äººå°é˜Ÿé˜Ÿé•¿"; break;
            case 46: name = "æˆ˜æœ¯æ•‘æ´ä¸“å®¶"; break;
            case 47: name = "æˆ˜æœ¯ç«åŠ›å‹åˆ¶è€…"; break;
            case 48: name = "æˆ˜æœ¯æˆ˜åœ°å·¥ç¨‹å¸ˆ"; break;
            case 49: name = "æˆ˜æœ¯æˆ˜åœºå…ƒå¸…"; break;
        }
    } else if (i < 60) {
        group = "ä¼ å¥‡ç‰¹æˆ˜å…µ";
        switch(i) {
            case 50: name = "æˆ˜æœ¯å‰åˆ©æœçŒäºº"; break;
            case 51: name = "æˆ˜æœ¯æ½œè¡Œæš—æ€è€…"; break;
            case 52: name = "æˆ˜æœ¯å¤œè§†ä»ªç‰¹å·¥"; break;
            case 53: name = "æˆ˜æœ¯å…¨è‡ªåŠ¨æ‰«å°„æ‰‹"; break;
            case 54: name = "æˆ˜æœ¯å•å‘ç‹™å‡»ç‹è€…"; break;
            case 55: name = "æˆ˜æœ¯éœ°å¼¹æªè¿‘æˆ˜ç¥"; break;
            case 56: name = "æˆ˜æœ¯å†²é”‹æªé€Ÿå°„ç‹"; break;
            case 57: name = "æˆ˜æœ¯è½»æœºæªç«åŠ›ç‹"; break;
            case 58: name = "æˆ˜æœ¯åå­—å¼©æš—æ€è€…"; break;
            case 59: name = "æˆ˜æœ¯å…¨èƒ½æ­¦å™¨å¤§å¸ˆ"; break;
        }
    } else if (i < 70) {
        group = "æˆ˜åœºä¼ å¥‡";
        switch(i) {
            case 60: name = "æˆ˜æœ¯ç»åœ°æ±‚ç”Ÿè€…"; break;
            case 61: name = "æˆ˜æœ¯åƒé¸¡ç‹è€…"; break;
            case 62: name = "æˆ˜æœ¯ä¸æ­»æˆ˜ç¥"; break;
            case 63: name = "æˆ˜æœ¯é›¶ä¼¤é€šå…³è€…"; break;
            case 64: name = "æˆ˜æœ¯å•äººå››æ’å† å†›"; break;
            case 65: name = "æˆ˜æœ¯å…¨å›¾è¿½æ€è€…"; break;
            case 66: name = "æˆ˜æœ¯æ— ä¼¤ç­é˜Ÿç‹"; break;
            case 67: name = "æˆ˜æœ¯ç»ˆæç”Ÿå­˜è€…"; break;
            case 68: name = "æˆ˜æœ¯ä¸è´¥ä¼ è¯´"; break;
            case 69: name = "æˆ˜æœ¯ç»åœ°ä¹‹ç¥"; break;
        }
    } else if (i < 80) {
        group = "è‡³å°Šæˆ˜ç¥";
        switch(i) {
            case 70: name = "æˆ˜æœ¯æˆ˜åœºä¸»å®°è€…"; break;
            case 71: name = "æˆ˜æœ¯æ€æˆ®æœºå™¨"; break;
            case 72: name = "æˆ˜æœ¯æ— æ•Œå…µç‹"; break;
            case 73: name = "æˆ˜æœ¯ç»ˆæçŒæ‰‹"; break;
            case 74: name = "æˆ˜æœ¯æˆ˜äº‰é¢†ä¸»"; break;
            case 75: name = "æˆ˜æœ¯æ¯ç­è€…"; break;
            case 76: name = "æˆ˜æœ¯æ­»ç¥"; break;
            case 77: name = "æˆ˜æœ¯ä¿®ç½—"; break;
            case 78: name = "æˆ˜æœ¯ç­ä¸–è€…"; break;
            case 79: name = "æˆ˜æœ¯ç»ˆææˆ˜ç¥"; break;
        }
    } else if (i < 90) {
        group = "ç¥è¯çº§ç‰¹ç§å…µ";
        switch(i) {
            case 80: name = "æˆ˜æœ¯å¤©é€‰ä¹‹äºº"; break;
            case 81: name = "æˆ˜æœ¯å¤©å‘½ä¹‹å­"; break;
            case 82: name = "æˆ˜æœ¯ä¸ç­æˆ˜é­‚"; break;
            case 83: name = "æˆ˜æœ¯ä¼ å¥‡å…µç‹"; break;
            case 84: name = "æˆ˜æœ¯ç¥çº§æŒ‡æŒ¥å®˜"; break;
            case 85: name = "æˆ˜æœ¯ä¸æœ½æˆ˜ç¥"; break;
            case 86: name = "æˆ˜æœ¯ç»ˆæå…µçš‡"; break;
            case 87: name = "æˆ˜æœ¯å¼‘ç¥è€…"; break;
            case 88: name = "æˆ˜æœ¯ç­ä¸–æˆ˜ç¥"; break;
            case 89: name = "æˆ˜æœ¯ç»åœ°è‡³å°Š"; break;
        }
    } else {
        group = "ç»ˆæç¥è¯";
        switch(i) {
            case 90: name = "æˆ˜æœ¯ä¸‡äººæ•Œ"; break;
            case 91: name = "æˆ˜æœ¯ä¸è´¥ç¥è¯"; break;
            case 92: name = "æˆ˜æœ¯å¼‘å¤©æˆ˜ç¥"; break;
            case 93: name = "æˆ˜æœ¯ç­ä¸–ä¹‹ç¥"; break;
            case 94: name = "æˆ˜æœ¯ç»ˆææ€æˆ®è€…"; break;
            case 95: name = "æˆ˜æœ¯æ— ä¸Šå…µä¸»"; break;
            case 96: name = "æˆ˜æœ¯ç»åœ°å¸ç‹"; break;
            case 97: name = "æˆ˜æœ¯ä¿®ç½—æˆ˜ç¥"; break;
            case 98: name = "æˆ˜æœ¯ç­ç•Œä¸»å®°"; break;
            case 99: name = "æˆ˜æœ¯ç»ˆæè‡³å°Šç¥"; break;
        }
    }
    
    VIP_LEVELS.push({
        level: i + 500, // ä»500å¼€å§‹
        name: `VIP ${i+1} ${name}`,
        points: points,
        color: i < 10 ? "#cd7f32" : // é“œ
               i < 20 ? "#c0c0c0" : // é“¶
               i < 30 ? "#ffd700" : // é‡‘
               i < 40 ? "#e5e4e2" : // ç™½é‡‘
               i < 50 ? "#b9f2ff" : // é’»çŸ³
               i < 60 ? "#000000" : // é»‘é‡‘
               i < 70 ? "#ff0000" : // çº¢
               i < 80 ? "#0000ff" : // è“
               i < 90 ? "#800080" : // ç´«
                        "#000000", // é»‘
        emoji: i < 10 ? "ğŸ¥‰" : 
               i < 20 ? "ğŸ¥ˆ" : 
               i < 30 ? "ğŸ¥‡" : 
               i < 40 ? "ğŸ’ " : 
               i < 50 ? "ğŸ’" : 
               i < 60 ? "â™ ï¸" : 
               i < 70 ? "â¤ï¸" : 
               i < 80 ? "ğŸ”µ" : 
               i < 90 ? "ğŸŸ£" : 
                        "âš«",
        discount: 0.8 - (i * 0.002),
        scratchPrice: 10 - Math.floor(i / 10),
        group: group,
        checkInPoints: 500 + (i * 50) // VIPç­¾åˆ°ç‚¹æ•°æ›´é«˜ä¸”éšç­‰çº§æå‡
    });
}

// åˆå¹¶æ‰€æœ‰ç­‰çº§
const ALL_LEVELS = [...NORMAL_LEVELS, ...VIP_LEVELS];

// å¯å…‘æ¢å•†å“ (åˆå§‹æ•°æ®)
let REDEEM_ITEMS = [
    { id: 1, name: "å’–å•¡åˆ¸", cost: 50, vipOnly: false },
    { id: 2, name: "åˆé¤åˆ¸", cost: 100, vipOnly: false },
    { id: 3, name: "ç”µå½±ç¥¨", cost: 200, vipOnly: false },
    { id: 4, name: "VIPä¸“å±ç¤¼ç›’", cost: 500, vipOnly: true },
    { id: 5, name: "é«˜çº§é¤å…åˆ¸", cost: 1000, vipOnly: true },
    { id: 6, name: "VIPå®¶åŠ¡åˆ¸", cost: 800, vipOnly: true }
];

// å…‘æ¢ç  (åˆå§‹æ•°æ®)
let REDEEM_CODES = [
    { code: "WELCOME100", points: 100, usedBy: [] },
    { code: "VIP500", points: 500, usedBy: [], vipOnly: true }
];

// ä½¿ç”¨ç  (åˆå§‹æ•°æ®)
let USAGE_CODES = [
    { code: "USE12345", item: "å’–å•¡åˆ¸", used: false, usedBy: null, usedAt: null },
    { code: "USE67890", item: "åˆé¤åˆ¸", used: false, usedBy: null, usedAt: null }
];

// ç”¨æˆ·æ•°æ®
let users = JSON.parse(localStorage.getItem('vipSystemUsers')) || {
    "vip8888": { password: "vip8888", email: "vip8888@vip.com", points: Infinity, vipLevel: 1, lastCheckIn: null },
    "001": { password: "001", email: "001@example.com", points: Infinity, vipLevel: 0, lastCheckIn: null },
    "002": { password: "002", email: "admin@example.com", points: 0, isAdmin: true },
    "test1": { password: "123", email: "test1@example.com", points: 5000, vipLevel: 0, lastCheckIn: null },
    "test2": { password: "123", email: "test2@example.com", points: 15000, vipLevel: 1, lastCheckIn: null },
    "test3": { password: "123", email: "test3@example.com", points: 50000, vipLevel: 3, lastCheckIn: null },
    "test4": { password: "123", email: "test4@example.com", points: 150000, vipLevel: 6, lastCheckIn: null },
    "test5": { password: "123", email: "test5@example.com", points: 500000, vipLevel: 9, lastCheckIn: null }
};

// å…¬å‘Šæ•°æ®
let announcements = JSON.parse(localStorage.getItem('vipSystemAnnouncements')) || [
    { id: 1, content: "æ¬¢è¿ä½¿ç”¨VIPç³»ç»Ÿï¼", date: "2023-11-01T10:00:00" },
    { id: 2, content: "ç³»ç»Ÿå°†äºæ¯å‘¨ä¸‰è¿›è¡Œä¾‹è¡Œç»´æŠ¤", date: "2023-11-15T14:30:00" }
];

let currentUser = null;
let cart = [];
let aiChatHistory = [];
let lastCompensationTime = null;

// ================= æ–°é—»åŠŸèƒ½ =================
function fetchNews() {
    const url = `${API_CONFIG.newsApiUrl}${API_CONFIG.newsApiKey}&country=tw&language=zh`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.results && data.results.length > 0) {
                displayNews(data.results.slice(0, 5)); // åªæ˜¾ç¤ºå‰5æ¡æ–°é—»
            } else {
                document.getElementById('newsList').innerHTML = "<p>æš‚æ— æœ€æ–°æ–°é—»</p>";
            }
        })
        .catch(error => {
            console.error("è·å–æ–°é—»å¤±è´¥:", error);
            document.getElementById('newsList').innerHTML = "<p>æ— æ³•åŠ è½½æ–°é—»</p>";
        });
}

function displayNews(newsItems) {
    const newsList = document.getElementById('newsList');
    newsList.innerHTML = '';
    
    newsItems.forEach(news => {
        const newsItem = document.createElement('div');
        newsItem.className = 'announcement-item';
        
        const title = news.title || "æ— æ ‡é¢˜";
        const source = news.source_id || "æœªçŸ¥æ¥æº";
        const link = news.link ? `<a href="${news.link}" target="_blank">é˜…è¯»æ›´å¤š</a>` : "";
        const image = news.image_url ? `<img src="${news.image_url}" style="max-width:100%; margin-top:5px;">` : "";
        
        newsItem.innerHTML = `
            <div class="news-title">${title}</div>
            <div class="news-source">æ¥æº: ${source}</div>
            ${image}
            <div style="margin-top:5px;">${link}</div>
        `;
        
        newsList.appendChild(newsItem);
    });
}

// ================= å¤©æ°”åŠŸèƒ½ =================
function fetchWeather() {
    const url = `${API_CONFIG.weatherApiUrl}${API_CONFIG.weatherApiKey}`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.list && data.list.length > 0) {
                displayWeather(data.list);
            } else {
                document.getElementById('weatherList').innerHTML = "<p>æš‚æ— å¤©æ°”é¢„æŠ¥</p>";
            }
        })
        .catch(error => {
            console.error("è·å–å¤©æ°”å¤±è´¥:", error);
            document.getElementById('weatherList').innerHTML = "<p>æ— æ³•åŠ è½½å¤©æ°”é¢„æŠ¥</p>";
        });
}

function displayWeather(weatherData) {
    const weatherList = document.getElementById('weatherList');
    weatherList.innerHTML = '';
    
    // åªæ˜¾ç¤ºä»Šå¤©å’Œæœªæ¥3å¤©çš„é¢„æŠ¥
    const today = new Date();
    const forecastDays = [];
    
    for (let i = 0; i < 4; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() + i);
        forecastDays.push(date.toDateString());
    }
    
    // è¿‡æ»¤å‡ºæ¯å¤©ä¸­åˆçš„å¤©æ°”æ•°æ®
    const dailyForecasts = {};
    
    weatherData.forEach(item => {
        const date = new Date(item.dt * 1000).toDateString();
        const time = new Date(item.dt * 1000).getHours();
        
        if (forecastDays.includes(date) && time >= 11 && time <= 13) {
            dailyForecasts[date] = item;
        }
    });
    
    // æ˜¾ç¤ºå¤©æ°”é¢„æŠ¥
    forecastDays.forEach(date => {
        if (dailyForecasts[date]) {
            const forecast = dailyForecasts[date];
            const weatherItem = document.createElement('div');
            weatherItem.className = 'announcement-item';
            
            const dateStr = new Date(date).toLocaleDateString('zh-TW', { 
                month: 'short', 
                day: 'numeric', 
                weekday: 'short' 
            });
            
            const temp = Math.round(forecast.main.temp);
            const description = forecast.weather[0].description;
            const icon = `https://openweathermap.org/img/wn/${forecast.weather[0].icon}@2x.png`;
            
            weatherItem.innerHTML = `
                <div class="weather-date">${dateStr}</div>
                <div><img src="${icon}" alt="${description}"></div>
                <div class="weather-temp">${temp}Â°C</div>
                <div class="weather-desc">${description}</div>
            `;
            
            weatherList.appendChild(weatherItem);
        }
    });
}

// ================= å‘ç¥¨åŠŸèƒ½ =================
function generateInvoiceNumber() {
    // äº§ç”Ÿéšæœºå‘ç¥¨å·ç  (æ ¼å¼: 2ä½è‹±æ–‡å­—æ¯ + 8ä½æ•°å­—)
    const letters = 'ABCDEFGHJKLMNPQRSTUVXYWZ';
    const letter1 = letters[Math.floor(Math.random() * letters.length)];
    const letter2 = letters[Math.floor(Math.random() * letters.length)];
    const numbers = Math.floor(10000000 + Math.random() * 90000000);
    return `${letter1}${letter2}${numbers}`;
}

function checkInvoicePrize(invoiceNumber) {
    // æ£€æŸ¥æ˜¯å¦ä¸ºä¸­å¥–å‘ç¥¨ (æ¨¡æ‹Ÿ)
    const random = Math.random();
    let prize = null;
    
    for (const [name, config] of Object.entries(INVOICE_PRIZES)) {
        if (random < config.probability) {
            prize = { name, amount: config.amount };
            break;
        }
    }
    
    return prize;
}

function checkAllInvoices() {
    // æ£€æŸ¥ä»Šå¤©æ˜¯å¦æ˜¯å¥‡æ•°æœˆçš„25å·
    const today = new Date();
    const month = today.getMonth() + 1; // æœˆä»½æ˜¯0-11
    const date = today.getDate();
    
    if (month % 2 === 1 && date === 25) {
        // æ˜¯å¥‡æ•°æœˆçš„25å·ï¼Œæ‰§è¡Œè‡ªåŠ¨å…‘å¥–
        if (currentUser && currentUser.invoices) {
            let totalPrize = 0;
            
            currentUser.invoices.forEach(invoice => {
                if (!invoice.checked) {
                    const prize = checkInvoicePrize(invoice.number);
                    if (prize) {
                        invoice.prize = prize;
                        totalPrize += prize.amount;
                    }
                    invoice.checked = true;
                    invoice.checkDate = new Date().toISOString();
                }
            });
            
            if (totalPrize > 0) {
                currentUser.points += totalPrize;
                users[currentUser.username] = currentUser;
                localStorage.setItem('vipSystemUsers', JSON.stringify(users));
                
                addAnnouncementFromSystem(`å‘ç¥¨å…‘å¥–ç»“æœï¼šæ­å–œæ‚¨è·å¾— ${totalPrize} ç‚¹å¥–åŠ±ï¼`);
                
                // åŒæ­¥åˆ°æœåŠ¡å™¨
                syncToServer();
            }
        }
    }
}

function showInvoices() {
    document.getElementById('vipContainer').classList.add('hidden');
    document.getElementById('invoiceContainer').classList.remove('hidden');
    
    const container = document.getElementById('invoiceList');
    container.innerHTML = '';
    
    if (!currentUser.invoices || currentUser.invoices.length === 0) {
        container.innerHTML = "<p>æ²¡æœ‰å‘ç¥¨è®°å½•</p>";
        return;
    }
    
    currentUser.invoices.forEach((invoice, index) => {
        const invoiceDiv = document.createElement('div');
        invoiceDiv.className = 'invoice-container';
        
        const date = new Date(invoice.date);
        const formattedDate = date.toLocaleString('zh-TW');
        
        let prizeInfo = '';
        if (invoice.prize) {
            prizeInfo = `<p class="invoice-prize">ä¸­å¥–: ${invoice.prize.name} ${invoice.prize.amount} ç‚¹</p>`;
        } else if (invoice.checked) {
            prizeInfo = `<p>æœªä¸­å¥–</p>`;
        } else {
            prizeInfo = `<p>ç­‰å¾…å…‘å¥– (å¥‡æ•°æœˆ25å·è‡ªåŠ¨å…‘å¥–)</p>`;
        }
        
        invoiceDiv.innerHTML = `
            <h3>å‘ç¥¨ #${index + 1}</h3>
            <p>å‘ç¥¨å·ç : ${invoice.number}</p>
            <p>æ—¥æœŸ: ${formattedDate}</p>
            <p>æ¶ˆè´¹é‡‘é¢: ${invoice.amount} ç‚¹</p>
            ${prizeInfo}
        `;
        
        container.appendChild(invoiceDiv);
    });
}

// ================= ä½¿ç”¨ç åŠŸèƒ½ =================
function useCode() {
    const codeInput = document.getElementById('usageCodeInput').value.trim().toUpperCase();
    const resultDiv = document.getElementById('usageCodeResult');
    
    if (!codeInput) {
        resultDiv.innerHTML = "<p style='color:red'>è¯·è¾“å…¥ä½¿ç”¨ç </p>";
        return;
    }
    
    const usageCode = USAGE_CODES.find(c => c.code === codeInput);
    
    if (!usageCode) {
        resultDiv.innerHTML = "<p style='color:red'>ä½¿ç”¨ç æ— æ•ˆ</p>";
        return;
    }
    
    if (usageCode.used) {
        resultDiv.innerHTML = "<p style='color:red'>æ­¤ä½¿ç”¨ç å·²è¢«ä½¿ç”¨</p>";
        return;
    }
    
    // ä½¿ç”¨æˆåŠŸ
    usageCode.used = true;
    usageCode.usedBy = currentUser.username;
    usageCode.usedAt = new Date().toISOString();
    
    localStorage.setItem('vipSystemUsageCodes', JSON.stringify(USAGE_CODES));
    
    resultDiv.innerHTML = `<p style='color:green'>ä½¿ç”¨æˆåŠŸï¼å•†å“ "${usageCode.item}" å·²å…‘æ¢</p>`;
    document.getElementById('usageCodeInput').value = '';
    
    // åŒæ­¥åˆ°æœåŠ¡å™¨
    syncToServer();
}

function loadUsageCodeManagement() {
    const container = document.getElementById('usageCodeListForManagement');
    container.innerHTML = '';
    
    USAGE_CODES.forEach(code => {
        const codeDiv = document.createElement('div');
        codeDiv.className = 'usage-code-item';
        
        const usedInfo = code.used ? 
            `å·²ä½¿ç”¨ - ä½¿ç”¨è€…: ${code.usedBy} (${new Date(code.usedAt).toLocaleString()})` : 
            "æœªä½¿ç”¨";
        
        codeDiv.innerHTML = `
            <strong>${code.code}</strong> - ${code.item}<br>
            çŠ¶æ€: ${usedInfo}
            <button onclick="deleteUsageCode('${code.code}')">åˆ é™¤</button>
        `;
        container.appendChild(codeDiv);
    });
}

function addUsageCode() {
    const codeValue = document.getElementById('newUsageCodeValue').value.trim().toUpperCase();
    const codeItem = document.getElementById('newUsageCodeItem').value.trim();
    
    if (!codeValue || !codeItem) {
        alert("è¯·å¡«å†™å®Œæ•´çš„ä½¿ç”¨ç ä¿¡æ¯ï¼");
        return;
    }
    
    if (USAGE_CODES.some(c => c.code === codeValue)) {
        alert("æ­¤ä½¿ç”¨ç å·²å­˜åœ¨ï¼");
        return;
    }
    
    USAGE_CODES.push({
        code: codeValue,
        item: codeItem,
        used: false,
        usedBy: null,
        usedAt: null
    });
    
    localStorage.setItem('vipSystemUsageCodes', JSON.stringify(USAGE_CODES));
    
    document.getElementById('newUsageCodeValue').value = '';
    document.getElementById('newUsageCodeItem').value = '';
    loadUsageCodeManagement();
    
    // åŒæ­¥åˆ°æœåŠ¡å™¨
    syncToServer();
}

function deleteUsageCode(code) {
    if (!confirm("ç¡®å®šè¦åˆ é™¤æ­¤ä½¿ç”¨ç å—ï¼Ÿ")) return;
    
    USAGE_CODES = USAGE_CODES.filter(c => c.code !== code);
    localStorage.setItem('vipSystemUsageCodes', JSON.stringify(USAGE_CODES));
    loadUsageCodeManagement();
    
    // åŒæ­¥åˆ°æœåŠ¡å™¨
    syncToServer();
}

// ================= èŠ‚åº†å…‘æ¢ç åŠŸèƒ½ =================
function checkHolidayCodes() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // æ£€æŸ¥æœ¬åœ°å­˜å‚¨ä¸­æ˜¯å¦å·²ç»ç”Ÿæˆè¿‡ä»Šå¤©çš„èŠ‚æ—¥ç 
    const lastHolidayCheck = localStorage.getItem('lastHolidayCheck');
    if (lastHolidayCheck && new Date(lastHolidayCheck).toDateString() === today.toDateString()) {
        return; // ä»Šå¤©å·²ç»æ£€æŸ¥è¿‡äº†
    }
    
    // æ ‡è®°ä»Šå¤©å·²ç»æ£€æŸ¥è¿‡
    localStorage.setItem('lastHolidayCheck', today.toISOString());
    
    for (const holiday of TAIWAN_HOLIDAYS) {
        const holidayDate = new Date(holiday.date);
        holidayDate.setHours(0, 0, 0, 0);
        
        if (today.getTime() === holidayDate.getTime()) {
            // ç”ŸæˆèŠ‚æ—¥å…‘æ¢ç 
            const holidayCode = `HOLIDAY${holiday.name.replace(/\s+/g, '')}${Math.floor(1000 + Math.random() * 9000)}`;
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„å…‘æ¢ç 
            const existingCode = REDEEM_CODES.find(c => c.code === holidayCode);
            if (!existingCode) {
                const points = Math.floor(500 + Math.random() * 1500); // 500-2000ç‚¹
                REDEEM_CODES.push({
                    code: holidayCode,
                    points: points,
                    usedBy: [],
                    isHoliday: true,
                    holidayDate: holidayDate.toISOString() // è®°å½•èŠ‚æ—¥æ—¥æœŸ
                });
                
                // å‘å¸ƒå…¬å‘Š
                addAnnouncementFromSystem(`èŠ‚æ—¥æ´»åŠ¨ï¼š${holiday.name}æœŸé—´ï¼Œè¾“å…¥å…‘æ¢ç  ${holidayCode} å¯è·å¾— ${points} ç‚¹ï¼`);
                
                // åŒæ­¥åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('vipSystemCodes', JSON.stringify(REDEEM_CODES));
                
                // åŒæ­¥åˆ°æœåŠ¡å™¨
                syncToServer();
            }
        }
    }
}

// ================= å…¬å‘ŠåŠŸèƒ½ =================
function updateAnnouncements() {
    const announcementList = document.getElementById('announcementsList');
    announcementList.innerHTML = '';
    
    announcements.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    announcements.forEach(announcement => {
        const announcementDiv = document.createElement('div');
        announcementDiv.className = 'announcement-item';
        
        const date = new Date(announcement.date);
        const formattedDate = date.toLocaleString('zh-TW', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        announcementDiv.innerHTML = `
            <div class="announcement-content">${announcement.content}</div>
            <div class="announcement-date">${formattedDate}</div>
        `;
        announcementList.appendChild(announcementDiv);
    });
}

function loadAnnouncementManagement() {
    const container = document.getElementById('announcementListForManagement');
    container.innerHTML = '';
    
    announcements.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    announcements.forEach(announcement => {
        const announcementDiv = document.createElement('div');
        announcementDiv.className = 'announcement-item';
        
        const date = new Date(announcement.date);
        const formattedDate = date.toLocaleString('zh-TW', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        announcementDiv.innerHTML = `
            <div class="announcement-content">${announcement.content}</div>
            <div class="announcement-date">${formattedDate}</div>
            <button onclick="deleteAnnouncement(${announcement.id})">åˆ é™¤</button>
        `;
        container.appendChild(announcementDiv);
    });
}

function addAnnouncement() {
    const content = document.getElementById('newAnnouncementContent').value.trim();
    if (!content) {
        alert("è¯·è¾“å…¥å…¬å‘Šå†…å®¹ï¼");
        return;
    }
    
    const newId = announcements.length > 0 ? Math.max(...announcements.map(a => a.id)) + 1 : 1;
    const newAnnouncement = {
        id: newId,
        content: content,
        date: new Date().toISOString()
    };
    
    announcements.unshift(newAnnouncement);
    localStorage.setItem('vipSystemAnnouncements', JSON.stringify(announcements));
    
    document.getElementById('newAnnouncementContent').value = '';
    loadAnnouncementManagement();
    updateAnnouncements();
    
    // åŒæ­¥åˆ°æœåŠ¡å™¨
    syncToServer();
}

function addAnnouncementFromSystem(content) {
    const newId = announcements.length > 0 ? Math.max(...announcements.map(a => a.id)) + 1 : 1;
    const newAnnouncement = {
        id: newId,
        content: content,
        date: new Date().toISOString(),
        isSystem: true
    };
    
    announcements.unshift(newAnnouncement);
    localStorage.setItem('vipSystemAnnouncements', JSON.stringify(announcements));
    updateAnnouncements();
    
    // åŒæ­¥åˆ°æœåŠ¡å™¨
    syncToServer();
}

function deleteAnnouncement(id) {
    if (!confirm("ç¡®å®šè¦åˆ é™¤æ­¤å…¬å‘Šå—ï¼Ÿ")) return;
    
    announcements = announcements.filter(a => a.id !== id);
    localStorage.setItem('vipSystemAnnouncements', JSON.stringify(announcements));
    
    loadAnnouncementManagement();
    updateAnnouncements();
    
    // åŒæ­¥åˆ°æœåŠ¡å™¨
    syncToServer();
}

// ================= å…‘æ¢ç åŠŸèƒ½ =================
function redeemCode() {
    const codeInput = document.getElementById('redeemCodeInput').value.trim().toUpperCase();
    const resultDiv = document.getElementById('redeemCodeResult');
    
    if (!codeInput) {
        resultDiv.innerHTML = "<p style='color:red'>è¯·è¾“å…¥å…‘æ¢ç </p>";
        return;
    }
    
    const redeemCode = REDEEM_CODES.find(c => c.code === codeInput);
    
    if (!redeemCode) {
        resultDiv.innerHTML = "<p style='color:red'>å…‘æ¢ç æ— æ•ˆ</p>";
        return;
    }
    
    if (redeemCode.vipOnly && (!currentUser || currentUser.vipLevel <= 0)) {
        resultDiv.innerHTML = "<p style='color:red'>æ­¤å…‘æ¢ç ä»…é™VIPä¼šå‘˜ä½¿ç”¨</p>";
        return;
    }
    
    if (redeemCode.usedBy.includes(currentUser.username)) {
        resultDiv.innerHTML = "<p style='color:red'>æ‚¨å·²ä½¿ç”¨è¿‡æ­¤å…‘æ¢ç </p>";
        return;
    }
    
    // å…‘æ¢æˆåŠŸ
    currentUser.points += redeemCode.points;
    redeemCode.usedBy.push(currentUser.username);
    users[currentUser.username] = currentUser;
    
    localStorage.setItem('vipSystemUsers', JSON.stringify(users));
    localStorage.setItem('vipSystemCodes', JSON.stringify(REDEEM_CODES));
    
    resultDiv.innerHTML = `<p style='color:green'>å…‘æ¢æˆåŠŸï¼è·å¾— ${redeemCode.points} ç‚¹</p>`;
    document.getElementById('redeemCodeInput').value = '';
    
    updateVipDisplay();
    
    // åŒæ­¥åˆ°æœåŠ¡å™¨
    syncToServer();
}

function loadCodeManagement() {
    const container = document.getElementById('codeListForManagement');
    container.innerHTML = '';
    
    REDEEM_CODES.forEach(code => {
        const codeDiv = document.createElement('div');
        codeDiv.className = 'redeem-code-container';
        
        const usedCount = code.usedBy ? code.usedBy.length : 0;
        const isHoliday = code.isHoliday ? ' (èŠ‚åº†å…‘æ¢ç )' : '';
        
        codeDiv.innerHTML = `
            <strong>${code.code}</strong> - ${code.points} ç‚¹${isHoliday}<br>
            å·²ä½¿ç”¨: ${usedCount} æ¬¡
            <button onclick="deleteCode('${code.code}')">åˆ é™¤</button>
        `;
        container.appendChild(codeDiv);
    });
}

function addCode() {
    const codeValue = document.getElementById('newCodeValue').value.trim().toUpperCase();
    const codePoints = parseInt(document.getElementById('newCodePoints').value);
    
    if (!codeValue || isNaN(codePoints)) {
        alert("è¯·å¡«å†™å®Œæ•´çš„å…‘æ¢ç ä¿¡æ¯ï¼");
        return;
    }
    
    if (REDEEM_CODES.some(c => c.code === codeValue)) {
        alert("æ­¤å…‘æ¢ç å·²å­˜åœ¨ï¼");
        return;
    }
    
    REDEEM_CODES.push({
        code: codeValue,
        points: codePoints,
        usedBy: []
    });
    
    localStorage.setItem('vipSystemCodes', JSON.stringify(REDEEM_CODES));
    
    document.getElementById('newCodeValue').value = '';
    document.getElementById('newCodePoints').value = '';
    loadCodeManagement();
    
    // åŒæ­¥åˆ°æœåŠ¡å™¨
    syncToServer();
}

function deleteCode(code) {
    if (!confirm("ç¡®å®šè¦åˆ é™¤æ­¤å…‘æ¢ç å—ï¼Ÿ")) return;
    
    REDEEM_CODES = REDEEM_CODES.filter(c => c.code !== code);
    localStorage.setItem('vipSystemCodes', JSON.stringify(REDEEM_CODES));
    loadCodeManagement();
    
    // åŒæ­¥åˆ°æœåŠ¡å™¨
    syncToServer();
}

// ================= AIå®¢æœåŠŸèƒ½ =================
function sendAiMessage() {
    const userInput = document.getElementById('aiUserInput').value.trim();
    if (!userInput) return;
    
    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    addAiMessage(userInput, true);
    document.getElementById('aiUserInput').value = '';
    
    // æ¨¡æ‹ŸAIå›åº”
    setTimeout(() => {
        let response = "";
        let giveCompensation = false;
        
        // æ£€æŸ¥æ˜¯å¦å·²ç»è·å¾—è¿‡ä»Šå¤©çš„èµ”å¿
        const today = new Date().toDateString();
        const lastCompDay = lastCompensationTime ? new Date(lastCompensationTime).toDateString() : null;
        const alreadyCompensated = lastCompDay === today;
        
        // ç®€å•çš„å…³é”®è¯åŒ¹é…
        if ((userInput.includes("é—®é¢˜") || userInput.includes("é”™è¯¯") || userInput.includes("bug") || 
             userInput.includes("æ•…éšœ") || userInput.includes("è¡¥å¿")) && !alreadyCompensated) {
            response = "å¾ˆæŠ±æ­‰ç»™æ‚¨å¸¦æ¥ä¸ä¾¿ã€‚æˆ‘ä»¬å·²è®°å½•æ‚¨çš„é—®é¢˜ï¼Œå¹¶å°†èµ é€æ‚¨ 500 ç‚¹ä½œä¸ºè¡¥å¿ã€‚";
            giveCompensation = true;
            
            // è®°å½•èµ”å¿æ—¶é—´
            lastCompensationTime = new Date().toISOString();
        } 
        else if (alreadyCompensated && (userInput.includes("é—®é¢˜") || userInput.includes("é”™è¯¯") || 
                userInput.includes("bug") || userInput.includes("æ•…éšœ") || userInput.includes("è¡¥å¿"))) {
            response = "æˆ‘ä»¬ä»Šå¤©å·²ç»ä¸ºæ‚¨æä¾›è¿‡è¡¥å¿äº†ã€‚å¦‚æœ‰å…¶ä»–é—®é¢˜ï¼Œè¯·è”ç³»å®¢æœäººå‘˜ã€‚";
        }
        else if (userInput.includes("è°¢è°¢") || userInput.includes("æ„Ÿè°¢")) {
            response = "æ„Ÿè°¢æ‚¨çš„æ”¯æŒï¼å¦‚æœæœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·éšæ—¶è”ç³»æˆ‘ä»¬ã€‚";
        }
        else if (userInput.includes("å…‘æ¢ç ")) {
            response = "æ‚¨å¯ä»¥åœ¨VIPåŠŸèƒ½ç•Œé¢ç‚¹å‡»ã€Œè¾“å…¥å…‘æ¢ç ã€æ¥ä½¿ç”¨å…‘æ¢ç ã€‚èŠ‚åº†æœŸé—´ä¼šæœ‰ç‰¹åˆ«å…‘æ¢ç å‘æ”¾ï¼Œè¯·å…³æ³¨å…¬å‘Šï¼";
        }
        else if (userInput.includes("åˆ®åˆ®ä¹")) {
            response = "åˆ®åˆ®ä¹æ¸¸æˆå¯ä»¥è®©æ‚¨æœ‰æœºä¼šèµ¢å¾—ç‚¹æ•°å¥–åŠ±ï¼å¥–åŠ±ç‚¹æ•°ä¸ºè´­ä¹°ä»·æ ¼çš„0.5-5å€ã€‚";
        }
        else if (userInput.includes("ç­‰çº§") || userInput.includes("VIP")) {
            response = "VIPç­‰çº§ç³»ç»Ÿæ ¹æ®æ‚¨çš„ç´¯ç§¯ç‚¹æ•°å†³å®šã€‚ç‚¹æ•°è¶Šé«˜ï¼Œç­‰çº§è¶Šé«˜ï¼Œäº«å—çš„æŠ˜æ‰£å’Œä¼˜æƒ ä¹Ÿè¶Šå¤šï¼";
        }
        else if (userInput.includes("ä½¿ç”¨ç ")) {
            response = "è´­ä¹°å•†å“åä¼šè·å¾—ä½¿ç”¨ç ï¼Œè¯·åœ¨ã€Œä½¿ç”¨å•†å“ã€ç•Œé¢è¾“å…¥ä½¿ç”¨ç æ¥å…‘æ¢å•†å“ã€‚æ¯ä¸ªä½¿ç”¨ç åªèƒ½ä½¿ç”¨ä¸€æ¬¡ã€‚";
        }
        else if (userInput.includes("å‘ç¥¨")) {
            response = "æ¯æ¬¡è´­ä¹°å•†å“éƒ½ä¼šè‡ªåŠ¨è·å–ä¸€å¼ å‘ç¥¨ï¼Œå¥‡æ•°æœˆçš„25å·ç³»ç»Ÿä¼šè‡ªåŠ¨è¿›è¡Œå…‘å¥–ï¼Œä¸­å¥–å¥–é‡‘ä¼šç›´æ¥è½¬ä¸ºç‚¹æ•°å­˜å…¥æ‚¨çš„è´¦æˆ·ã€‚";
        }
        else {
            response = "æ„Ÿè°¢æ‚¨çš„è¯¢é—®ã€‚æˆ‘ä»¬å·²æ”¶åˆ°æ‚¨çš„æ¶ˆæ¯ï¼Œå°†å°½å¿«ä¸ºæ‚¨å¤„ç†ã€‚";
        }
        
        addAiMessage(response, false);
        
        // è¡¥å¿ç‚¹æ•°
        if (giveCompensation && currentUser) {
            currentUser.points += 500;
            users[currentUser.username] = currentUser;
            localStorage.setItem('vipSystemUsers', JSON.stringify(users));
            updateVipDisplay();
            
            // åŒæ­¥åˆ°æœåŠ¡å™¨
            syncToServer();
        }
    }, 1000);
}

function addAiMessage(message, isUser) {
    const chatContainer = document.getElementById('aiChatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `ai-message ${isUser ? 'ai-user' : 'ai-bot'}`;
    messageDiv.textContent = message;
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    
    // ä¿å­˜èŠå¤©è®°å½•
    aiChatHistory.push({
        message: message,
        isUser: isUser,
        time: new Date().toISOString()
    });
}

// ================= å•†å“ç®¡ç†åŠŸèƒ½ =================
function loadItemManagement() {
    const container = document.getElementById('itemListForManagement');
    container.innerHTML = '';
    
    REDEEM_ITEMS.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'cart-item';
        
        itemDiv.innerHTML = `
            <strong>${item.name}</strong> - ${item.cost} ç‚¹
            ${item.vipOnly ? '(ä»…é™VIP)' : ''}
            <button onclick="deleteItem(${item.id})">åˆ é™¤</button>
        `;
        container.appendChild(itemDiv);
    });
}

function addItem() {
    const name = document.getElementById('newItemName').value.trim();
    const cost = parseInt(document.getElementById('newItemCost').value);
    const vipOnly = document.getElementById('newItemVipOnly').value === 'true';
    
    if (!name || isNaN(cost)) {
        alert("è¯·å¡«å†™å®Œæ•´çš„å•†å“ä¿¡æ¯ï¼");
        return;
    }
    
    const newId = REDEEM_ITEMS.length > 0 ? Math.max(...REDEEM_ITEMS.map(i => i.id)) + 1 : 1;
    
    REDEEM_ITEMS.push({
        id: newId,
        name: name,
        cost: cost,
        vipOnly: vipOnly
    });
    
    localStorage.setItem('vipSystemItems', JSON.stringify(REDEEM_ITEMS));
    
    document.getElementById('newItemName').value = '';
    document.getElementById('newItemCost').value = '';
    loadItemManagement();
    
    // åŒæ­¥åˆ°æœåŠ¡å™¨
    syncToServer();
}

function deleteItem(id) {
    if (!confirm("ç¡®å®šè¦åˆ é™¤æ­¤å•†å“å—ï¼Ÿ")) return;
    
    REDEEM_ITEMS = REDEEM_ITEMS.filter(i => i.id !== id);
    localStorage.setItem('vipSystemItems', JSON.stringify(REDEEM_ITEMS));
    loadItemManagement();
    
    // åŒæ­¥åˆ°æœåŠ¡å™¨
    syncToServer();
}

// ================= ç½‘ç»œæ›´æ–°åŠŸèƒ½ =================
function checkForUpdates() {
    document.getElementById('updateStatus').textContent = "æ­£åœ¨æ£€æŸ¥æ›´æ–°...";
    document.getElementById('updateStatus').style.backgroundColor = "#fff3e0";
    
    // æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚è·å–é…ç½®
    setTimeout(() => {
        try {
            // è¿™é‡Œå®é™…åº”è¯¥ä½¿ç”¨fetchä»SYSTEM_CONFIG.configUrlè·å–æ•°æ®
            // ä»¥ä¸‹æ˜¯æ¨¡æ‹Ÿæ•°æ®
            const mockConfig = {
                version: "1.8.0",
                lastUpdate: "2023-11-25",
                announcements: ["æ–°åŠŸèƒ½ä¸Šçº¿ï¼šä½¿ç”¨ç ç³»ç»Ÿ", "æ–°å¢VIPä¸“å±ç¤¼ç‰©åŠŸèƒ½"]
            };
            
            const mockData = {
                items: [
                    ...REDEEM_ITEMS,
                    { id: 7, name: "è±ªåSPAåˆ¸", cost: 800, vipOnly: true },
                    { id: 8, name: "é«˜å°”å¤«ä½“éªŒ", cost: 1500, vipOnly: true }
                ],
                codes: [
                    ...REDEEM_CODES,
                    { code: "UPDATE2023", points: 300, usedBy: [] }
                ],
                usageCodes: [
                    ...USAGE_CODES,
                    { code: "USE54321", item: "ç”µå½±ç¥¨", used: false, usedBy: null, usedAt: null }
                ]
            };
            
            // æ›´æ–°é…ç½®
            SYSTEM_CONFIG.version = mockConfig.version;
            SYSTEM_CONFIG.lastUpdate = mockConfig.lastUpdate;
            
            // æ›´æ–°æ•°æ®
            REDEEM_ITEMS = mockData.items;
            REDEEM_CODES = mockData.codes;
            USAGE_CODES = mockData.usageCodes;
            
            // æ·»åŠ æ–°å…¬å‘Š
            mockConfig.announcements.forEach(announcement => {
                addAnnouncementFromSystem(announcement);
            });
            
            document.getElementById('updateStatus').textContent = `å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ ${mockConfig.version}`;
            document.getElementById('updateStatus').style.backgroundColor = "#e6ffe6";
            
            // æ›´æ–°ç”¨æˆ·ç•Œé¢
            if (currentUser) {
                updateVipDisplay();
                updateAnnouncements();
            }
            
            // ä¿å­˜æ›´æ–°åçš„æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('vipSystemConfig', JSON.stringify(SYSTEM_CONFIG));
            localStorage.setItem('vipSystemData', JSON.stringify({
                items: REDEEM_ITEMS,
                codes: REDEEM_CODES,
                usageCodes: USAGE_CODES
            }));
            
            // åŒæ­¥åˆ°æœåŠ¡å™¨
            syncToServer();
            
        } catch (error) {
            document.getElementById('updateStatus').textContent = "æ›´æ–°å¤±è´¥: " + error.message;
            document.getElementById('updateStatus').style.backgroundColor = "#ffe6e6";
        }
    }, 1500);
}

// ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ›´æ–°
function loadUpdatesFromStorage() {
    const savedConfig = localStorage.getItem('vipSystemConfig');
    const savedData = localStorage.getItem('vipSystemData');
    const savedAnnouncements = localStorage.getItem('vipSystemAnnouncements');
    const savedCodes = localStorage.getItem('vipSystemCodes');
    const savedUsageCodes = localStorage.getItem('vipSystemUsageCodes');
    
    if (savedConfig) {
        const config = JSON.parse(savedConfig);
        if (config.version > SYSTEM_CONFIG.version) {
            Object.assign(SYSTEM_CONFIG, config);
        }
    }
    
    if (savedData) {
        const data = JSON.parse(savedData);
        REDEEM_ITEMS = data.items || REDEEM_ITEMS;
        REDEEM_CODES = data.codes || REDEEM_CODES;
        USAGE_CODES = data.usageCodes || USAGE_CODES;
    }
    
    if (savedAnnouncements) {
        announcements = JSON.parse(savedAnnouncements);
    }
    
    if (savedCodes) {
        REDEEM_CODES = JSON.parse(savedCodes);
    }
    
    if (savedUsageCodes) {
        USAGE_CODES = JSON.parse(savedUsageCodes);
    }
}

// ================= ç”¨æˆ·ç•Œé¢åŠŸèƒ½ =================
function toggleVisibility(elementId, show) {
    document.getElementById(elementId).classList.toggle('hidden', !show);
}

function updateTime() {
    const now = new Date();
    const timeString = now.toLocaleString('zh-TW');
    document.querySelectorAll('#currentTime, #userTime').forEach(el => {
        if (el) el.textContent = timeString;
    });
    setTimeout(updateTime, 1000);
}

// ================= ç”¨æˆ·åŠŸèƒ½ =================
function login(username, password, isVip = false, isAdmin = false) {
    if (!username || !password) {
        document.getElementById('loginError').textContent = "è¯·è¾“å…¥å¸å·å’Œå¯†ç ï¼";
        return false;
    }
    
    if (users[username] && users[username].password === password) {
        // æ£€æŸ¥VIPå’Œç®¡ç†å‘˜æƒé™
        if ((isVip && users[username].vipLevel <= 0 && !users[username].isAdmin) || 
            (isAdmin && !users[username].isAdmin)) {
            document.getElementById('loginError').textContent = "æƒé™ä¸è¶³ï¼";
            return false;
        }
        
        currentUser = { username, ...users[username] };
        document.getElementById('loginOptionContainer').classList.add('hidden');
        document.getElementById('vipContainer').classList.remove('hidden');
        updateVipDisplay();
        updateAnnouncements();
        
        // æ£€æŸ¥å‘ç¥¨å…‘å¥–
        checkAllInvoices();
        
        // å¦‚æœæ˜¯ç®¡ç†å‘˜ï¼Œæ·»åŠ ç®¡ç†æŒ‰é’®
        if (currentUser.isAdmin) {
            const levelDescription = document.getElementById('levelDescription');
            
            // æ¸…é™¤ç°æœ‰æŒ‰é’®
            levelDescription.querySelectorAll('button').forEach(btn => btn.remove());
            
            // å…¬å‘Šç®¡ç†æŒ‰é’®
            const announcementButton = document.createElement('button');
            announcementButton.textContent = "å…¬å‘Šç®¡ç†";
            announcementButton.onclick = function() {
                document.getElementById('vipContainer').classList.add('hidden');
                document.getElementById('announcementManagementContainer').classList.remove('hidden');
                loadAnnouncementManagement();
            };
            levelDescription.appendChild(announcementButton);
            
            // å•†å“ç®¡ç†æŒ‰é’®
            const itemButton = document.createElement('button');
            itemButton.textContent = "å•†å“ç®¡ç†";
            itemButton.onclick = function() {
                document.getElementById('vipContainer').classList.add('hidden');
                document.getElementById('itemManagementContainer').classList.remove('hidden');
                loadItemManagement();
            };
            levelDescription.appendChild(itemButton);
            
            // å…‘æ¢ç ç®¡ç†æŒ‰é’®
            const codeButton = document.createElement('button');
            codeButton.textContent = "å…‘æ¢ç ç®¡ç†";
            codeButton.onclick = function() {
                document.getElementById('vipContainer').classList.add('hidden');
                document.getElementById('codeManagementContainer').classList.remove('hidden');
                loadCodeManagement();
            };
            levelDescription.appendChild(codeButton);
            
            // ä½¿ç”¨ç ç®¡ç†æŒ‰é’®
            const usageCodeButton = document.createElement('button');
            usageCodeButton.textContent = "ä½¿ç”¨ç ç®¡ç†";
            usageCodeButton.onclick = function() {
                document.getElementById('vipContainer').classList.add('hidden');
                document.getElementById('usageCodeManagementContainer').classList.remove('hidden');
                loadUsageCodeManagement();
            };
            levelDescription.appendChild(usageCodeButton);
        }
        
        return true;
    } else {
        document.getElementById('loginError').textContent = "å¸å·æˆ–å¯†ç é”™è¯¯ï¼";
        return false;
    }
}

function register() {
    const username = document.getElementById('newUsername').value.trim();
    const password = document.getElementById('newPassword').value.trim();
    const email = document.getElementById('newEmail').value.trim();
    
    if (!username || !password || !email) {
        alert("è¯·å¡«å†™æ‰€æœ‰æ ä½ï¼");
        return;
    }
    
    if (users[username]) {
        alert("ç”¨æˆ·åå·²å­˜åœ¨ï¼");
        return;
    }
    
    users[username] = { 
        password, 
        email,
        points: 0,
        vipLevel: 0,
        lastCheckIn: null
    };
    
    localStorage.setItem('vipSystemUsers', JSON.stringify(users));
    alert("æ³¨å†ŒæˆåŠŸï¼");
    toggleVisibility('registerContainer', false);
    toggleVisibility('normalLoginContainer', true);
    
    // åŒæ­¥åˆ°æœåŠ¡å™¨
    syncToServer();
}

function logout() {
    currentUser = null;
    document.getElementById('vipContainer').classList.add('hidden');
    document.getElementById('loginOptionContainer').classList.remove('hidden');
    document.getElementById('normalUsername').value = "";
    document.getElementById('normalPassword').value = "";
    document.getElementById('loginError').textContent = "";
}

function changePassword() {
    const oldPassword = document.getElementById('oldPassword').value.trim();
    const newPassword = document.getElementById('newPassword').value.trim();
    const confirmPassword = document.getElementById('confirmPassword').value.trim();
    
    if (!oldPassword || !newPassword || !confirmPassword) {
        alert("è¯·å¡«å†™æ‰€æœ‰æ ä½ï¼");
        return;
    }
    
    if (newPassword !== confirmPassword) {
        alert("æ–°å¯†ç ä¸ç¡®è®¤å¯†ç ä¸ç¬¦ï¼");
        return;
    }
    
    if (currentUser.password !== oldPassword) {
        alert("æ—§å¯†ç é”™è¯¯ï¼");
        return;
    }
    
    currentUser.password = newPassword;
    users[currentUser.username] = currentUser;
    localStorage.setItem('vipSystemUsers', JSON.stringify(users));
    alert("å¯†ç æ›´æ”¹æˆåŠŸï¼");
    toggleVisibility('changePasswordContainer', false);
    
    // åŒæ­¥åˆ°æœåŠ¡å™¨
    syncToServer();
}

// ================= VIPåŠŸèƒ½ =================
function updateVipDisplay() {
    if (!currentUser) return;
    
    const userLevel = getUserLevel(currentUser.points);
    const nextLevel = ALL_LEVELS.find(level => level.level === userLevel.level + 1);
    
    document.getElementById('vipTitle').textContent = 
        `${userLevel.emoji} ${userLevel.name} ${currentUser.username} æ‚¨å¥½ï¼`;
    
    document.getElementById('vipLevelDisplay').innerHTML = `
        <span style="color: ${userLevel.color}">${userLevel.name} (ç­‰çº§ ${userLevel.level})</span><br>
        å½“å‰ç‚¹æ•°: ${currentUser.points === Infinity ? "âˆ" : currentUser.points.toLocaleString()}
    `;
    
    if (nextLevel) {
        const progress = ((currentUser.points - userLevel.points) / (nextLevel.points - userLevel.points)) * 100;
        document.getElementById('pointsProgress').style.width = `${progress}%`;
        document.getElementById('pointsProgress').textContent = `${Math.floor(progress)}%`;
        
        document.getElementById('levelDescription').innerHTML = `
            <strong>ä¸‹ä¸€ç­‰çº§:</strong> ${nextLevel.name} (éœ€è¦ ${(nextLevel.points - currentUser.points).toLocaleString()} ç‚¹)<br>
            <strong>æŠ˜æ‰£ä¼˜æƒ :</strong> ${Math.floor(userLevel.discount * 100)}æŠ˜<br>
            <strong>åˆ®åˆ®ä¹ä»·æ ¼:</strong> ${userLevel.scratchPrice} ç‚¹
        `;
        
        document.getElementById('scratchCardPrice').textContent = userLevel.scratchPrice;
    } else {
        document.getElementById('pointsProgress').style.width = "100%";
        document.getElementById('pointsProgress').textContent = "MAX";
        document.getElementById('levelDescription').innerHTML = `
            <strong>æ‚¨å·²è¾¾åˆ°æœ€é«˜ç­‰çº§ï¼</strong><br>
            <strong>æŠ˜æ‰£ä¼˜æƒ :</strong> ${Math.floor(userLevel.discount * 100)}æŠ˜
        `;
    }
    
    // æ›´æ–°ç­¾åˆ°æŒ‰é’®çŠ¶æ€
    const checkInBtn = document.getElementById('checkInBtn');
    if (isCheckedInToday()) {
        checkInBtn.disabled = true;
        checkInBtn.textContent = "ä»Šæ—¥å·²ç­¾åˆ°";
    } else {
        checkInBtn.disabled = false;
        const userLevel = getUserLevel(currentUser.points);
        checkInBtn.textContent = `æ¯æ—¥ç­¾åˆ° (${userLevel.checkInPoints} ç‚¹)`;
    }
}

function getUserLevel(points) {
    for (let i = ALL_LEVELS.length - 1; i >= 0; i--) {
        if (points >= ALL_LEVELS[i].points) {
            return ALL_LEVELS[i];
        }
    }
    return ALL_LEVELS[0];
}

function isCheckedInToday() {
    if (!currentUser.lastCheckIn) return false;
    const lastCheckIn = new Date(currentUser.lastCheckIn);
    const today = new Date();
    return lastCheckIn.toDateString() === today.toDateString();
}

function vipCheckIn() {
    if (isCheckedInToday()) {
        alert("ä»Šæ—¥å·²ç­¾åˆ°ï¼");
        return;
    }
    
    const userLevel = getUserLevel(currentUser.points);
    const pointsToAdd = userLevel.checkInPoints;
    
    currentUser.points += pointsToAdd;
    currentUser.lastCheckIn = new Date().toISOString();
    currentUser.vipLevel = getUserLevel(currentUser.points).level;
    
    users[currentUser.username] = currentUser;
    localStorage.setItem('vipSystemUsers', JSON.stringify(users));
    
    updateVipDisplay();
    alert(`ç­¾åˆ°æˆåŠŸï¼è·å¾— ${pointsToAdd.toLocaleString()} ç‚¹ï¼`);
    
    // åŒæ­¥åˆ°æœåŠ¡å™¨
    syncToServer();
}

// ================= å…‘æ¢å•†å“åŠŸèƒ½ =================
function showRedeemItems() {
    const container = document.getElementById('redeemItemsList');
    container.innerHTML = "";
    
    REDEEM_ITEMS.forEach(item => {
        if (!item.vipOnly || (currentUser && currentUser.vipLevel > 0)) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'cart-item';
            itemDiv.innerHTML = `
                <strong>${item.name}</strong> - ${item.cost} ç‚¹
                <button class="addToCartBtn" data-id="${item.id}">åŠ å…¥è´­ç‰©è½¦</button>
            `;
            container.appendChild(itemDiv);
        }
    });
    
    // ä¸ºæ‰€æœ‰åŠ å…¥è´­ç‰©è½¦æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬
    document.querySelectorAll('.addToCartBtn').forEach(btn => {
        btn.addEventListener('click', function() {
            addToCart(parseInt(this.getAttribute('data-id')));
        });
    });
    
    updateCartDisplay();
}

function addToCart(itemId) {
    const item = REDEEM_ITEMS.find(i => i.id === itemId);
    if (!item) return;
    
    cart.push(item);
    updateCartDisplay();
}

function removeFromCart(index) {
    cart.splice(index, 1);
    updateCartDisplay();
}

function updateCartDisplay() {
    const container = document.getElementById('cartItems');
    container.innerHTML = "";
    
    if (cart.length === 0) {
        container.innerHTML = "<p>è´­ç‰©è½¦æ˜¯ç©ºçš„</p>";
        return;
    }
    
    let total = 0;
    const userLevel = getUserLevel(currentUser.points);
    
    cart.forEach((item, index) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'cart-item';
        const discountedPrice = Math.floor(item.cost * userLevel.discount);
        itemDiv.innerHTML = `
            <strong>${item.name}</strong> - 
            åŸä»·: ${item.cost} ç‚¹ | 
            æŠ˜æ‰£ä»·: ${discountedPrice} ç‚¹
            <button class="removeFromCartBtn" data-index="${index}">ç§»é™¤</button>
        `;
        container.appendChild(itemDiv);
        total += discountedPrice;
    });
    
    // ä¸ºæ‰€æœ‰ç§»é™¤æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬
    document.querySelectorAll('.removeFromCartBtn').forEach(btn => {
        btn.addEventListener('click', function() {
            removeFromCart(parseInt(this.getAttribute('data-index')));
        });
    });
    
    const totalDiv = document.createElement('div');
    totalDiv.innerHTML = `<strong>æ€»è®¡: ${total} ç‚¹</strong>`;
    container.appendChild(totalDiv);
}

function checkout() {
    if (cart.length === 0) {
        alert("è´­ç‰©è½¦æ˜¯ç©ºçš„ï¼");
        return;
    }
    
    const userLevel = getUserLevel(currentUser.points);
    let total = 0;
    
    cart.forEach(item => {
        total += Math.floor(item.cost * userLevel.discount);
    });
    
    if (currentUser.points < total && currentUser.points !== Infinity) {
        alert("ç‚¹æ•°ä¸è¶³ï¼");
        return;
    }
    
    if (currentUser.points !== Infinity) {
        currentUser.points -= total;
    }
    
    // ç”Ÿæˆä½¿ç”¨ç 
    const usageCodes = [];
    cart.forEach(item => {
        const usageCode = `USE${Math.floor(10000 + Math.random() * 90000)}`;
        usageCodes.push({
            code: usageCode,
            item: item.name,
            used: false,
            usedBy: null,
            usedAt: null
        });
        
        USAGE_CODES.push({
            code: usageCode,
            item: item.name,
            used: false,
            usedBy: null,
            usedAt: null
        });
    });
    
    // ä¿å­˜æ”¶ä»¶è®°å½•
    if (!currentUser.receipts) {
        currentUser.receipts = [];
    }
    currentUser.receipts.push({
        id: `RECEIPT${new Date().getTime()}`,
        items: [...cart],
        total: total,
        date: new Date().toISOString(),
        usageCodes: usageCodes.map(uc => uc.code)
    });
    
    // ç”Ÿæˆå‘ç¥¨
    if (!currentUser.invoices) {
        currentUser.invoices = [];
    }
    currentUser.invoices.push({
        number: generateInvoiceNumber(),
        amount: total,
        date: new Date().toISOString(),
        checked: false
    });
    
    users[currentUser.username] = currentUser;
    localStorage.setItem('vipSystemUsers', JSON.stringify(users));
    localStorage.setItem('vipSystemUsageCodes', JSON.stringify(USAGE_CODES));
    
    // æ˜¾ç¤ºæ”¶æ®å’Œä½¿ç”¨ç 
    const receiptContainer = document.getElementById('cartItems');
    const receiptDiv = document.createElement('div');
    receiptDiv.className = 'cart-item';
    
    let usageCodesHtml = '<h4>ä½¿ç”¨ç :</h4>';
    usageCodes.forEach(code => {
        usageCodesHtml += `<p>${code.item}: ${code.code}</p>`;
    });
    
    receiptDiv.innerHTML = `
        <h3>æ”¶æ® #${currentUser.receipts.length}</h3>
        <p>æ—¥æœŸ: ${new Date().toLocaleString()}</p>
        <p>æ€»ç‚¹æ•°: ${total}</p>
        ${usageCodesHtml}
        <p>è¯·åœ¨ã€Œä½¿ç”¨å•†å“ã€ç•Œé¢è¾“å…¥ä½¿ç”¨ç å…‘æ¢å•†å“</p>
    `;
    receiptContainer.appendChild(receiptDiv);
    
    alert(`è´­ä¹°æˆåŠŸï¼æ‰£é™¤ ${total} ç‚¹\nä½¿ç”¨ç å·²ç”Ÿæˆï¼Œè¯·åœ¨ã€Œä½¿ç”¨å•†å“ã€ç•Œé¢è¾“å…¥ä½¿ç”¨ç å…‘æ¢å•†å“ã€‚`);
    cart = [];
    updateCartDisplay();
    updateVipDisplay();
    
    // åŒæ­¥åˆ°æœåŠ¡å™¨
    syncToServer();
}

// ================= åˆ®åˆ®ä¹åŠŸèƒ½ =================
function playScratchCard() {
    const userLevel = getUserLevel(currentUser.points);
    const price = userLevel.scratchPrice;
    
    if (currentUser.points < price && currentUser.points !== Infinity) {
        alert("ç‚¹æ•°ä¸è¶³ï¼");
        return;
    }
    
    if (currentUser.points !== Infinity) {
        // æ‰£é™¤ç‚¹æ•°
        currentUser.points -= price;
    }
    
    // éšæœºå¥–åŠ± (1x-5xä»·æ ¼ï¼Œè‡³å°‘100ç‚¹)
    const rewardMultiplier = 1 + Math.random() * 4;
    let reward = Math.floor(price * rewardMultiplier);
    reward = Math.max(reward, 100); // ç¡®ä¿è‡³å°‘100ç‚¹
    
    // å¢åŠ å¥–åŠ±ç‚¹æ•°
    currentUser.points += reward;
    
    // ä¿å­˜ç”¨æˆ·æ•°æ®
    users[currentUser.username] = currentUser;
    localStorage.setItem('vipSystemUsers', JSON.stringify(users));
    
    document.getElementById('scratchResult').innerHTML = `
        <h3>æ­å–œæ‚¨ï¼</h3>
        <p>è·å¾— ${reward} ç‚¹å¥–åŠ±ï¼</p>
        <p>å½“å‰ç‚¹æ•°: ${currentUser.points === Infinity ? "âˆ" : currentUser.points.toLocaleString()}</p>
    `;
    
    updateVipDisplay();
    
    // åŒæ­¥åˆ°æœåŠ¡å™¨
    syncToServer();
}

// ================= VIPç­‰çº§æŸ¥çœ‹ =================
function viewAllLevels() {
    document.getElementById('vipContainer').classList.add('hidden');
    document.getElementById('allLevelsContainer').classList.remove('hidden');
    
    const container = document.getElementById('levelsList');
    container.innerHTML = "";
    
    // æ˜¾ç¤ºæ™®é€šç­‰çº§
    const normalLevelsDiv = document.createElement('div');
    normalLevelsDiv.innerHTML = `<h3>æ™®é€šç”¨æˆ·ï¼ˆ0 - 99,999ç‚¹ï¼‰ï½œ500çº§</h3>`;
    container.appendChild(normalLevelsDiv);
    
    // æ˜¾ç¤ºç‰¹æ®Šæ™®é€šç­‰çº§
    const specialNormalLevels = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 495, 496, 497, 498, 499];
    specialNormalLevels.forEach(i => {
        const level = NORMAL_LEVELS[i];
        const levelDiv = document.createElement('div');
        levelDiv.className = "level-description";
        levelDiv.style.borderLeft = `5px solid ${level.color}`;
        
        const isCurrentLevel = currentUser && getUserLevel(currentUser.points).level === level.level;
        
        levelDiv.innerHTML = `
            <strong style="color: ${level.color}">${level.emoji} ${level.name}</strong>
            ${isCurrentLevel ? '<span style="color:red"> (å½“å‰ç­‰çº§)</span>' : ''}<br>
            ç­‰çº§: ${level.level} | éœ€æ±‚ç‚¹æ•°: ${level.points.toLocaleString()}<br>
            æŠ˜æ‰£: ${Math.floor(level.discount * 100)}æŠ˜ | åˆ®åˆ®ä¹: ${level.scratchPrice} ç‚¹ | ç­¾åˆ°: ${level.checkInPoints} ç‚¹
        `;
        container.appendChild(levelDiv);
    });
    
    // æ˜¾ç¤ºVIPç­‰çº§
    const vipLevelsDiv = document.createElement('div');
    vipLevelsDiv.innerHTML = `<h3 style="margin-top:20px;">VIPç”¨æˆ·ï¼ˆ100,000ç‚¹èµ·ï¼‰ï½œ100çº§</h3>`;
    container.appendChild(vipLevelsDiv);
    
    // æ˜¾ç¤ºæ‰€æœ‰VIPç­‰çº§
    VIP_LEVELS.forEach((level, i) => {
        const levelDiv = document.createElement('div');
        levelDiv.className = "level-description";
        levelDiv.style.borderLeft = `5px solid ${level.color}`;
        
        const isCurrentLevel = currentUser && getUserLevel(currentUser.points).level === level.level;
        
        // æ¯10çº§æ˜¾ç¤ºåˆ†ç»„æ ‡é¢˜
        if (i % 10 === 0) {
            const groupDiv = document.createElement('div');
            groupDiv.innerHTML = `<h4>${level.group}</h4>`;
            container.appendChild(groupDiv);
        }
        
        levelDiv.innerHTML = `
            <strong style="color: ${level.color}">${level.emoji} ${level.name}</strong>
            ${isCurrentLevel ? '<span style="color:red"> (å½“å‰ç­‰çº§)</span>' : ''}<br>
            ç­‰çº§: ${level.level} | éœ€æ±‚ç‚¹æ•°: ${level.points.toLocaleString()}<br>
            æŠ˜æ‰£: ${Math.floor(level.discount * 100)}æŠ˜ | åˆ®åˆ®ä¹: ${level.scratchPrice} ç‚¹ | ç­¾åˆ°: ${level.checkInPoints} ç‚¹
        `;
        container.appendChild(levelDiv);
    });
}

// ================= æ–°å¢åŠŸèƒ½å®ç° =================
function dailyBonus() {
    if (!currentUser) return;
    
    // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²ç»é¢†å–è¿‡
    const today = new Date().toDateString();
    if (currentUser.lastDailyBonus && new Date(currentUser.lastDailyBonus).toDateString() === today) {
        alert("ä»Šæ—¥å·²é¢†å–è¿‡é¢å¤–å¥–åŠ±ï¼");
        return;
    }
    
    // éšæœºå¥–åŠ±ç‚¹æ•° (1000-5000ç‚¹)
    const bonus = Math.floor(1000 + Math.random() * 4000);
    currentUser.points += bonus;
    currentUser.lastDailyBonus = new Date().toISOString();
    
    users[currentUser.username] = currentUser;
    localStorage.setItem('vipSystemUsers', JSON.stringify(users));
    
    alert(`æ­å–œè·å¾—æ¯æ—¥é¢å¤–å¥–åŠ± ${bonus} ç‚¹ï¼`);
    updateVipDisplay();
    
    // åŒæ­¥åˆ°æœåŠ¡å™¨
    syncToServer();
}

function pointTransfer() {
    const recipient = prompt("è¯·è¾“å…¥æ¥æ”¶æ–¹ç”¨æˆ·å:");
    if (!recipient || !users[recipient]) {
        alert("æ— æ•ˆçš„ç”¨æˆ·åï¼");
        return;
    }
    
    const amount = parseInt(prompt("è¯·è¾“å…¥è½¬è´¦ç‚¹æ•°:"));
    if (isNaN(amount)) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ç‚¹æ•°ï¼");
        return;
    }
    
    if (currentUser.points < amount && currentUser.points !== Infinity) {
        alert("ç‚¹æ•°ä¸è¶³ï¼");
        return;
    }
    
    // æ‰§è¡Œè½¬è´¦
    if (currentUser.points !== Infinity) {
        currentUser.points -= amount;
    }
    users[recipient].points += amount;
    
    users[currentUser.username] = currentUser;
    users[recipient] = users[recipient];
    localStorage.setItem('vipSystemUsers', JSON.stringify(users));
    
    alert(`æˆåŠŸè½¬è´¦ ${amount} ç‚¹ç»™ ${recipient}ï¼`);
    updateVipDisplay();
    
    // åŒæ­¥åˆ°æœåŠ¡å™¨
    syncToServer();
}

function vipGift() {
    if (!currentUser || currentUser.vipLevel <= 0) {
        alert("æ­¤åŠŸèƒ½ä»…é™VIPä¼šå‘˜ä½¿ç”¨ï¼");
        return;
    }
    
    // æ£€æŸ¥æœ¬å‘¨æ˜¯å¦å·²ç»é¢†å–è¿‡
    const now = new Date();
    const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
    if (currentUser.lastVipGift && new Date(currentUser.lastVipGift) > weekStart) {
        alert("æœ¬å‘¨å·²é¢†å–è¿‡VIPä¸“å±ç¤¼ç‰©ï¼");
        return;
    }
    
    // VIPç­‰çº§è¶Šé«˜ï¼Œç¤¼ç‰©è¶Šå¥½
    const giftPoints = currentUser.vipLevel * 1000;
    currentUser.points += giftPoints;
    currentUser.lastVipGift = new Date().toISOString();
    
    users[currentUser.username] = currentUser;
    localStorage.setItem('vipSystemUsers', JSON.stringify(users));
    
    alert(`æ­å–œè·å¾—VIPä¸“å±ç¤¼ç‰© ${giftPoints} ç‚¹ï¼`);
    updateVipDisplay();
    
    // åŒæ­¥åˆ°æœåŠ¡å™¨
    syncToServer();
}

// ================= åŒæ­¥åŠŸèƒ½ =================
function syncToServer() {
    fetch(SYSTEM_CONFIG.syncUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            users: users,
            items: REDEEM_ITEMS,
            codes: REDEEM_CODES,
            usageCodes: USAGE_CODES,
            announcements: announcements,
            version: SYSTEM_CONFIG.version
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log("åŒæ­¥æˆåŠŸ:", data);
    })
    .catch(error => {
        console.error("åŒæ­¥é”™è¯¯:", error);
    });
}

function syncFromServer() {
    fetch(SYSTEM_CONFIG.syncUrl)
    .then(response => response.json())
    .then(data => {
        if (data.version > SYSTEM_CONFIG.version) {
            // æ›´æ–°æœ¬åœ°æ•°æ®
            users = data.users || users;
            REDEEM_ITEMS = data.items || REDEEM_ITEMS;
            REDEEM_CODES = data.codes || REDEEM_CODES;
            USAGE_CODES = data.usageCodes || USAGE_CODES;
            announcements = data.announcements || announcements;
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('vipSystemUsers', JSON.stringify(users));
            localStorage.setItem('vipSystemItems', JSON.stringify(REDEEM_ITEMS));
            localStorage.setItem('vipSystemCodes', JSON.stringify(REDEEM_CODES));
            localStorage.setItem('vipSystemUsageCodes', JSON.stringify(USAGE_CODES));
            localStorage.setItem('vipSystemAnnouncements', JSON.stringify(announcements));
            
            // æ›´æ–°ç•Œé¢
            if (currentUser) {
                currentUser = users[currentUser.username] || currentUser;
                updateVipDisplay();
                updateAnnouncements();
            }
            
            console.log("æ•°æ®åŒæ­¥å®Œæˆ");
        }
    })
    .catch(error => {
        console.error("åŒæ­¥é”™è¯¯:", error);
    });
}

// ================= æ”¶ä»¶åŠŸèƒ½ =================
function showReceipts() {
    document.getElementById('vipContainer').classList.add('hidden');
    document.getElementById('receiptContainer').classList.remove('hidden');
    
    const container = document.getElementById('receiptList');
    container.innerHTML = '';
    
    if (!currentUser.receipts || currentUser.receipts.length === 0) {
        container.innerHTML = "<p>æ²¡æœ‰æ”¶ä»¶è®°å½•</p>";
        return;
    }
    
    currentUser.receipts.forEach((receipt, index) => {
        const receiptDiv = document.createElement('div');
        receiptDiv.className = 'cart-item';
        
        const date = new Date(receipt.date);
        const formattedDate = date.toLocaleString('zh-TW');
        
        let itemsList = '<ul>';
        receipt.items.forEach(item => {
            itemsList += `<li>${item.name}</li>`;
        });
        itemsList += '</ul>';
        
        let usageCodesList = '<h4>ä½¿ç”¨ç :</h4><ul>';
        receipt.usageCodes.forEach(code => {
            const codeInfo = USAGE_CODES.find(uc => uc.code === code);
            const usedStatus = codeInfo && codeInfo.used ? 
                `(å·²ä½¿ç”¨ - ${new Date(codeInfo.usedAt).toLocaleString()})` : 
                "(æœªä½¿ç”¨)";
            usageCodesList += `<li>${code} ${usedStatus}</li>`;
        });
        usageCodesList += '</ul>';
        
        receiptDiv.innerHTML = `
            <h3>æ”¶æ® #${index + 1}</h3>
            <p>æ—¥æœŸ: ${formattedDate}</p>
            <p>æ€»ç‚¹æ•°: ${receipt.total}</p>
            <h4>å•†å“:</h4>
            ${itemsList}
            ${usageCodesList}
        `;
        
        container.appendChild(receiptDiv);
    });
}

function backToVipPage() {
    // éšè—æ‰€æœ‰åŠŸèƒ½åŒº
    document.querySelectorAll('.container').forEach(container => {
        if (container.id !== 'vipContainer' && container.id !== 'loginOptionContainer') {
            container.classList.add('hidden');
        }
    });
    
    // æ˜¾ç¤ºVIPä¸»ç•Œé¢
    document.getElementById('vipContainer').classList.remove('hidden');
}

function backToLoginOptions() {
    // éšè—æ‰€æœ‰å®¹å™¨
    document.querySelectorAll('.container').forEach(container => {
        container.classList.add('hidden');
    });
    
    // æ˜¾ç¤ºç™»å½•é€‰é¡¹
    document.getElementById('loginOptionContainer').classList.remove('hidden');
}

// ================= åˆå§‹åŒ–äº‹ä»¶ç›‘å¬ =================
function initEventListeners() {
    // ç™»å½•é€‰é¡¹æŒ‰é’®
    document.getElementById('vipLoginBtn').addEventListener('click', () => {
        toggleVisibility('loginOptionContainer', false);
        toggleVisibility('vipLoginContainer', true);
    });
    document.getElementById('normalLoginBtn').addEventListener('click', () => {
        toggleVisibility('loginOptionContainer', false);
        toggleVisibility('normalLoginContainer', true);
    });
    document.getElementById('adminLoginBtn').addEventListener('click', () => {
        toggleVisibility('loginOptionContainer', false);
        toggleVisibility('adminLoginContainer', true);
    });
    
    // è¿”å›æŒ‰é’®
    document.getElementById('vipBackBtn').addEventListener('click', backToLoginOptions);
    document.getElementById('normalBackBtn').addEventListener('click', backToLoginOptions);
    document.getElementById('adminBackBtn').addEventListener('click', backToLoginOptions);
    document.getElementById('registerBackBtn').addEventListener('click', () => {
        toggleVisibility('registerContainer', false);
        toggleVisibility('normalLoginContainer', true);
    });
    document.getElementById('redeemBackBtn').addEventListener('click', backToVipPage);
    document.getElementById('scratchBackBtn').addEventListener('click', backToVipPage);
    document.getElementById('changePasswordBackBtn').addEventListener('click', backToVipPage);
    document.getElementById('levelsBackBtn').addEventListener('click', backToVipPage);
    document.getElementById('announcementBackBtn').addEventListener('click', backToVipPage);
    document.getElementById('redeemCodeBackBtn').addEventListener('click', backToVipPage);
    document.getElementById('aiChatBackBtn').addEventListener('click', backToVipPage);
    document.getElementById('itemBackBtn').addEventListener('click', backToVipPage);
    document.getElementById('codeBackBtn').addEventListener('click', backToVipPage);
    document.getElementById('receiptBackBtn').addEventListener('click', backToVipPage);
    document.getElementById('invoiceBackBtn').addEventListener('click', backToVipPage);
    document.getElementById('usageCodeBackBtn').addEventListener('click', backToVipPage);
    document.getElementById('newsBackBtn').addEventListener('click', backToVipPage);
    document.getElementById('weatherBackBtn').addEventListener('click', backToVipPage);
    document.getElementById('usageCodeManagementBackBtn').addEventListener('click', backToVipPage);
    
    // ç™»å½•/æ³¨å†ŒæŒ‰é’®
    document.getElementById('vipLoginSubmit').addEventListener('click', () => {
        const username = document.getElementById('vipUsername').value.trim();
        const password = document.getElementById('vipPassword').value.trim();
        login(username, password, true);
    });
    document.getElementById('normalLoginSubmit').addEventListener('click', () => {
        const username = document.getElementById('normalUsername').value.trim();
        const password = document.getElementById('normalPassword').value.trim();
        login(username, password);
    });
    document.getElementById('adminLoginSubmit').addEventListener('click', () => {
        const username = document.getElementById('adminUsername').value.trim();
        const password = document.getElementById('adminPassword').value.trim();
        login(username, password, false, true);
    });
    document.getElementById('normalRegisterBtn').addEventListener('click', () => {
        toggleVisibility('normalLoginContainer', false);
        toggleVisibility('registerContainer', true);
    });
    document.getElementById('registerSubmit').addEventListener('click', register);
    
    // VIPåŠŸèƒ½æŒ‰é’®
    document.getElementById('checkInBtn').addEventListener('click', vipCheckIn);
    document.getElementById('viewLevelsBtn').addEventListener('click', viewAllLevels);
    document.getElementById('redeemItemsBtn').addEventListener('click', () => {
        document.getElementById('vipContainer').classList.add('hidden');
        document.getElementById('redeemContainer').classList.remove('hidden');
        showRedeemItems();
    });
    document.getElementById('scratchCardBtn').addEventListener('click', () => {
        document.getElementById('vipContainer').classList.add('hidden');
        document.getElementById('scratchCardContainer').classList.remove('hidden');
    });
    document.getElementById('changePasswordBtn').addEventListener('click', () => {
        document.getElementById('vipContainer').classList.add('hidden');
        document.getElementById('changePasswordContainer').classList.remove('hidden');
    });
    document.getElementById('redeemCodeBtn').addEventListener('click', () => {
        document.getElementById('vipContainer').classList.add('hidden');
        document.getElementById('redeemCodeContainer').classList.remove('hidden');
    });
    document.getElementById('aiChatBtn').addEventListener('click', () => {
        document.getElementById('vipContainer').classList.add('hidden');
        document.getElementById('aiChatContainer').classList.remove('hidden');
    });
    document.getElementById('checkUpdatesBtn').addEventListener('click', checkForUpdates);
    document.getElementById('viewReceiptsBtn').addEventListener('click', showReceipts);
    document.getElementById('viewInvoicesBtn').addEventListener('click', showInvoices);
    document.getElementById('logoutBtn').addEventListener('click', logout);
    
    // ä½¿ç”¨ç åŠŸèƒ½æŒ‰é’®
    document.getElementById('usageCodeSubmit').addEventListener('click', useCode);
    document.getElementById('addUsageCodeBtn').addEventListener('click', addUsageCode);
    
    // å…¶ä»–åŠŸèƒ½æŒ‰é’®
    document.getElementById('checkoutBtn').addEventListener('click', checkout);
    document.getElementById('playScratchBtn').addEventListener('click', playScratchCard);
    document.getElementById('changePasswordSubmit').addEventListener('click', changePassword);
    document.getElementById('addAnnouncementBtn').addEventListener('click', addAnnouncement);
    document.getElementById('redeemCodeSubmit').addEventListener('click', redeemCode);
    document.getElementById('sendAiMessageBtn').addEventListener('click', sendAiMessage);
    document.getElementById('addItemBtn').addEventListener('click', addItem);
    document.getElementById('addCodeBtn').addEventListener('click', addCode);
    
    // æ–°å¢åŠŸèƒ½æŒ‰é’®
    document.getElementById('dailyBonusBtn').addEventListener('click', dailyBonus);
    document.getElementById('pointTransferBtn').addEventListener('click', pointTransfer);
    document.getElementById('vipGiftBtn').addEventListener('click', vipGift);
    
    // æ–°é—»å’Œå¤©æ°”æŒ‰é’®
    document.getElementById('viewNewsBtn').addEventListener('click', () => {
        document.getElementById('vipContainer').classList.add('hidden');
        document.getElementById('newsContainer').classList.remove('hidden');
        fetchNews();
    });
    document.getElementById('viewWeatherBtn').addEventListener('click', () => {
        document.getElementById('vipContainer').classList.add('hidden');
        document.getElementById('weatherContainer').classList.remove('hidden');
        fetchWeather();
    });
    
    // è¾“å…¥æ¡†å›è½¦äº‹ä»¶
    document.getElementById('aiUserInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendAiMessage();
    });
    document.getElementById('redeemCodeInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') redeemCode();
    });
    document.getElementById('usageCodeInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') useCode();
    });
}

// ================= åˆå§‹åŒ– =================
function init() {
    loadUpdatesFromStorage();
    updateTime();
    updateAnnouncements();
    
    // ä¿®æ”¹ä¸ºåªåœ¨æ¯å¤©ç¬¬ä¸€æ¬¡åŠ è½½æ—¶æ£€æŸ¥èŠ‚æ—¥ç 
    const lastHolidayCheck = localStorage.getItem('lastHolidayCheck');
    const today = new Date().toDateString();
    if (!lastHolidayCheck || new Date(lastHolidayCheck).toDateString() !== today) {
        checkHolidayCodes();
    }
    
    initEventListeners();
    
    // ä»æœåŠ¡å™¨åŒæ­¥æ•°æ®
    syncFromServer();
}

// ç¡®ä¿DOMå®Œå…¨åŠ è½½åå†åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    init();
});
</script>
</body>
</html>
