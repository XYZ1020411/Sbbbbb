<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>超級VIP客戶登錄系統</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            color: #333; 
            margin: 0; 
            padding: 0; 
            background-color: #FFD700;
            font-size: 18px;
        }
        .container { 
            background: rgba(255,255,255,0.9); 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); 
            margin: 20px auto; 
            padding: 20px; 
            max-width: 500px; 
        }
        h2 { text-align: center; color: #b30000; font-size: 24px; }
        h3 { font-size: 20px; }
        input, textarea, select { 
            width: 100%; 
            padding: 10px; 
            margin: 10px 0; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            font-size: 16px;
        }
        button { 
            background-color: #FFA500; 
            color: black; 
            border: none; 
            padding: 10px; 
            border-radius: 4px; 
            cursor: pointer; 
            width: 100%; 
            margin: 5px 0; 
            transition: background-color 0.3s; 
            font-size: 16px;
        }
        button:hover { background-color: #FF8C00; }
        .hidden { display: none; }
        .cart-item { background: #e6ffe6; padding: 10px; margin: 5px 0; border-radius: 4px; }
        .vip-level { 
            font-weight: bold; 
            color: #b30000; 
            margin: 10px 0; 
            text-align: center; 
            font-size: 18px; 
        }
        .progress-container {
            width: 100%;
            background-color: #ddd;
            border-radius: 5px;
            margin: 10px 0;
        }
        .progress-bar {
            height: 20px;
            background-color: #4CAF50;
            border-radius: 5px;
            text-align: center;
            line-height: 20px;
            color: white;
            transition: width 0.3s;
        }
        .level-description {
            margin: 15px 0;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
        .announcement {
            background: #fff3e0;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .announcement-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        .announcement-item:last-child {
            border-bottom: none;
        }
        .announcement-content {
            flex-grow: 1;
        }
        .announcement-date {
            color: #666;
            font-size: 0.8em;
            margin-left: 10px;
        }
        .time-display {
            text-align: center;
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        #barcodeContainer {
            text-align: center;
            margin: 20px 0;
        }
        #scratchCard {
            padding: 20px;
            background: #f0f0f0;
            border-radius: 8px;
            text-align: center;
            margin: 10px 0;
        }
        #updateStatus {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .redeem-code-container {
            margin: 10px 0;
            padding: 10px;
            background: #e6f7ff;
            border-radius: 4px;
        }
        .ai-chat-container {
            margin: 10px 0;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
        }
        .ai-message {
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
        }
        .ai-user {
            background: #e6ffe6;
            text-align: right;
        }
        .ai-bot {
            background: #e6f7ff;
            text-align: left;
        }
        .admin-controls {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        #loginError {
            color: red;
            text-align: center;
            margin: 10px 0;
        }
        /* 新增樣式 */
        #scannerArea {
            margin: 10px 0;
            border: 2px dashed #ccc;
            position: relative;
            min-height: 300px;
        }
        #scanResult {
            margin: 10px 0;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
            text-align: center;
        }
        #receiptList {
            margin-top: 20px;
        }
        #receiptList .cart-item {
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        #scannerCanvas {
            display: none;
        }
        .invoice-container {
            margin: 10px 0;
            padding: 10px;
            background: #fff3e0;
            border-radius: 4px;
        }
        .invoice-prize {
            color: #e53935;
            font-weight: bold;
        }
        /* 新增新聞和天氣樣式 */
        .news-container {
            margin: 10px 0;
            padding: 10px;
            background: #f0f8ff;
            border-radius: 4px;
        }
        .news-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .news-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .news-source {
            color: #666;
            font-size: 0.8em;
        }
        .weather-container {
            margin: 10px 0;
            padding: 10px;
            background: #f0fff0;
            border-radius: 4px;
        }
        .weather-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }
        .weather-date {
            font-weight: bold;
        }
        .weather-temp {
            color: #e53935;
        }
        .weather-desc {
            color: #2196F3;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
</head>
<body>
    <!-- 登錄選項選擇界面 -->
    <div class="container" id="loginOptionContainer">
        <h2>請選擇登錄類型</h2>
        <button id="vipLoginBtn">VIP 會員登錄</button>
        <button id="normalLoginBtn">普通客戶登錄</button>
        <button id="adminLoginBtn">管理員登錄</button>
    </div>

    <!-- VIP 登錄界面 -->
    <div class="container hidden" id="vipLoginContainer">
        <h2>VIP 會員登錄</h2>
        <input type="text" id="vipUsername" placeholder="VIP 帳號">
        <input type="password" id="vipPassword" placeholder="VIP 密碼">
        <button id="vipLoginSubmit">VIP 登錄</button>
        <button id="vipBackBtn">返回</button>
    </div>

    <!-- 普通客戶登錄界面 -->
    <div class="container hidden" id="normalLoginContainer">
        <h2>普通客戶登錄</h2>
        <input type="text" id="normalUsername" placeholder="用戶名">
        <input type="password" id="normalPassword" placeholder="密碼">
        <div id="loginError"></div>
        <button id="normalLoginSubmit">登錄</button>
        <button id="normalRegisterBtn">註冊新帳號</button>
        <button id="normalBackBtn">返回</button>
    </div>

    <!-- 管理員登錄界面 -->
    <div class="container hidden" id="adminLoginContainer">
        <h2>管理員登錄</h2>
        <input type="text" id="adminUsername" placeholder="管理員帳號">
        <input type="password" id="adminPassword" placeholder="管理員密碼">
        <button id="adminLoginSubmit">管理員登錄</button>
        <button id="adminBackBtn">返回</button>
    </div>

    <!-- 註冊界面 -->
    <div class="container hidden" id="registerContainer">
        <h2>註冊新帳號</h2>
        <input type="text" id="newUsername" placeholder="用戶名">
        <input type="password" id="newPassword" placeholder="密碼">
        <input type="email" id="newEmail" placeholder="電子郵件">
        <button id="registerSubmit">註冊</button>
        <button id="registerBackBtn">返回</button>
    </div>

    <!-- VIP 功能界面 -->
    <div class="container hidden" id="vipContainer">
        <h2 id="vipTitle">VIP 會員您好！</h2>
        <div id="userAnnouncement" class="announcement">
            <h3>最新公告</h3>
            <div id="announcementsList"></div>
        </div>
        <div class="time-display" id="userTime"></div>
        
        <!-- 新增新聞和天氣區塊 -->
        <div id="newsContainer" class="news-container">
            <h3>最新新聞</h3>
            <div id="newsList"></div>
        </div>
        
        <div id="weatherContainer" class="weather-container">
            <h3>天氣預報</h3>
            <div id="weatherList"></div>
        </div>
        
        <div class="vip-level" id="vipLevelDisplay"></div>
        <div class="progress-container">
            <div id="pointsProgress" class="progress-bar"></div>
        </div>
        
        <div class="level-description" id="levelDescription"></div>
        
        <button id="checkInBtn">每日簽到</button>
        <button id="viewLevelsBtn">查看VIP等級</button>
        <button id="redeemItemsBtn">兌換商品</button>
        <button id="scratchCardBtn">VIP刮刮樂</button>
        <button id="changePasswordBtn">更改密碼</button>
        <button id="redeemCodeBtn">輸入兌換碼</button>
        <button id="aiChatBtn">AI客服</button>
        <button id="checkUpdatesBtn">檢查更新</button>
        <button id="viewReceiptsBtn">查看收件</button>
        <button id="viewInvoicesBtn">查看發票</button>
        <div id="updateStatus"></div>
        <button id="logoutBtn">登出</button>
    </div>

    <!-- 兌換商品界面 -->
    <div class="container hidden" id="redeemContainer">
        <h2>兌換商品</h2>
        <div id="redeemItemsList"></div>
        <h3>我的購物車</h3>
        <div id="cartItems"></div>
        <button id="checkoutBtn">結帳</button>
        <button id="redeemBackBtn">返回</button>
    </div>

    <!-- 刮刮樂界面 -->
    <div class="container hidden" id="scratchCardContainer">
        <h2>VIP刮刮樂</h2>
        <div id="scratchCard">
            <p>刮刮樂遊戲，有機會贏得大獎！</p>
            <button id="playScratchBtn">購買刮刮樂 (<span id="scratchCardPrice">10</span> 點)</button>
            <div id="scratchResult"></div>
        </div>
        <button id="scratchBackBtn">返回</button>
    </div>

    <!-- 更改密碼界面 -->
    <div class="container hidden" id="changePasswordContainer">
        <h2>更改密碼</h2>
        <input type="password" id="oldPassword" placeholder="舊密碼">
        <input type="password" id="newPassword" placeholder="新密碼">
        <input type="password" id="confirmPassword" placeholder="確認新密碼">
        <button id="changePasswordSubmit">更改密碼</button>
        <button id="changePasswordBackBtn">返回</button>
    </div>

    <!-- 所有VIP等級顯示 -->
    <div class="container hidden" id="allLevelsContainer">
        <h2>VIP等級系統</h2>
        <div id="levelsList"></div>
        <button id="levelsBackBtn">返回</button>
    </div>

    <!-- 公告管理界面 (僅管理員可見) -->
    <div class="container hidden" id="announcementManagementContainer">
        <h2>公告管理</h2>
        <div id="announcementListForManagement"></div>
        <h3>新增公告</h3>
        <textarea id="newAnnouncementContent" placeholder="輸入公告內容" rows="3"></textarea>
        <button id="addAnnouncementBtn">發布公告</button>
        <button id="announcementBackBtn">返回</button>
    </div>

    <!-- 兌換碼界面 -->
    <div class="container hidden" id="redeemCodeContainer">
        <h2>輸入兌換碼</h2>
        <input type="text" id="redeemCodeInput" placeholder="輸入兌換碼">
        <button id="redeemCodeSubmit">兌換</button>
        <div id="redeemCodeResult"></div>
        <button id="redeemCodeBackBtn">返回</button>
    </div>

    <!-- AI客服界面 -->
    <div class="container hidden" id="aiChatContainer">
        <h2>AI客服</h2>
        <div class="ai-chat-container" id="aiChatMessages">
            <div class="ai-message ai-bot">您好！我是AI客服，請問有什麼可以幫助您的？</div>
        </div>
        <input type="text" id="aiUserInput" placeholder="輸入您的問題">
        <button id="sendAiMessageBtn">發送</button>
        <button id="aiChatBackBtn">返回</button>
    </div>

    <!-- 管理員商品管理界面 -->
    <div class="container hidden" id="itemManagementContainer">
        <h2>商品管理</h2>
        <div id="itemListForManagement"></div>
        <h3>新增商品</h3>
        <input type="text" id="newItemName" placeholder="商品名稱">
        <input type="number" id="newItemCost" placeholder="所需點數">
        <select id="newItemVipOnly">
            <option value="false">所有用戶</option>
            <option value="true">僅限VIP</option>
        </select>
        <button id="addItemBtn">新增商品</button>
        <button id="itemBackBtn">返回</button>
    </div>

    <!-- 管理員兌換碼管理界面 -->
    <div class="container hidden" id="codeManagementContainer">
        <h2>兌換碼管理</h2>
        <div id="codeListForManagement"></div>
        <h3>新增兌換碼</h3>
        <input type="text" id="newCodeValue" placeholder="兌換碼">
        <input type="number" id="newCodePoints" placeholder="點數">
        <button id="addCodeBtn">新增兌換碼</button>
        <button id="codeBackBtn">返回</button>
    </div>

    <!-- 收件界面 -->
    <div class="container hidden" id="receiptContainer">
        <h2>我的收件</h2>
        <div id="receiptList"></div>
        <button id="receiptBackBtn">返回</button>
    </div>

    <!-- 發票界面 -->
    <div class="container hidden" id="invoiceContainer">
        <h2>我的發票</h2>
        <div id="invoiceList"></div>
        <button id="invoiceBackBtn">返回</button>
    </div>

    <!-- 管理員掃描界面 -->
    <div class="container hidden" id="barcodeScannerContainer">
        <h2>條碼掃描</h2>
        <div id="scannerArea">
            <video id="scannerVideo" width="100%" playsinline></video>
            <canvas id="scannerCanvas" class="hidden"></canvas>
        </div>
        <div id="scanResult">
            <p>請將條碼對準相機</p>
        </div>
        <button id="startScannerBtn">開始掃描</button>
        <button id="stopScannerBtn" class="hidden">停止掃描</button>
        <button id="scannerBackBtn">返回</button>
    </div>

<script>
// ================= 系統配置 =================
const SYSTEM_CONFIG = {
    version: "1.7.0",
    lastUpdate: "2023-11-25",
    configUrl: "http://192.168.50.1/vip_system_config.json",
    dataUrl: "http://192.168.50.1/vip_system_data.json",
    syncUrl: "http://192.168.50.1/vip_system_sync.php"
};

// API 配置
const API_CONFIG = {
    newsApiKey: "pub_77914c9ab741571647f817116519227c8df64",
    weatherApiKey: "f08876bf13681726c0c84bbb5af68d3e",
    newsApiUrl: "https://newsdata.io/api/1/news?apikey=",
    weatherApiUrl: "https://api.openweathermap.org/data/2.5/forecast?q=Taipei&units=metric&lang=zh_tw&appid="
};

// 台灣節慶日期 (月份是0-11)
const TAIWAN_HOLIDAYS = [
    { name: "元旦", date: new Date(new Date().getFullYear(), 0, 1) },
    { name: "春節", date: new Date(new Date().getFullYear(), 1, 10) }, // 示例日期
    { name: "清明節", date: new Date(new Date().getFullYear(), 3, 4) },
    { name: "4/11節慶", date: new Date(new Date().getFullYear(), 3, 11) }, // 新增4/11節慶
    { name: "端午節", date: new Date(new Date().getFullYear(), 5, 14) }, // 示例日期
    { name: "中秋節", date: new Date(new Date().getFullYear(), 8, 29) }, // 示例日期
    { name: "雙十節", date: new Date(new Date().getFullYear(), 9, 10) }
];

// 發票獎項配置
const INVOICE_PRIZES = {
    "特別獎": { amount: 10000000, probability: 0.000001 },
    "特獎": { amount: 2000000, probability: 0.000005 },
    "頭獎": { amount: 200000, probability: 0.00001 },
    "二獎": { amount: 40000, probability: 0.00005 },
    "三獎": { amount: 10000, probability: 0.0001 },
    "四獎": { amount: 4000, probability: 0.001 },
    "五獎": { amount: 1000, probability: 0.01 },
    "六獎": { amount: 200, probability: 0.1 }
};

// ================= VIP等級系統 =================
// 普通用戶等級 (0-99,999點) 共500級，每級200點
const NORMAL_LEVELS = [];
for (let i = 0; i < 500; i++) {
    const points = i * 200;
    let name = "";
    
    // 特殊名稱等級
    switch(i) {
        case 0: name = "戰場菜鳥"; break;
        case 1: name = "繃帶實習生"; break;
        case 2: name = "手槍新手"; break;
        case 3: name = "彈殼收集者"; break;
        case 4: name = "戰術蹲伏者"; break;
        case 5: name = "能量飲料試喝員"; break;
        case 6: name = "防彈背心學徒"; break;
        case 7: name = "紅點鏡體驗者"; break;
        case 8: name = "急救包實習生"; break;
        case 9: name = "煙霧彈投擲手"; break;
        case 495: name = "戰術大師候選人"; break;
        case 496: name = "空投追蹤者"; break;
        case 497: name = "決賽圈觀察員"; break;
        case 498: name = "戰場生存專家"; break;
        case 499: name = "準VIP挑戰者"; break;
        default: name = `等級 ${i+1}`;
    }
    
    NORMAL_LEVELS.push({
        level: i,
        name: name,
        points: points,
        color: i < 100 ? "#000000" : 
               i < 200 ? "#2ecc71" : 
               i < 300 ? "#3498db" : 
               i < 400 ? "#9b59b6" : "#e67e22",
        emoji: i < 100 ? "👤" : 
               i < 200 ? "👍" : 
               i < 300 ? "⭐" : 
               i < 400 ? "🌟" : "💎",
        discount: 1 - (i * 0.0002),
        scratchPrice: 20 - Math.floor(i / 25)
    });
}

// VIP等級 (100,000點起) 共100級，每級100,000點
const VIP_LEVELS = [];
for (let i = 0; i < 100; i++) {
    const points = 100000 + (i * 100000);
    let name = "";
    let group = "";
    
    // 分組和命名
    if (i < 10) {
        group = "基礎特種兵";
        switch(i) {
            case 0: name = "防彈衣新兵"; break;
            case 1: name = "空投追蹤者"; break;
            case 2: name = "止血帶醫護兵"; break;
            case 3: name = "戰術頭盔偵察兵"; break;
            case 4: name = "能量飲料補給官"; break;
            case 5: name = "八倍鏡狙擊學徒"; break;
            case 6: name = "破片手榴彈專家"; break;
            case 7: name = "平底鍋近戰士"; break;
            case 8: name = "戰術背包運輸官"; break;
            case 9: name = "消音器潛行兵"; break;
        }
    } else if (i < 20) {
        group = "進階突擊手";
        switch(i) {
            case 10: name = "快速彈匣突擊兵"; break;
            case 11: name = "燃燒瓶火焰兵"; break;
            case 12: name = "醫療箱急救官"; break;
            case 13: name = "紅點瞄準突擊手"; break;
            case 14: name = "戰術槍托工程師"; break;
            case 15: name = "垂直握把穩定兵"; break;
            case 16: name = "擴容彈匣火力手"; break;
            case 17: name = "戰術靴疾行兵"; break;
            case 18: name = "戰術手套攀爬者"; break;
            case 19: name = "戰術護膝潛伏者"; break;
        }
    } else if (i < 30) {
        group = "精英狙擊手";
        switch(i) {
            case 20: name = "六倍鏡狙擊手"; break;
            case 21: name = "栓狙大師"; break;
            case 22: name = "消焰器隱蔽者"; break;
            case 23: name = "戰術掩體建造者"; break;
            case 24: name = "高倍鏡觀察員"; break;
            case 25: name = "戰術趴射專家"; break;
            case 26: name = "戰術換彈達人"; break;
            case 27: name = "戰術腰射王者"; break;
            case 28: name = "戰術閃身槍高手"; break;
            case 29: name = "戰術預瞄宗師"; break;
        }
    } else if (i < 40) {
        group = "特種戰術專家";
        switch(i) {
            case 30: name = "戰術煙霧掩護官"; break;
            case 31: name = "戰術閃光突襲者"; break;
            case 32: name = "戰術震爆彈專家"; break;
            case 33: name = "戰術燃燒瓶指揮官"; break;
            case 34: name = "戰術破片手雷大師"; break;
            case 35: name = "戰術投擲物宗師"; break;
            case 36: name = "戰術近戰格鬥家"; break;
            case 37: name = "戰術載具駕駛員"; break;
            case 38: name = "戰術摩托車特技手"; break;
            case 39: name = "戰術吉普車指揮官"; break;
        }
    } else if (i < 50) {
        group = "戰場指揮官";
        switch(i) {
            case 40: name = "戰術空投召喚師"; break;
            case 41: name = "戰術信號槍專家"; break;
            case 42: name = "戰術轟炸區預判者"; break;
            case 43: name = "戰術毒圈計算師"; break;
            case 44: name = "戰術決賽圈主宰"; break;
            case 45: name = "戰術四人小隊隊長"; break;
            case 46: name = "戰術救援專家"; break;
            case 47: name = "戰術火力壓制者"; break;
            case 48: name = "戰術戰地工程師"; break;
            case 49: name = "戰術戰場元帥"; break;
        }
    } else if (i < 60) {
        group = "傳奇特戰兵";
        switch(i) {
            case 50: name = "戰術吉利服獵人"; break;
            case 51: name = "戰術潛行暗殺者"; break;
            case 52: name = "戰術夜視儀特工"; break;
            case 53: name = "戰術全自動掃射手"; break;
            case 54: name = "戰術單發狙擊王者"; break;
            case 55: name = "戰術霰彈槍近戰神"; break;
            case 56: name = "戰術衝鋒槍速射王"; break;
            case 57: name = "戰術輕機槍火力王"; break;
            case 58: name = "戰術十字弩暗殺者"; break;
            case 59: name = "戰術全能武器大師"; break;
        }
    } else if (i < 70) {
        group = "戰場傳奇";
        switch(i) {
            case 60: name = "戰術絕地求生者"; break;
            case 61: name = "戰術吃雞王者"; break;
            case 62: name = "戰術不死戰神"; break;
            case 63: name = "戰術零傷通關者"; break;
            case 64: name = "戰術單人四排冠軍"; break;
            case 65: name = "戰術全圖追殺者"; break;
            case 66: name = "戰術無傷滅隊王"; break;
            case 67: name = "戰術終極生存者"; break;
            case 68: name = "戰術不敗傳說"; break;
            case 69: name = "戰術絕地之神"; break;
        }
    } else if (i < 80) {
        group = "至尊戰神";
        switch(i) {
            case 70: name = "戰術戰場主宰者"; break;
            case 71: name = "戰術殺戮機器"; break;
            case 72: name = "戰術無敵兵王"; break;
            case 73: name = "戰術終極獵手"; break;
            case 74: name = "戰術戰爭領主"; break;
            case 75: name = "戰術毀滅者"; break;
            case 76: name = "戰術死神"; break;
            case 77: name = "戰術修羅"; break;
            case 78: name = "戰術滅世者"; break;
            case 79: name = "戰術終極戰神"; break;
        }
    } else if (i < 90) {
        group = "神話級特種兵";
        switch(i) {
            case 80: name = "戰術天選之人"; break;
            case 81: name = "戰術天命之子"; break;
            case 82: name = "戰術不滅戰魂"; break;
            case 83: name = "戰術傳奇兵王"; break;
            case 84: name = "戰術神級指揮官"; break;
            case 85: name = "戰術不朽戰神"; break;
            case 86: name = "戰術終極兵皇"; break;
            case 87: name = "戰術弒神者"; break;
            case 88: name = "戰術滅世戰神"; break;
            case 89: name = "戰術絕地至尊"; break;
        }
    } else {
        group = "終極神話";
        switch(i) {
            case 90: name = "戰術萬人敵"; break;
            case 91: name = "戰術不敗神話"; break;
            case 92: name = "戰術弒天戰神"; break;
            case 93: name = "戰術滅世之神"; break;
            case 94: name = "戰術終極殺戮者"; break;
            case 95: name = "戰術無上兵主"; break;
            case 96: name = "戰術絕地帝王"; break;
            case 97: name = "戰術修羅戰神"; break;
            case 98: name = "戰術滅界主宰"; break;
            case 99: name = "戰術終極至尊神"; break;
        }
    }
    
    VIP_LEVELS.push({
        level: i + 500, // 從500開始
        name: `VIP ${i+1} ${name}`,
        points: points,
        color: i < 10 ? "#cd7f32" : // 銅
               i < 20 ? "#c0c0c0" : // 銀
               i < 30 ? "#ffd700" : // 金
               i < 40 ? "#e5e4e2" : // 白金
               i < 50 ? "#b9f2ff" : // 鑽石
               i < 60 ? "#000000" : // 黑金
               i < 70 ? "#ff0000" : // 紅
               i < 80 ? "#0000ff" : // 藍
               i < 90 ? "#800080" : // 紫
                        "#000000", // 黑
        emoji: i < 10 ? "🥉" : 
               i < 20 ? "🥈" : 
               i < 30 ? "🥇" : 
               i < 40 ? "💠" : 
               i < 50 ? "💎" : 
               i < 60 ? "♠️" : 
               i < 70 ? "❤️" : 
               i < 80 ? "🔵" : 
               i < 90 ? "🟣" : 
                        "⚫",
        discount: 0.8 - (i * 0.002),
        scratchPrice: 10 - Math.floor(i / 10),
        group: group
    });
}

// 合併所有等級
const ALL_LEVELS = [...NORMAL_LEVELS, ...VIP_LEVELS];

// 可兌換商品 (初始數據)
let REDEEM_ITEMS = [
    { id: 1, name: "咖啡券", cost: 50, vipOnly: false },
    { id: 2, name: "午餐券", cost: 100, vipOnly: false },
    { id: 3, name: "電影票", cost: 200, vipOnly: false },
    { id: 4, name: "VIP專屬禮盒", cost: 500, vipOnly: true },
    { id: 5, name: "高級餐廳券", cost: 1000, vipOnly: true },
    { id: 6, name: "VIP家務券", cost: 800, vipOnly: true }
];

// 兌換碼 (初始數據)
let REDEEM_CODES = [
    { code: "WELCOME100", points: 100, usedBy: [] },
    { code: "VIP500", points: 500, usedBy: [], vipOnly: true }
];

// 用戶數據
let users = JSON.parse(localStorage.getItem('vipSystemUsers')) || {
    "vip8888": { password: "vip8888", email: "vip8888@vip.com", points: 50000, vipLevel: 1, lastCheckIn: null },
    "001": { password: "001", email: "001@example.com", points: 10000000000000000000, vipLevel: 0, lastCheckIn: null },
    "002": { password: "002", email: "admin@example.com", points: 0, isAdmin: true },
    "test1": { password: "123", email: "test1@example.com", points: 5000, vipLevel: 0, lastCheckIn: null },
    "test2": { password: "123", email: "test2@example.com", points: 15000, vipLevel: 1, lastCheckIn: null },
    "test3": { password: "123", email: "test3@example.com", points: 50000, vipLevel: 3, lastCheckIn: null },
    "test4": { password: "123", email: "test4@example.com", points: 150000, vipLevel: 6, lastCheckIn: null },
    "test5": { password: "123", email: "test5@example.com", points: 500000, vipLevel: 9, lastCheckIn: null }
};

// 公告數據
let announcements = JSON.parse(localStorage.getItem('vipSystemAnnouncements')) || [
    { id: 1, content: "歡迎使用VIP系統！", date: "2023-11-01T10:00:00" },
    { id: 2, content: "系統將於每週三進行例行維護", date: "2023-11-15T14:30:00" }
];

let currentUser = null;
let cart = [];
let aiChatHistory = [];
let lastCompensationTime = null;
let scannerInterval = null;

// ================= 新聞功能 =================
function fetchNews() {
    const url = `${API_CONFIG.newsApiUrl}${API_CONFIG.newsApiKey}&country=tw&language=zh`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.results && data.results.length > 0) {
                displayNews(data.results.slice(0, 5)); // 只顯示前5條新聞
            } else {
                document.getElementById('newsList').innerHTML = "<p>暫無最新新聞</p>";
            }
        })
        .catch(error => {
            console.error("獲取新聞失敗:", error);
            document.getElementById('newsList').innerHTML = "<p>無法加載新聞</p>";
        });
}

function displayNews(newsItems) {
    const newsList = document.getElementById('newsList');
    newsList.innerHTML = '';
    
    newsItems.forEach(news => {
        const newsItem = document.createElement('div');
        newsItem.className = 'news-item';
        
        const title = news.title || "無標題";
        const source = news.source_id || "未知來源";
        const link = news.link ? `<a href="${news.link}" target="_blank">閱讀更多</a>` : "";
        const image = news.image_url ? `<img src="${news.image_url}" style="max-width:100%; margin-top:5px;">` : "";
        
        newsItem.innerHTML = `
            <div class="news-title">${title}</div>
            <div class="news-source">來源: ${source}</div>
            ${image}
            <div style="margin-top:5px;">${link}</div>
        `;
        
        newsList.appendChild(newsItem);
    });
}

// ================= 天氣功能 =================
function fetchWeather() {
    const url = `${API_CONFIG.weatherApiUrl}${API_CONFIG.weatherApiKey}`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.list && data.list.length > 0) {
                displayWeather(data.list);
            } else {
                document.getElementById('weatherList').innerHTML = "<p>暫無天氣預報</p>";
            }
        })
        .catch(error => {
            console.error("獲取天氣失敗:", error);
            document.getElementById('weatherList').innerHTML = "<p>無法加載天氣預報</p>";
        });
}

function displayWeather(weatherData) {
    const weatherList = document.getElementById('weatherList');
    weatherList.innerHTML = '';
    
    // 只顯示今天和未來3天的預報
    const today = new Date();
    const forecastDays = [];
    
    for (let i = 0; i < 4; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() + i);
        forecastDays.push(date.toDateString());
    }
    
    // 過濾出每天中午的天氣數據
    const dailyForecasts = {};
    
    weatherData.forEach(item => {
        const date = new Date(item.dt * 1000).toDateString();
        const time = new Date(item.dt * 1000).getHours();
        
        if (forecastDays.includes(date) && time >= 11 && time <= 13) {
            dailyForecasts[date] = item;
        }
    });
    
    // 顯示天氣預報
    forecastDays.forEach(date => {
        if (dailyForecasts[date]) {
            const forecast = dailyForecasts[date];
            const weatherItem = document.createElement('div');
            weatherItem.className = 'weather-item';
            
            const dateStr = new Date(date).toLocaleDateString('zh-TW', { 
                month: 'short', 
                day: 'numeric', 
                weekday: 'short' 
            });
            
            const temp = Math.round(forecast.main.temp);
            const description = forecast.weather[0].description;
            const icon = `https://openweathermap.org/img/wn/${forecast.weather[0].icon}@2x.png`;
            
            weatherItem.innerHTML = `
                <div class="weather-date">${dateStr}</div>
                <div><img src="${icon}" alt="${description}"></div>
                <div class="weather-temp">${temp}°C</div>
                <div class="weather-desc">${description}</div>
            `;
            
            weatherList.appendChild(weatherItem);
        }
    });
}

// ================= 發票功能 =================
function generateInvoiceNumber() {
    // 產生隨機發票號碼 (格式: 2位英文字母 + 8位數字)
    const letters = 'ABCDEFGHJKLMNPQRSTUVXYWZ';
    const letter1 = letters[Math.floor(Math.random() * letters.length)];
    const letter2 = letters[Math.floor(Math.random() * letters.length)];
    const numbers = Math.floor(10000000 + Math.random() * 90000000);
    return `${letter1}${letter2}${numbers}`;
}

function checkInvoicePrize(invoiceNumber) {
    // 檢查是否為中獎發票 (模擬)
    const random = Math.random();
    let prize = null;
    
    for (const [name, config] of Object.entries(INVOICE_PRIZES)) {
        if (random < config.probability) {
            prize = { name, amount: config.amount };
            break;
        }
    }
    
    return prize;
}

function checkAllInvoices() {
    // 檢查今天是否是奇數月的25號
    const today = new Date();
    const month = today.getMonth() + 1; // 月份是0-11
    const date = today.getDate();
    
    if (month % 2 === 1 && date === 25) {
        // 是奇數月的25號，執行自動兌獎
        if (currentUser && currentUser.invoices) {
            let totalPrize = 0;
            
            currentUser.invoices.forEach(invoice => {
                if (!invoice.checked) {
                    const prize = checkInvoicePrize(invoice.number);
                    if (prize) {
                        invoice.prize = prize;
                        totalPrize += prize.amount;
                    }
                    invoice.checked = true;
                    invoice.checkDate = new Date().toISOString();
                }
            });
            
            if (totalPrize > 0) {
                currentUser.points += totalPrize;
                users[currentUser.username] = currentUser;
                localStorage.setItem('vipSystemUsers', JSON.stringify(users));
                
                addAnnouncementFromSystem(`發票兌獎結果：恭喜您獲得 ${totalPrize} 點獎勵！`);
                
                // 同步到伺服器
                syncToServer();
            }
        }
    }
}

function showInvoices() {
    document.getElementById('vipContainer').classList.add('hidden');
    document.getElementById('invoiceContainer').classList.remove('hidden');
    
    const container = document.getElementById('invoiceList');
    container.innerHTML = '';
    
    if (!currentUser.invoices || currentUser.invoices.length === 0) {
        container.innerHTML = "<p>沒有發票記錄</p>";
        return;
    }
    
    currentUser.invoices.forEach((invoice, index) => {
        const invoiceDiv = document.createElement('div');
        invoiceDiv.className = 'invoice-container';
        
        const date = new Date(invoice.date);
        const formattedDate = date.toLocaleString('zh-TW');
        
        let prizeInfo = '';
        if (invoice.prize) {
            prizeInfo = `<p class="invoice-prize">中獎: ${invoice.prize.name} ${invoice.prize.amount} 點</p>`;
        } else if (invoice.checked) {
            prizeInfo = `<p>未中獎</p>`;
        } else {
            prizeInfo = `<p>等待兌獎 (奇數月25號自動兌獎)</p>`;
        }
        
        invoiceDiv.innerHTML = `
            <h3>發票 #${index + 1}</h3>
            <p>發票號碼: ${invoice.number}</p>
            <p>日期: ${formattedDate}</p>
            <p>消費金額: ${invoice.amount} 點</p>
            ${prizeInfo}
        `;
        
        container.appendChild(invoiceDiv);
    });
}

// ================= 條碼掃描功能 =================
function initBarcodeScanner() {
    document.getElementById('startScannerBtn').addEventListener('click', startScanner);
    document.getElementById('stopScannerBtn').addEventListener('click', stopScanner);
    document.getElementById('scannerBackBtn').addEventListener('click', () => {
        stopScanner();
        backToVipPage();
    });
}

function startScanner() {
    const video = document.getElementById('scannerVideo');
    const canvas = document.getElementById('scannerCanvas');
    const ctx = canvas.getContext('2d');
    
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(function(stream) {
            video.srcObject = stream;
            video.play();
            
            document.getElementById('startScannerBtn').classList.add('hidden');
            document.getElementById('stopScannerBtn').classList.remove('hidden');
            
            scannerInterval = setInterval(() => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                try {
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    
                    if (code) {
                        processScannedBarcode(code.data);
                    }
                } catch (e) {
                    console.error("掃描錯誤:", e);
                }
            }, 500);
        })
        .catch(function(err) {
            console.error("無法訪問相機:", err);
            alert("無法訪問相機，請確保已授予相機權限");
        });
}

function stopScanner() {
    const video = document.getElementById('scannerVideo');
    if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
    }
    clearInterval(scannerInterval);
    document.getElementById('startScannerBtn').classList.remove('hidden');
    document.getElementById('stopScannerBtn').classList.add('hidden');
}

function processScannedBarcode(barcodeData) {
    // 驗證條碼格式
    if (!barcodeData.startsWith("VIPCHECKOUT:")) {
        document.getElementById('scanResult').innerHTML = "<p style='color:red'>無效條碼</p>";
        return;
    }
    
    // 解析條碼數據
    const parts = barcodeData.split(':');
    const username = parts[1];
    const timestamp = parseInt(parts[2]);
    const points = parseInt(parts[3]);
    
    // 檢查條碼是否已使用
    if (users[username].usedBarcodes && users[username].usedBarcodes.includes(barcodeData)) {
        document.getElementById('scanResult').innerHTML = "<p style='color:red'>此條碼已使用</p>";
        return;
    }
    
    // 標記條碼為已使用
    if (!users[username].usedBarcodes) {
        users[username].usedBarcodes = [];
    }
    users[username].usedBarcodes.push(barcodeData);
    
    // 更新收據狀態
    if (users[username].receipts) {
        const receipt = users[username].receipts.find(r => r.id === barcodeData);
        if (receipt) {
            receipt.used = true;
        }
    }
    
    // 同步到本地存儲
    localStorage.setItem('vipSystemUsers', JSON.stringify(users));
    
    // 同步到伺服器
    syncToServer();
    
    document.getElementById('scanResult').innerHTML = `
        <p style='color:green'>掃描成功！</p>
        <p>用戶: ${username}</p>
        <p>時間: ${new Date(timestamp).toLocaleString()}</p>
        <p>點數: ${points}</p>
    `;
    
    // 3秒後重置掃描結果
    setTimeout(() => {
        document.getElementById('scanResult').innerHTML = "<p>請將條碼對準相機</p>";
    }, 3000);
}

// ================= 收件功能 =================
function showReceipts() {
    document.getElementById('vipContainer').classList.add('hidden');
    document.getElementById('receiptContainer').classList.remove('hidden');
    
    const container = document.getElementById('receiptList');
    container.innerHTML = '';
    
    if (!currentUser.receipts || currentUser.receipts.length === 0) {
        container.innerHTML = "<p>沒有收件記錄</p>";
        return;
    }
    
    currentUser.receipts.forEach((receipt, index) => {
        const receiptDiv = document.createElement('div');
        receiptDiv.className = 'cart-item';
        
        const date = new Date(receipt.date);
        const formattedDate = date.toLocaleString('zh-TW');
        
        receiptDiv.innerHTML = `
            <h3>收據 #${index + 1}</h3>
            <p>日期: ${formattedDate}</p>
            <p>狀態: ${receipt.used ? '<span style="color:red">已使用</span>' : '<span style="color:green">未使用</span>'}</p>
            <p>總點數: ${receipt.total}</p>
            <div id="barcode-${receipt.id}"></div>
            ${receipt.used ? '' : '<p>請出示此條碼給管理員掃描</p>'}
        `;
        
        container.appendChild(receiptDiv);
        
        // 生成條碼
        JsBarcode(`#barcode-${receipt.id}`, receipt.id, {
            format: "CODE128",
            displayValue: true,
            fontSize: 16,
            lineColor: "#000",
            width: 2,
            height: 50
        });
    });
}

// ================= 同步功能 =================
function syncToServer() {
    fetch('http://192.168.50.1/sync', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            users: users,
            items: REDEEM_ITEMS,
            codes: REDEEM_CODES,
            announcements: announcements,
            version: SYSTEM_CONFIG.version
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log("同步成功:", data);
    })
    .catch(error => {
        console.error("同步錯誤:", error);
    });
}

function syncFromServer() {
    fetch('http://192.168.50.1/sync')
    .then(response => response.json())
    .then(data => {
        if (data.version > SYSTEM_CONFIG.version) {
            // 更新本地數據
            users = data.users || users;
            REDEEM_ITEMS = data.items || REDEEM_ITEMS;
            REDEEM_CODES = data.codes || REDEEM_CODES;
            announcements = data.announcements || announcements;
            
            // 保存到本地存儲
            localStorage.setItem('vipSystemUsers', JSON.stringify(users));
            localStorage.setItem('vipSystemItems', JSON.stringify(REDEEM_ITEMS));
            localStorage.setItem('vipSystemCodes', JSON.stringify(REDEEM_CODES));
            localStorage.setItem('vipSystemAnnouncements', JSON.stringify(announcements));
            
            // 更新界面
            if (currentUser) {
                currentUser = users[currentUser.username] || currentUser;
                updateVipDisplay();
                updateAnnouncements();
            }
            
            console.log("數據同步完成");
        }
    })
    .catch(error => {
        console.error("同步錯誤:", error);
    });
}

// ================= 節慶兌換碼功能 =================
function checkHolidayCodes() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    for (const holiday of TAIWAN_HOLIDAYS) {
        const holidayDate = new Date(holiday.date);
        holidayDate.setHours(0, 0, 0, 0);
        
        // 檢查節慶當天及前後一天
        const dayBefore = new Date(holidayDate);
        dayBefore.setDate(holidayDate.getDate() - 1);
        
        const dayAfter = new Date(holidayDate);
        dayAfter.setDate(holidayDate.getDate() + 1);
        
        if (today.getTime() === holidayDate.getTime() || 
            today.getTime() === dayBefore.getTime() || 
            today.getTime() === dayAfter.getTime()) {
            
            // 生成節慶兌換碼
            const holidayCode = `HOLIDAY${holiday.name.replace(/\s+/g, '')}${Math.floor(1000 + Math.random() * 9000)}`;
            
            // 檢查是否已存在相同的兌換碼
            const existingCode = REDEEM_CODES.find(c => c.code === holidayCode);
            if (!existingCode) {
                const points = Math.floor(500 + Math.random() * 1500); // 500-2000點
                REDEEM_CODES.push({
                    code: holidayCode,
                    points: points,
                    usedBy: [],
                    isHoliday: true
                });
                
                // 發布公告
                addAnnouncementFromSystem(`節慶活動：${holiday.name}期間，輸入兌換碼 ${holidayCode} 可獲得 ${points} 點！`);
                
                // 同步到本地存儲
                localStorage.setItem('vipSystemCodes', JSON.stringify(REDEEM_CODES));
                
                // 同步到伺服器
                syncToServer();
            }
        }
    }
}

// ================= 公告功能 =================
function updateAnnouncements() {
    const announcementList = document.getElementById('announcementsList');
    announcementList.innerHTML = '';
    
    announcements.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    announcements.forEach(announcement => {
        const announcementDiv = document.createElement('div');
        announcementDiv.className = 'announcement-item';
        
        const date = new Date(announcement.date);
        const formattedDate = date.toLocaleString('zh-TW', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        announcementDiv.innerHTML = `
            <div class="announcement-content">${announcement.content}</div>
            <div class="announcement-date">${formattedDate}</div>
        `;
        announcementList.appendChild(announcementDiv);
    });
}

function loadAnnouncementManagement() {
    const container = document.getElementById('announcementListForManagement');
    container.innerHTML = '';
    
    announcements.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    announcements.forEach(announcement => {
        const announcementDiv = document.createElement('div');
        announcementDiv.className = 'announcement-item';
        
        const date = new Date(announcement.date);
        const formattedDate = date.toLocaleString('zh-TW', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        announcementDiv.innerHTML = `
            <div class="announcement-content">${announcement.content}</div>
            <div class="announcement-date">${formattedDate}</div>
            <button onclick="deleteAnnouncement(${announcement.id})">刪除</button>
        `;
        container.appendChild(announcementDiv);
    });
}

function addAnnouncement() {
    const content = document.getElementById('newAnnouncementContent').value.trim();
    if (!content) {
        alert("請輸入公告內容！");
        return;
    }
    
    const newId = announcements.length > 0 ? Math.max(...announcements.map(a => a.id)) + 1 : 1;
    const newAnnouncement = {
        id: newId,
        content: content,
        date: new Date().toISOString()
    };
    
    announcements.unshift(newAnnouncement);
    localStorage.setItem('vipSystemAnnouncements', JSON.stringify(announcements));
    
    document.getElementById('newAnnouncementContent').value = '';
    loadAnnouncementManagement();
    updateAnnouncements();
    
    // 同步到伺服器
    syncToServer();
}

function addAnnouncementFromSystem(content) {
    const newId = announcements.length > 0 ? Math.max(...announcements.map(a => a.id)) + 1 : 1;
    const newAnnouncement = {
        id: newId,
        content: content,
        date: new Date().toISOString(),
        isSystem: true
    };
    
    announcements.unshift(newAnnouncement);
    localStorage.setItem('vipSystemAnnouncements', JSON.stringify(announcements));
    updateAnnouncements();
    
    // 同步到伺服器
    syncToServer();
}

function deleteAnnouncement(id) {
    if (!confirm("確定要刪除此公告嗎？")) return;
    
    announcements = announcements.filter(a => a.id !== id);
    localStorage.setItem('vipSystemAnnouncements', JSON.stringify(announcements));
    
    loadAnnouncementManagement();
    updateAnnouncements();
    
    // 同步到伺服器
    syncToServer();
}

// ================= 兌換碼功能 =================
function redeemCode() {
    const codeInput = document.getElementById('redeemCodeInput').value.trim().toUpperCase();
    const resultDiv = document.getElementById('redeemCodeResult');
    
    if (!codeInput) {
        resultDiv.innerHTML = "<p style='color:red'>請輸入兌換碼</p>";
        return;
    }
    
    const redeemCode = REDEEM_CODES.find(c => c.code === codeInput);
    
    if (!redeemCode) {
        resultDiv.innerHTML = "<p style='color:red'>兌換碼無效</p>";
        return;
    }
    
    if (redeemCode.vipOnly && (!currentUser || currentUser.vipLevel <= 0)) {
        resultDiv.innerHTML = "<p style='color:red'>此兌換碼僅限VIP會員使用</p>";
        return;
    }
    
    if (redeemCode.usedBy.includes(currentUser.username)) {
        resultDiv.innerHTML = "<p style='color:red'>您已使用過此兌換碼</p>";
        return;
    }
    
    // 兌換成功
    currentUser.points += redeemCode.points;
    redeemCode.usedBy.push(currentUser.username);
    users[currentUser.username] = currentUser;
    
    localStorage.setItem('vipSystemUsers', JSON.stringify(users));
    localStorage.setItem('vipSystemCodes', JSON.stringify(REDEEM_CODES));
    
    resultDiv.innerHTML = `<p style='color:green'>兌換成功！獲得 ${redeemCode.points} 點</p>`;
    document.getElementById('redeemCodeInput').value = '';
    
    updateVipDisplay();
    
    // 同步到伺服器
    syncToServer();
}

function loadCodeManagement() {
    const container = document.getElementById('codeListForManagement');
    container.innerHTML = '';
    
    REDEEM_CODES.forEach(code => {
        const codeDiv = document.createElement('div');
        codeDiv.className = 'redeem-code-container';
        
        const usedCount = code.usedBy ? code.usedBy.length : 0;
        const isHoliday = code.isHoliday ? ' (節慶兌換碼)' : '';
        
        codeDiv.innerHTML = `
            <strong>${code.code}</strong> - ${code.points} 點${isHoliday}<br>
            已使用: ${usedCount} 次
            <button onclick="deleteCode('${code.code}')">刪除</button>
        `;
        container.appendChild(codeDiv);
    });
}

function addCode() {
    const codeValue = document.getElementById('newCodeValue').value.trim().toUpperCase();
    const codePoints = parseInt(document.getElementById('newCodePoints').value);
    
    if (!codeValue || isNaN(codePoints)) {
        alert("請填寫完整的兌換碼資訊！");
        return;
    }
    
    if (REDEEM_CODES.some(c => c.code === codeValue)) {
        alert("此兌換碼已存在！");
        return;
    }
    
    REDEEM_CODES.push({
        code: codeValue,
        points: codePoints,
        usedBy: []
    });
    
    localStorage.setItem('vipSystemCodes', JSON.stringify(REDEEM_CODES));
    
    document.getElementById('newCodeValue').value = '';
    document.getElementById('newCodePoints').value = '';
    loadCodeManagement();
    
    // 同步到伺服器
    syncToServer();
}

function deleteCode(code) {
    if (!confirm("確定要刪除此兌換碼嗎？")) return;
    
    REDEEM_CODES = REDEEM_CODES.filter(c => c.code !== code);
    localStorage.setItem('vipSystemCodes', JSON.stringify(REDEEM_CODES));
    loadCodeManagement();
    
    // 同步到伺服器
    syncToServer();
}

// ================= AI客服功能 =================
function sendAiMessage() {
    const userInput = document.getElementById('aiUserInput').value.trim();
    if (!userInput) return;
    
    // 添加用戶消息
    addAiMessage(userInput, true);
    document.getElementById('aiUserInput').value = '';
    
    // 模擬AI回應
    setTimeout(() => {
        let response = "";
        let giveCompensation = false;
        
        // 檢查是否已經獲得過今天的賠償
        const today = new Date().toDateString();
        const lastCompDay = lastCompensationTime ? new Date(lastCompensationTime).toDateString() : null;
        const alreadyCompensated = lastCompDay === today;
        
        // 簡單的關鍵詞匹配
        if ((userInput.includes("問題") || userInput.includes("錯誤") || userInput.includes("bug") || 
             userInput.includes("故障") || userInput.includes("補償")) && !alreadyCompensated) {
            response = "很抱歉給您帶來不便。我們已記錄您的問題，並將贈送您 500 點作為補償。";
            giveCompensation = true;
            
            // 記錄賠償時間
            lastCompensationTime = new Date().toISOString();
        } 
        else if (alreadyCompensated && (userInput.includes("問題") || userInput.includes("錯誤") || 
                userInput.includes("bug") || userInput.includes("故障") || userInput.includes("補償"))) {
            response = "我們今天已經為您提供過補償了。如有其他問題，請聯繫客服人員。";
        }
        else if (userInput.includes("謝謝") || userInput.includes("感謝")) {
            response = "感謝您的支持！如果有任何問題，請隨時聯繫我們。";
        }
        else if (userInput.includes("兌換碼")) {
            response = "您可以在VIP功能界面點擊「輸入兌換碼」來使用兌換碼。節慶期間會有特別兌換碼發放，請關注公告！";
        }
        else if (userInput.includes("刮刮樂")) {
            response = "刮刮樂遊戲可以讓您有機會贏得點數獎勵！獎勵點數為購買價格的0.5-5倍。";
        }
        else if (userInput.includes("等級") || userInput.includes("VIP")) {
            response = "VIP等級系統根據您的累積點數決定。點數越高，等級越高，享受的折扣和優惠也越多！";
        }
        else if (userInput.includes("條碼") || userInput.includes("收件")) {
            response = "購買商品後會生成專屬條碼，請在「查看收件」中查看您的條碼，並出示給管理員掃描。每個條碼只能使用一次。";
        }
        else if (userInput.includes("發票")) {
            response = "每次購買商品都會自動獲取一張發票，奇數月的25號系統會自動進行兌獎，中獎獎金會直接轉為點數存入您的帳戶。";
        }
        else {
            response = "感謝您的詢問。我們已收到您的消息，將盡快為您處理。";
        }
        
        addAiMessage(response, false);
        
        // 補償點數
        if (giveCompensation && currentUser) {
            currentUser.points += 500;
            users[currentUser.username] = currentUser;
            localStorage.setItem('vipSystemUsers', JSON.stringify(users));
            updateVipDisplay();
            
            // 同步到伺服器
            syncToServer();
        }
    }, 1000);
}

function addAiMessage(message, isUser) {
    const chatContainer = document.getElementById('aiChatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `ai-message ${isUser ? 'ai-user' : 'ai-bot'}`;
    messageDiv.textContent = message;
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    
    // 保存聊天記錄
    aiChatHistory.push({
        message: message,
        isUser: isUser,
        time: new Date().toISOString()
    });
}

// ================= 商品管理功能 =================
function loadItemManagement() {
    const container = document.getElementById('itemListForManagement');
    container.innerHTML = '';
    
    REDEEM_ITEMS.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'cart-item';
        
        itemDiv.innerHTML = `
            <strong>${item.name}</strong> - ${item.cost} 點
            ${item.vipOnly ? '(僅限VIP)' : ''}
            <button onclick="deleteItem(${item.id})">刪除</button>
        `;
        container.appendChild(itemDiv);
    });
}

function addItem() {
    const name = document.getElementById('newItemName').value.trim();
    const cost = parseInt(document.getElementById('newItemCost').value);
    const vipOnly = document.getElementById('newItemVipOnly').value === 'true';
    
    if (!name || isNaN(cost)) {
        alert("請填寫完整的商品資訊！");
        return;
    }
    
    const newId = REDEEM_ITEMS.length > 0 ? Math.max(...REDEEM_ITEMS.map(i => i.id)) + 1 : 1;
    
    REDEEM_ITEMS.push({
        id: newId,
        name: name,
        cost: cost,
        vipOnly: vipOnly
    });
    
    localStorage.setItem('vipSystemItems', JSON.stringify(REDEEM_ITEMS));
    
    document.getElementById('newItemName').value = '';
    document.getElementById('newItemCost').value = '';
    loadItemManagement();
    
    // 同步到伺服器
    syncToServer();
}

function deleteItem(id) {
    if (!confirm("確定要刪除此商品嗎？")) return;
    
    REDEEM_ITEMS = REDEEM_ITEMS.filter(i => i.id !== id);
    localStorage.setItem('vipSystemItems', JSON.stringify(REDEEM_ITEMS));
    loadItemManagement();
    
    // 同步到伺服器
    syncToServer();
}

// ================= 網路更新功能 =================
function checkForUpdates() {
    document.getElementById('updateStatus').textContent = "正在檢查更新...";
    document.getElementById('updateStatus').style.backgroundColor = "#fff3e0";
    
    // 模擬網路請求獲取配置
    setTimeout(() => {
        try {
            // 這裡實際應該使用fetch從SYSTEM_CONFIG.configUrl獲取數據
            // 以下是模擬數據
            const mockConfig = {
                version: "1.7.0",
                lastUpdate: "2023-11-25",
                announcements: ["新功能上線：發票兌獎系統", "新增自動兌獎功能"]
            };
            
            const mockData = {
                items: [
                    ...REDEEM_ITEMS,
                    { id: 7, name: "豪華SPA券", cost: 800, vipOnly: true },
                    { id: 8, name: "高爾夫體驗", cost: 1500, vipOnly: true }
                ],
                codes: [
                    ...REDEEM_CODES,
                    { code: "UPDATE2023", points: 300, usedBy: [] }
                ]
            };
            
            // 更新配置
            SYSTEM_CONFIG.version = mockConfig.version;
            SYSTEM_CONFIG.lastUpdate = mockConfig.lastUpdate;
            
            // 更新數據
            REDEEM_ITEMS = mockData.items;
            REDEEM_CODES = mockData.codes;
            
            // 添加新公告
            mockConfig.announcements.forEach(announcement => {
                addAnnouncementFromSystem(announcement);
            });
            
            document.getElementById('updateStatus').textContent = `已是最新版本 ${mockConfig.version}`;
            document.getElementById('updateStatus').style.backgroundColor = "#e6ffe6";
            
            // 更新用戶界面
            if (currentUser) {
                updateVipDisplay();
                updateAnnouncements();
            }
            
            // 保存更新後的數據到本地存儲
            localStorage.setItem('vipSystemConfig', JSON.stringify(SYSTEM_CONFIG));
            localStorage.setItem('vipSystemData', JSON.stringify({
                items: REDEEM_ITEMS,
                codes: REDEEM_CODES
            }));
            
            // 同步到伺服器
            syncToServer();
            
        } catch (error) {
            document.getElementById('updateStatus').textContent = "更新失敗: " + error.message;
            document.getElementById('updateStatus').style.backgroundColor = "#ffe6e6";
        }
    }, 1500);
}

// 從本地存儲加載更新
function loadUpdatesFromStorage() {
    const savedConfig = localStorage.getItem('vipSystemConfig');
    const savedData = localStorage.getItem('vipSystemData');
    const savedAnnouncements = localStorage.getItem('vipSystemAnnouncements');
    const savedCodes = localStorage.getItem('vipSystemCodes');
    
    if (savedConfig) {
        const config = JSON.parse(savedConfig);
        if (config.version > SYSTEM_CONFIG.version) {
            Object.assign(SYSTEM_CONFIG, config);
        }
    }
    
    if (savedData) {
        const data = JSON.parse(savedData);
        REDEEM_ITEMS = data.items || REDEEM_ITEMS;
        REDEEM_CODES = data.codes || REDEEM_CODES;
    }
    
    if (savedAnnouncements) {
        announcements = JSON.parse(savedAnnouncements);
    }
    
    if (savedCodes) {
        REDEEM_CODES = JSON.parse(savedCodes);
    }
}

// ================= 用戶界面功能 =================
function toggleVisibility(elementId, show) {
    document.getElementById(elementId).classList.toggle('hidden', !show);
}

function updateTime() {
    const now = new Date();
    const timeString = now.toLocaleString('zh-TW');
    document.querySelectorAll('#currentTime, #userTime').forEach(el => {
        if (el) el.textContent = timeString;
    });
    setTimeout(updateTime, 1000);
}

// ================= 用戶功能 =================
function login(username, password, isVip = false, isAdmin = false) {
    if (!username || !password) {
        document.getElementById('loginError').textContent = "請輸入帳號和密碼！";
        return false;
    }
    
    if (users[username] && users[username].password === password) {
        // 檢查VIP和管理員權限
        if ((isVip && users[username].vipLevel <= 0 && !users[username].isAdmin) || 
            (isAdmin && !users[username].isAdmin)) {
            document.getElementById('loginError').textContent = "權限不足！";
            return false;
        }
        
        currentUser = { username, ...users[username] };
        document.getElementById('loginOptionContainer').classList.add('hidden');
        document.getElementById('vipContainer').classList.remove('hidden');
        updateVipDisplay();
        updateAnnouncements();
        
        // 檢查發票兌獎
        checkAllInvoices();
        
        // 獲取新聞和天氣
        fetchNews();
        fetchWeather();
        
        // 如果是管理員，添加管理按鈕
        if (currentUser.isAdmin) {
            const levelDescription = document.getElementById('levelDescription');
            
            // 清除現有按鈕
            levelDescription.querySelectorAll('button').forEach(btn => btn.remove());
            
            // 公告管理按鈕
            const announcementButton = document.createElement('button');
            announcementButton.textContent = "公告管理";
            announcementButton.onclick = function() {
                document.getElementById('vipContainer').classList.add('hidden');
                document.getElementById('announcementManagementContainer').classList.remove('hidden');
                loadAnnouncementManagement();
            };
            levelDescription.appendChild(announcementButton);
            
            // 商品管理按鈕
            const itemButton = document.createElement('button');
            itemButton.textContent = "商品管理";
            itemButton.onclick = function() {
                document.getElementById('vipContainer').classList.add('hidden');
                document.getElementById('itemManagementContainer').classList.remove('hidden');
                loadItemManagement();
            };
            levelDescription.appendChild(itemButton);
            
            // 兌換碼管理按鈕
            const codeButton = document.createElement('button');
            codeButton.textContent = "兌換碼管理";
            codeButton.onclick = function() {
                document.getElementById('vipContainer').classList.add('hidden');
                document.getElementById('codeManagementContainer').classList.remove('hidden');
                loadCodeManagement();
            };
            levelDescription.appendChild(codeButton);
            
            // 條碼掃描按鈕
            const scanButton = document.createElement('button');
            scanButton.textContent = "條碼掃描";
            scanButton.onclick = function() {
                document.getElementById('vipContainer').classList.add('hidden');
                document.getElementById('barcodeScannerContainer').classList.remove('hidden');
                initBarcodeScanner();
            };
            levelDescription.appendChild(scanButton);
        }
        
        return true;
    } else {
        document.getElementById('loginError').textContent = "帳號或密碼錯誤！";
        return false;
    }
}

function register() {
    const username = document.getElementById('newUsername').value.trim();
    const password = document.getElementById('newPassword').value.trim();
    const email = document.getElementById('newEmail').value.trim();
    
    if (!username || !password || !email) {
        alert("請填寫所有欄位！");
        return;
    }
    
    if (users[username]) {
        alert("用戶名已存在！");
        return;
    }
    
    users[username] = { 
        password, 
        email,
        points: 0,
        vipLevel: 0,
        lastCheckIn: null
    };
    
    localStorage.setItem('vipSystemUsers', JSON.stringify(users));
    alert("註冊成功！");
    toggleVisibility('registerContainer', false);
    toggleVisibility('normalLoginContainer', true);
    
    // 同步到伺服器
    syncToServer();
}

function logout() {
    currentUser = null;
    document.getElementById('vipContainer').classList.add('hidden');
    document.getElementById('loginOptionContainer').classList.remove('hidden');
    document.getElementById('normalUsername').value = "";
    document.getElementById('normalPassword').value = "";
    document.getElementById('loginError').textContent = "";
}

function changePassword() {
    const oldPassword = document.getElementById('oldPassword').value.trim();
    const newPassword = document.getElementById('newPassword').value.trim();
    const confirmPassword = document.getElementById('confirmPassword').value.trim();
    
    if (!oldPassword || !newPassword || !confirmPassword) {
        alert("請填寫所有欄位！");
        return;
    }
    
    if (newPassword !== confirmPassword) {
        alert("新密碼與確認密碼不符！");
        return;
    }
    
    if (currentUser.password !== oldPassword) {
        alert("舊密碼錯誤！");
        return;
    }
    
    currentUser.password = newPassword;
    users[currentUser.username] = currentUser;
    localStorage.setItem('vipSystemUsers', JSON.stringify(users));
    alert("密碼更改成功！");
    toggleVisibility('changePasswordContainer', false);
    
    // 同步到伺服器
    syncToServer();
}

// ================= VIP功能 =================
function updateVipDisplay() {
    if (!currentUser) return;
    
    const userLevel = getUserLevel(currentUser.points);
    const nextLevel = ALL_LEVELS.find(level => level.level === userLevel.level + 1);
    
    document.getElementById('vipTitle').textContent = 
        `${userLevel.emoji} ${userLevel.name} ${currentUser.username} 您好！`;
    
    document.getElementById('vipLevelDisplay').innerHTML = `
        <span style="color: ${userLevel.color}">${userLevel.name} (等級 ${userLevel.level})</span><br>
        當前點數: ${currentUser.points.toLocaleString()}
    `;
    
    if (nextLevel) {
        const progress = ((currentUser.points - userLevel.points) / (nextLevel.points - userLevel.points)) * 100;
        document.getElementById('pointsProgress').style.width = `${progress}%`;
        document.getElementById('pointsProgress').textContent = `${Math.floor(progress)}%`;
        
        document.getElementById('levelDescription').innerHTML = `
            <strong>下一等級:</strong> ${nextLevel.name} (需要 ${(nextLevel.points - currentUser.points).toLocaleString()} 點)<br>
            <strong>折扣優惠:</strong> ${Math.floor(userLevel.discount * 100)}折<br>
            <strong>刮刮樂價格:</strong> ${userLevel.scratchPrice} 點
        `;
        
        document.getElementById('scratchCardPrice').textContent = userLevel.scratchPrice;
    } else {
        document.getElementById('pointsProgress').style.width = "100%";
        document.getElementById('pointsProgress').textContent = "MAX";
        document.getElementById('levelDescription').innerHTML = `
            <strong>您已達到最高等級！</strong><br>
            <strong>折扣優惠:</strong> ${Math.floor(userLevel.discount * 100)}折
        `;
    }
    
    // 更新簽到按鈕狀態
    const checkInBtn = document.getElementById('checkInBtn');
    if (isCheckedInToday()) {
        checkInBtn.disabled = true;
        checkInBtn.textContent = "今日已簽到";
    } else {
        checkInBtn.disabled = false;
        checkInBtn.textContent = `每日簽到 (100 點)`; // 修改為固定100點
    }
}

function getUserLevel(points) {
    for (let i = ALL_LEVELS.length - 1; i >= 0; i--) {
        if (points >= ALL_LEVELS[i].points) {
            return ALL_LEVELS[i];
        }
    }
    return ALL_LEVELS[0];
}

function isCheckedInToday() {
    if (!currentUser.lastCheckIn) return false;
    const lastCheckIn = new Date(currentUser.lastCheckIn);
    const today = new Date();
    return lastCheckIn.toDateString() === today.toDateString();
}

function vipCheckIn() {
    if (isCheckedInToday()) {
        alert("今日已簽到！");
        return;
    }
    
    const pointsToAdd = 100; // 修改為固定100點
    
    currentUser.points += pointsToAdd;
    currentUser.lastCheckIn = new Date().toISOString();
    currentUser.vipLevel = getUserLevel(currentUser.points).level;
    
    users[currentUser.username] = currentUser;
    localStorage.setItem('vipSystemUsers', JSON.stringify(users));
    
    updateVipDisplay();
    alert(`簽到成功！獲得 ${pointsToAdd.toLocaleString()} 點！`);
    
    // 同步到伺服器
    syncToServer();
}

// ================= 兌換商品功能 =================
function showRedeemItems() {
    const container = document.getElementById('redeemItemsList');
    container.innerHTML = "";
    
    REDEEM_ITEMS.forEach(item => {
        if (!item.vipOnly || (currentUser && currentUser.vipLevel > 0)) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'cart-item';
            itemDiv.innerHTML = `
                <strong>${item.name}</strong> - ${item.cost} 點
                <button class="addToCartBtn" data-id="${item.id}">加入購物車</button>
            `;
            container.appendChild(itemDiv);
        }
    });
    
    // 為所有加入購物車按鈕添加事件監聽
    document.querySelectorAll('.addToCartBtn').forEach(btn => {
        btn.addEventListener('click', function() {
            addToCart(parseInt(this.getAttribute('data-id')));
        });
    });
    
    updateCartDisplay();
}

function addToCart(itemId) {
    const item = REDEEM_ITEMS.find(i => i.id === itemId);
    if (!item) return;
    
    cart.push(item);
    updateCartDisplay();
}

function removeFromCart(index) {
    cart.splice(index, 1);
    updateCartDisplay();
}

function updateCartDisplay() {
    const container = document.getElementById('cartItems');
    container.innerHTML = "";
    
    if (cart.length === 0) {
        container.innerHTML = "<p>購物車是空的</p>";
        return;
    }
    
    let total = 0;
    const userLevel = getUserLevel(currentUser.points);
    
    cart.forEach((item, index) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'cart-item';
        const discountedPrice = Math.floor(item.cost * userLevel.discount);
        itemDiv.innerHTML = `
            <strong>${item.name}</strong> - 
            原價: ${item.cost} 點 | 
            折扣價: ${discountedPrice} 點
            <button class="removeFromCartBtn" data-index="${index}">移除</button>
        `;
        container.appendChild(itemDiv);
        total += discountedPrice;
    });
    
    // 為所有移除按鈕添加事件監聽
    document.querySelectorAll('.removeFromCartBtn').forEach(btn => {
        btn.addEventListener('click', function() {
            removeFromCart(parseInt(this.getAttribute('data-index')));
        });
    });
    
    const totalDiv = document.createElement('div');
    totalDiv.innerHTML = `<strong>總計: ${total} 點</strong>`;
    container.appendChild(totalDiv);
}

function checkout() {
    if (cart.length === 0) {
        alert("購物車是空的！");
        return;
    }
    
    const userLevel = getUserLevel(currentUser.points);
    let total = 0;
    
    cart.forEach(item => {
        total += Math.floor(item.cost * userLevel.discount);
    });
    
    if (currentUser.points < total) {
        alert("點數不足！");
        return;
    }
    
    currentUser.points -= total;
    
    // 生成條碼數據 (包含用戶名、時間戳和總點數)
    const barcodeData = `VIPCHECKOUT:${currentUser.username}:${new Date().getTime()}:${total}`;
    
    // 保存收件記錄
    if (!currentUser.receipts) {
        currentUser.receipts = [];
    }
    currentUser.receipts.push({
        id: barcodeData,
        items: [...cart],
        total: total,
        date: new Date().toISOString(),
        used: false
    });
    
    // 生成發票
    if (!currentUser.invoices) {
        currentUser.invoices = [];
    }
    currentUser.invoices.push({
        number: generateInvoiceNumber(),
        amount: total,
        date: new Date().toISOString(),
        checked: false
    });
    
    users[currentUser.username] = currentUser;
    localStorage.setItem('vipSystemUsers', JSON.stringify(users));
    
    // 顯示條碼
    const receiptContainer = document.getElementById('cartItems');
    const receiptDiv = document.createElement('div');
    receiptDiv.className = 'cart-item';
    receiptDiv.innerHTML = `
        <h3>收據 #${currentUser.receipts.length}</h3>
        <p>日期: ${new Date().toLocaleString()}</p>
        <p>總點數: ${total}</p>
        <div id="barcode-${barcodeData}"></div>
        <p>請出示此條碼給管理員掃描</p>
    `;
    receiptContainer.appendChild(receiptDiv);
    
    // 生成條碼
    JsBarcode(`#barcode-${barcodeData}`, barcodeData, {
        format: "CODE128",
        displayValue: true,
        fontSize: 16,
        lineColor: "#000",
        width: 2,
        height: 50
    });
    
    alert(`購買成功！扣除 ${total} 點\n條碼已生成，請出示給工作人員掃描。`);
    cart = [];
    updateCartDisplay();
    updateVipDisplay();
    
    // 同步到伺服器
    syncToServer();
}

// ================= 刮刮樂功能 =================
function playScratchCard() {
    const userLevel = getUserLevel(currentUser.points);
    const price = userLevel.scratchPrice;
    
    if (currentUser.points < price) {
        alert("點數不足！");
        return;
    }
    
    // 扣除點數
    currentUser.points -= price;
    
    // 隨機獎勵 (0.5x-5x價格)
    const rewardMultiplier = 0.5 + Math.random() * 4.5;
    const reward = Math.floor(price * rewardMultiplier);
    
    // 增加獎勵點數
    currentUser.points += reward;
    
    // 保存用戶數據
    users[currentUser.username] = currentUser;
    localStorage.setItem('vipSystemUsers', JSON.stringify(users));
    
    document.getElementById('scratchResult').innerHTML = `
        <h3>恭喜您！</h3>
        <p>獲得 ${reward} 點獎勵！</p>
        <p>當前點數: ${currentUser.points.toLocaleString()}</p>
    `;
    
    updateVipDisplay();
    
    // 同步到伺服器
    syncToServer();
}

// ================= VIP等級查看 =================
function viewAllLevels() {
    document.getElementById('vipContainer').classList.add('hidden');
    document.getElementById('allLevelsContainer').classList.remove('hidden');
    
    const container = document.getElementById('levelsList');
    container.innerHTML = "";
    
    // 顯示普通等級
    const normalLevelsDiv = document.createElement('div');
    normalLevelsDiv.innerHTML = `<h3>普通用戶（0 - 99,999點）｜500級</h3>`;
    container.appendChild(normalLevelsDiv);
    
    // 顯示特殊普通等級
    const specialNormalLevels = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 495, 496, 497, 498, 499];
    specialNormalLevels.forEach(i => {
        const level = NORMAL_LEVELS[i];
        const levelDiv = document.createElement('div');
        levelDiv.className = "level-description";
        levelDiv.style.borderLeft = `5px solid ${level.color}`;
        
        const isCurrentLevel = currentUser && getUserLevel(currentUser.points).level === level.level;
        
        levelDiv.innerHTML = `
            <strong style="color: ${level.color}">${level.emoji} ${level.name}</strong>
            ${isCurrentLevel ? '<span style="color:red"> (當前等級)</span>' : ''}<br>
            等級: ${level.level} | 需求點數: ${level.points.toLocaleString()}<br>
            折扣: ${Math.floor(level.discount * 100)}折 | 刮刮樂: ${level.scratchPrice} 點
        `;
        container.appendChild(levelDiv);
    });
    
    // 顯示VIP等級
    const vipLevelsDiv = document.createElement('div');
    vipLevelsDiv.innerHTML = `<h3 style="margin-top:20px;">VIP用戶（100,000點起）｜100級</h3>`;
    container.appendChild(vipLevelsDiv);
    
    // 顯示所有VIP等級
    VIP_LEVELS.forEach((level, i) => {
        const levelDiv = document.createElement('div');
        levelDiv.className = "level-description";
        levelDiv.style.borderLeft = `5px solid ${level.color}`;
        
        const isCurrentLevel = currentUser && getUserLevel(currentUser.points).level === level.level;
        
        // 每10級顯示分組標題
        if (i % 10 === 0) {
            const groupDiv = document.createElement('div');
            groupDiv.innerHTML = `<h4>${level.group}</h4>`;
            container.appendChild(groupDiv);
        }
        
        levelDiv.innerHTML = `
            <strong style="color: ${level.color}">${level.emoji} ${level.name}</strong>
            ${isCurrentLevel ? '<span style="color:red"> (當前等級)</span>' : ''}<br>
            等級: ${level.level} | 需求點數: ${level.points.toLocaleString()}<br>
            折扣: ${Math.floor(level.discount * 100)}折 | 刮刮樂: ${level.scratchPrice} 點
        `;
        container.appendChild(levelDiv);
    });
}

function backToVipPage() {
    // 隱藏所有功能區
    document.querySelectorAll('.container').forEach(container => {
        if (container.id !== 'vipContainer' && container.id !== 'loginOptionContainer') {
            container.classList.add('hidden');
        }
    });
    
    // 顯示VIP主界面
    document.getElementById('vipContainer').classList.remove('hidden');
}

function backToLoginOptions() {
    // 隱藏所有容器
    document.querySelectorAll('.container').forEach(container => {
        container.classList.add('hidden');
    });
    
    // 顯示登錄選項
    document.getElementById('loginOptionContainer').classList.remove('hidden');
}

// ================= 初始化事件監聽 =================
function initEventListeners() {
    // 登錄選項按鈕
    document.getElementById('vipLoginBtn').addEventListener('click', () => {
        toggleVisibility('loginOptionContainer', false);
        toggleVisibility('vipLoginContainer', true);
    });
    document.getElementById('normalLoginBtn').addEventListener('click', () => {
        toggleVisibility('loginOptionContainer', false);
        toggleVisibility('normalLoginContainer', true);
    });
    document.getElementById('adminLoginBtn').addEventListener('click', () => {
        toggleVisibility('loginOptionContainer', false);
        toggleVisibility('adminLoginContainer', true);
    });
    
    // 返回按鈕
    document.getElementById('vipBackBtn').addEventListener('click', backToLoginOptions);
    document.getElementById('normalBackBtn').addEventListener('click', backToLoginOptions);
    document.getElementById('adminBackBtn').addEventListener('click', backToLoginOptions);
    document.getElementById('registerBackBtn').addEventListener('click', () => {
        toggleVisibility('registerContainer', false);
        toggleVisibility('normalLoginContainer', true);
    });
    document.getElementById('redeemBackBtn').addEventListener('click', backToVipPage);
    document.getElementById('scratchBackBtn').addEventListener('click', backToVipPage);
    document.getElementById('changePasswordBackBtn').addEventListener('click', backToVipPage);
    document.getElementById('levelsBackBtn').addEventListener('click', backToVipPage);
    document.getElementById('announcementBackBtn').addEventListener('click', backToVipPage);
    document.getElementById('redeemCodeBackBtn').addEventListener('click', backToVipPage);
    document.getElementById('aiChatBackBtn').addEventListener('click', backToVipPage);
    document.getElementById('itemBackBtn').addEventListener('click', backToVipPage);
    document.getElementById('codeBackBtn').addEventListener('click', backToVipPage);
    document.getElementById('receiptBackBtn').addEventListener('click', backToVipPage);
    document.getElementById('invoiceBackBtn').addEventListener('click', backToVipPage);
    document.getElementById('scannerBackBtn').addEventListener('click', backToVipPage);
    
    // 登錄/註冊按鈕
    document.getElementById('vipLoginSubmit').addEventListener('click', () => {
        const username = document.getElementById('vipUsername').value.trim();
        const password = document.getElementById('vipPassword').value.trim();
        login(username, password, true);
    });
    document.getElementById('normalLoginSubmit').addEventListener('click', () => {
        const username = document.getElementById('normalUsername').value.trim();
        const password = document.getElementById('normalPassword').value.trim();
        login(username, password);
    });
    document.getElementById('adminLoginSubmit').addEventListener('click', () => {
        const username = document.getElementById('adminUsername').value.trim();
        const password = document.getElementById('adminPassword').value.trim();
        login(username, password, false, true);
    });
    document.getElementById('normalRegisterBtn').addEventListener('click', () => {
        toggleVisibility('normalLoginContainer', false);
        toggleVisibility('registerContainer', true);
    });
    document.getElementById('registerSubmit').addEventListener('click', register);
    
    // VIP功能按鈕
    document.getElementById('checkInBtn').addEventListener('click', vipCheckIn);
    document.getElementById('viewLevelsBtn').addEventListener('click', viewAllLevels);
    document.getElementById('redeemItemsBtn').addEventListener('click', () => {
        document.getElementById('vipContainer').classList.add('hidden');
        document.getElementById('redeemContainer').classList.remove('hidden');
        showRedeemItems();
    });
    document.getElementById('scratchCardBtn').addEventListener('click', () => {
        document.getElementById('vipContainer').classList.add('hidden');
        document.getElementById('scratchCardContainer').classList.remove('hidden');
    });
    document.getElementById('changePasswordBtn').addEventListener('click', () => {
        document.getElementById('vipContainer').classList.add('hidden');
        document.getElementById('changePasswordContainer').classList.remove('hidden');
    });
    document.getElementById('redeemCodeBtn').addEventListener('click', () => {
        document.getElementById('vipContainer').classList.add('hidden');
        document.getElementById('redeemCodeContainer').classList.remove('hidden');
    });
    document.getElementById('aiChatBtn').addEventListener('click', () => {
        document.getElementById('vipContainer').classList.add('hidden');
        document.getElementById('aiChatContainer').classList.remove('hidden');
    });
    document.getElementById('checkUpdatesBtn').addEventListener('click', checkForUpdates);
    document.getElementById('viewReceiptsBtn').addEventListener('click', showReceipts);
    document.getElementById('viewInvoicesBtn').addEventListener('click', showInvoices);
    document.getElementById('logoutBtn').addEventListener('click', logout);
    
    // 其他功能按鈕
    document.getElementById('checkoutBtn').addEventListener('click', checkout);
    document.getElementById('playScratchBtn').addEventListener('click', playScratchCard);
    document.getElementById('changePasswordSubmit').addEventListener('click', changePassword);
    document.getElementById('addAnnouncementBtn').addEventListener('click', addAnnouncement);
    document.getElementById('redeemCodeSubmit').addEventListener('click', redeemCode);
    document.getElementById('sendAiMessageBtn').addEventListener('click', sendAiMessage);
    document.getElementById('addItemBtn').addEventListener('click', addItem);
    document.getElementById('addCodeBtn').addEventListener('click', addCode);
    
    // 輸入框回車事件
    document.getElementById('aiUserInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendAiMessage();
    });
    document.getElementById('redeemCodeInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') redeemCode();
    });
}

// ================= 初始化 =================
function init() {
    loadUpdatesFromStorage();
    updateTime();
    updateAnnouncements();
    checkHolidayCodes();
    initEventListeners();
    
    // 從伺服器同步數據
    syncFromServer();
}

window.onload = init;
</script>
</body>
</html>
