<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¶…ç´šVIPå®¢æˆ¶ç™»éŒ„ç³»çµ±</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            color: #333; 
            margin: 0; 
            padding: 0; 
            background-color: #FFD700;
            font-size: 18px;
        }
        .container { 
            background: rgba(255,255,255,0.9); 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); 
            margin: 20px auto; 
            padding: 20px; 
            max-width: 500px; 
        }
        h2 { text-align: center; color: #b30000; font-size: 24px; }
        h3 { font-size: 20px; }
        input, textarea, select { 
            width: 100%; 
            padding: 10px; 
            margin: 10px 0; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            font-size: 16px;
        }
        button { 
            background-color: #FFA500; 
            color: black; 
            border: none; 
            padding: 10px; 
            border-radius: 4px; 
            cursor: pointer; 
            width: 100%; 
            margin: 5px 0; 
            transition: background-color 0.3s; 
            font-size: 16px;
        }
        button:hover { background-color: #FF8C00; }
        .hidden { display: none; }
        .cart-item { background: #e6ffe6; padding: 10px; margin: 5px 0; border-radius: 4px; }
        .vip-level { 
            font-weight: bold; 
            color: #b30000; 
            margin: 10px 0; 
            text-align: center; 
            font-size: 18px; 
        }
        .progress-container {
            width: 100%;
            background-color: #ddd;
            border-radius: 5px;
            margin: 10px 0;
        }
        .progress-bar {
            height: 20px;
            background-color: #4CAF50;
            border-radius: 5px;
            text-align: center;
            line-height: 20px;
            color: white;
            transition: width 0.3s;
        }
        .level-description {
            margin: 15px 0;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
        .announcement {
            background: #fff3e0;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .announcement-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        .announcement-item:last-child {
            border-bottom: none;
        }
        .announcement-content {
            flex-grow: 1;
        }
        .announcement-date {
            color: #666;
            font-size: 0.8em;
            margin-left: 10px;
        }
        .time-display {
            text-align: center;
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        #barcodeContainer {
            text-align: center;
            margin: 20px 0;
        }
        #scratchCard {
            padding: 20px;
            background: #f0f0f0;
            border-radius: 8px;
            text-align: center;
            margin: 10px 0;
        }
        #updateStatus {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .redeem-code-container {
            margin: 10px 0;
            padding: 10px;
            background: #e6f7ff;
            border-radius: 4px;
        }
        .ai-chat-container {
            margin: 10px 0;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
        }
        .ai-message {
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
        }
        .ai-user {
            background: #e6ffe6;
            text-align: right;
        }
        .ai-bot {
            background: #e6f7ff;
            text-align: left;
        }
        .admin-controls {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        #loginError {
            color: red;
            text-align: center;
            margin: 10px 0;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
</head>
<body>
    <!-- ç™»éŒ„é¸é …é¸æ“‡ç•Œé¢ -->
    <div class="container" id="loginOptionContainer">
        <h2>è«‹é¸æ“‡ç™»éŒ„é¡å‹</h2>
        <button id="vipLoginBtn">VIP æœƒå“¡ç™»éŒ„</button>
        <button id="normalLoginBtn">æ™®é€šå®¢æˆ¶ç™»éŒ„</button>
        <button id="adminLoginBtn">ç®¡ç†å“¡ç™»éŒ„</button>
    </div>

    <!-- VIP ç™»éŒ„ç•Œé¢ -->
    <div class="container hidden" id="vipLoginContainer">
        <h2>VIP æœƒå“¡ç™»éŒ„</h2>
        <input type="text" id="vipUsername" placeholder="VIP å¸³è™Ÿ">
        <input type="password" id="vipPassword" placeholder="VIP å¯†ç¢¼">
        <button id="vipLoginSubmit">VIP ç™»éŒ„</button>
        <button id="vipBackBtn">è¿”å›</button>
    </div>

    <!-- æ™®é€šå®¢æˆ¶ç™»éŒ„ç•Œé¢ -->
    <div class="container hidden" id="normalLoginContainer">
        <h2>æ™®é€šå®¢æˆ¶ç™»éŒ„</h2>
        <input type="text" id="normalUsername" placeholder="ç”¨æˆ¶å">
        <input type="password" id="normalPassword" placeholder="å¯†ç¢¼">
        <div id="loginError"></div>
        <button id="normalLoginSubmit">ç™»éŒ„</button>
        <button id="normalRegisterBtn">è¨»å†Šæ–°å¸³è™Ÿ</button>
        <button id="normalBackBtn">è¿”å›</button>
    </div>

    <!-- ç®¡ç†å“¡ç™»éŒ„ç•Œé¢ -->
    <div class="container hidden" id="adminLoginContainer">
        <h2>ç®¡ç†å“¡ç™»éŒ„</h2>
        <input type="text" id="adminUsername" placeholder="ç®¡ç†å“¡å¸³è™Ÿ">
        <input type="password" id="adminPassword" placeholder="ç®¡ç†å“¡å¯†ç¢¼">
        <button id="adminLoginSubmit">ç®¡ç†å“¡ç™»éŒ„</button>
        <button id="adminBackBtn">è¿”å›</button>
    </div>

    <!-- è¨»å†Šç•Œé¢ -->
    <div class="container hidden" id="registerContainer">
        <h2>è¨»å†Šæ–°å¸³è™Ÿ</h2>
        <input type="text" id="newUsername" placeholder="ç”¨æˆ¶å">
        <input type="password" id="newPassword" placeholder="å¯†ç¢¼">
        <input type="email" id="newEmail" placeholder="é›»å­éƒµä»¶">
        <button id="registerSubmit">è¨»å†Š</button>
        <button id="registerBackBtn">è¿”å›</button>
    </div>

    <!-- VIP åŠŸèƒ½ç•Œé¢ -->
    <div class="container hidden" id="vipContainer">
        <h2 id="vipTitle">VIP æœƒå“¡æ‚¨å¥½ï¼</h2>
        <div id="userAnnouncement" class="announcement">
            <h3>æœ€æ–°å…¬å‘Š</h3>
            <div id="announcementsList"></div>
        </div>
        <div class="time-display" id="userTime"></div>
        
        <div class="vip-level" id="vipLevelDisplay"></div>
        <div class="progress-container">
            <div id="pointsProgress" class="progress-bar"></div>
        </div>
        
        <div class="level-description" id="levelDescription"></div>
        
        <button id="checkInBtn">æ¯æ—¥ç°½åˆ°</button>
        <button id="viewLevelsBtn">æŸ¥çœ‹VIPç­‰ç´š</button>
        <button id="redeemItemsBtn">å…Œæ›å•†å“</button>
        <button id="scratchCardBtn">VIPåˆ®åˆ®æ¨‚</button>
        <button id="changePasswordBtn">æ›´æ”¹å¯†ç¢¼</button>
        <button id="redeemCodeBtn">è¼¸å…¥å…Œæ›ç¢¼</button>
        <button id="aiChatBtn">AIå®¢æœ</button>
        <button id="checkUpdatesBtn">æª¢æŸ¥æ›´æ–°</button>
        <div id="updateStatus"></div>
        <button id="logoutBtn">ç™»å‡º</button>
    </div>

    <!-- å…Œæ›å•†å“ç•Œé¢ -->
    <div class="container hidden" id="redeemContainer">
        <h2>å…Œæ›å•†å“</h2>
        <div id="redeemItemsList"></div>
        <h3>æˆ‘çš„è³¼ç‰©è»Š</h3>
        <div id="cartItems"></div>
        <button id="checkoutBtn">çµå¸³</button>
        <button id="redeemBackBtn">è¿”å›</button>
    </div>

    <!-- åˆ®åˆ®æ¨‚ç•Œé¢ -->
    <div class="container hidden" id="scratchCardContainer">
        <h2>VIPåˆ®åˆ®æ¨‚</h2>
        <div id="scratchCard">
            <p>åˆ®åˆ®æ¨‚éŠæˆ²ï¼Œæœ‰æ©Ÿæœƒè´å¾—å¤§çï¼</p>
            <button id="playScratchBtn">è³¼è²·åˆ®åˆ®æ¨‚ (<span id="scratchCardPrice">10</span> é»)</button>
            <div id="scratchResult"></div>
        </div>
        <button id="scratchBackBtn">è¿”å›</button>
    </div>

    <!-- æ›´æ”¹å¯†ç¢¼ç•Œé¢ -->
    <div class="container hidden" id="changePasswordContainer">
        <h2>æ›´æ”¹å¯†ç¢¼</h2>
        <input type="password" id="oldPassword" placeholder="èˆŠå¯†ç¢¼">
        <input type="password" id="newPassword" placeholder="æ–°å¯†ç¢¼">
        <input type="password" id="confirmPassword" placeholder="ç¢ºèªæ–°å¯†ç¢¼">
        <button id="changePasswordSubmit">æ›´æ”¹å¯†ç¢¼</button>
        <button id="changePasswordBackBtn">è¿”å›</button>
    </div>

    <!-- æ‰€æœ‰VIPç­‰ç´šé¡¯ç¤º -->
    <div class="container hidden" id="allLevelsContainer">
        <h2>VIPç­‰ç´šç³»çµ±</h2>
        <div id="levelsList"></div>
        <button id="levelsBackBtn">è¿”å›</button>
    </div>

    <!-- å…¬å‘Šç®¡ç†ç•Œé¢ (åƒ…ç®¡ç†å“¡å¯è¦‹) -->
    <div class="container hidden" id="announcementManagementContainer">
        <h2>å…¬å‘Šç®¡ç†</h2>
        <div id="announcementListForManagement"></div>
        <h3>æ–°å¢å…¬å‘Š</h3>
        <textarea id="newAnnouncementContent" placeholder="è¼¸å…¥å…¬å‘Šå…§å®¹" rows="3"></textarea>
        <button id="addAnnouncementBtn">ç™¼å¸ƒå…¬å‘Š</button>
        <button id="announcementBackBtn">è¿”å›</button>
    </div>

    <!-- å…Œæ›ç¢¼ç•Œé¢ -->
    <div class="container hidden" id="redeemCodeContainer">
        <h2>è¼¸å…¥å…Œæ›ç¢¼</h2>
        <input type="text" id="redeemCodeInput" placeholder="è¼¸å…¥å…Œæ›ç¢¼">
        <button id="redeemCodeSubmit">å…Œæ›</button>
        <div id="redeemCodeResult"></div>
        <button id="redeemCodeBackBtn">è¿”å›</button>
    </div>

    <!-- AIå®¢æœç•Œé¢ -->
    <div class="container hidden" id="aiChatContainer">
        <h2>AIå®¢æœ</h2>
        <div class="ai-chat-container" id="aiChatMessages">
            <div class="ai-message ai-bot">æ‚¨å¥½ï¼æˆ‘æ˜¯AIå®¢æœï¼Œè«‹å•æœ‰ä»€éº¼å¯ä»¥å¹«åŠ©æ‚¨çš„ï¼Ÿ</div>
        </div>
        <input type="text" id="aiUserInput" placeholder="è¼¸å…¥æ‚¨çš„å•é¡Œ">
        <button id="sendAiMessageBtn">ç™¼é€</button>
        <button id="aiChatBackBtn">è¿”å›</button>
    </div>

    <!-- ç®¡ç†å“¡å•†å“ç®¡ç†ç•Œé¢ -->
    <div class="container hidden" id="itemManagementContainer">
        <h2>å•†å“ç®¡ç†</h2>
        <div id="itemListForManagement"></div>
        <h3>æ–°å¢å•†å“</h3>
        <input type="text" id="newItemName" placeholder="å•†å“åç¨±">
        <input type="number" id="newItemCost" placeholder="æ‰€éœ€é»æ•¸">
        <select id="newItemVipOnly">
            <option value="false">æ‰€æœ‰ç”¨æˆ¶</option>
            <option value="true">åƒ…é™VIP</option>
        </select>
        <button id="addItemBtn">æ–°å¢å•†å“</button>
        <button id="itemBackBtn">è¿”å›</button>
    </div>

    <!-- ç®¡ç†å“¡å…Œæ›ç¢¼ç®¡ç†ç•Œé¢ -->
    <div class="container hidden" id="codeManagementContainer">
        <h2>å…Œæ›ç¢¼ç®¡ç†</h2>
        <div id="codeListForManagement"></div>
        <h3>æ–°å¢å…Œæ›ç¢¼</h3>
        <input type="text" id="newCodeValue" placeholder="å…Œæ›ç¢¼">
        <input type="number" id="newCodePoints" placeholder="é»æ•¸">
        <button id="addCodeBtn">æ–°å¢å…Œæ›ç¢¼</button>
        <button id="codeBackBtn">è¿”å›</button>
    </div>

<script>
// ================= ç³»çµ±é…ç½® =================
const SYSTEM_CONFIG = {
    version: "1.5.1",
    lastUpdate: "2023-11-24",
    configUrl: "https://example.com/vip_system_config.json",
    dataUrl: "https://example.com/vip_system_data.json",
    syncUrl: "https://example.com/vip_system_sync.php"
};

// å°ç£ç¯€æ…¶æ—¥æœŸ (æœˆä»½æ˜¯0-11)
const TAIWAN_HOLIDAYS = [
    { name: "å…ƒæ—¦", date: new Date(new Date().getFullYear(), 0, 1) },
    { name: "æ˜¥ç¯€", date: new Date(new Date().getFullYear(), 1, 10) }, // ç¤ºä¾‹æ—¥æœŸ
    { name: "æ¸…æ˜ç¯€", date: new Date(new Date().getFullYear(), 3, 4) },
    { name: "4/11ç¯€æ…¶", date: new Date(new Date().getFullYear(), 3, 11) }, // æ–°å¢4/11ç¯€æ…¶
    { name: "ç«¯åˆç¯€", date: new Date(new Date().getFullYear(), 5, 14) }, // ç¤ºä¾‹æ—¥æœŸ
    { name: "ä¸­ç§‹ç¯€", date: new Date(new Date().getFullYear(), 8, 29) }, // ç¤ºä¾‹æ—¥æœŸ
    { name: "é›™åç¯€", date: new Date(new Date().getFullYear(), 9, 10) }
];

// VIPç­‰ç´šç³»çµ± (åˆå§‹æ•¸æ“š)
let VIP_LEVELS = [
    { level: 0, name: "æ™®é€šå®¢æˆ¶", points: 0, color: "#000000", emoji: "ğŸ‘¤", discount: 1.0, scratchPrice: 20 },
    { level: 1, name: "æ´»èºå®¢æˆ¶", points: 10000, color: "#2ecc71", emoji: "ğŸ‘", discount: 0.98, scratchPrice: 18 },
    { level: 2, name: "å¿ å¯¦å®¢æˆ¶", points: 25000, color: "#27ae60", emoji: "ğŸ¤", discount: 0.96, scratchPrice: 16 },
    { level: 3, name: "å„ªè³ªå®¢æˆ¶", points: 50000, color: "#3498db", emoji: "â­", discount: 0.94, scratchPrice: 14 },
    { level: 4, name: "ç²¾è‹±å®¢æˆ¶", points: 80000, color: "#2980b9", emoji: "ğŸŒŸ", discount: 0.92, scratchPrice: 12 },
    { level: 5, name: "VIP éŠ…ç´š", points: 100000, color: "#cd7f32", emoji: "ğŸ¥‰", discount: 0.90, scratchPrice: 10 },
    { level: 6, name: "VIP éŠ€ç´š", points: 120000, color: "#c0c0c0", emoji: "ğŸ¥ˆ", discount: 0.88, scratchPrice: 9 },
    { level: 7, name: "VIP é‡‘ç´š", points: 170000, color: "#ffd700", emoji: "ğŸ¥‡", discount: 0.85, scratchPrice: 8 },
    { level: 8, name: "VIP ç™½é‡‘ç´š", points: 230000, color: "#e5e4e2", emoji: "ğŸ’ ", discount: 0.82, scratchPrice: 7 },
    { level: 9, name: "VIP é‘½çŸ³ç´š", points: 300000, color: "#b9f2ff", emoji: "ğŸ’", discount: 0.80, scratchPrice: 6 },
    { level: 10, name: "VIP é»‘é‡‘ç´š", points: 400000, color: "#000000", emoji: "â™ ï¸", discount: 0.77, scratchPrice: 5 }
];

// å¯å…Œæ›å•†å“ (åˆå§‹æ•¸æ“š)
let REDEEM_ITEMS = [
    { id: 1, name: "å’–å•¡åˆ¸", cost: 50, vipOnly: false },
    { id: 2, name: "åˆé¤åˆ¸", cost: 100, vipOnly: false },
    { id: 3, name: "é›»å½±ç¥¨", cost: 200, vipOnly: false },
    { id: 4, name: "VIPå°ˆå±¬ç¦®ç›’", cost: 500, vipOnly: true },
    { id: 5, name: "é«˜ç´šé¤å»³åˆ¸", cost: 1000, vipOnly: true }
];

// å…Œæ›ç¢¼ (åˆå§‹æ•¸æ“š)
let REDEEM_CODES = [
    { code: "WELCOME100", points: 100, usedBy: [] },
    { code: "VIP500", points: 500, usedBy: [], vipOnly: true }
];

// ç”¨æˆ¶æ•¸æ“š
let users = JSON.parse(localStorage.getItem('vipSystemUsers')) || {
    "vip8888": { password: "vip8888", email: "vip8888@vip.com", points: 50000, vipLevel: 1, lastCheckIn: null },
    "001": { password: "001", email: "001@example.com", points: 10000000000000000000, vipLevel: 0, lastCheckIn: null },
    "002": { password: "002", email: "admin@example.com", points: 0, isAdmin: true },
    "test1": { password: "123", email: "test1@example.com", points: 5000, vipLevel: 0, lastCheckIn: null },
    "test2": { password: "123", email: "test2@example.com", points: 15000, vipLevel: 1, lastCheckIn: null },
    "test3": { password: "123", email: "test3@example.com", points: 50000, vipLevel: 3, lastCheckIn: null },
    "test4": { password: "123", email: "test4@example.com", points: 150000, vipLevel: 6, lastCheckIn: null },
    "test5": { password: "123", email: "test5@example.com", points: 500000, vipLevel: 9, lastCheckIn: null }
};

// å…¬å‘Šæ•¸æ“š
let announcements = JSON.parse(localStorage.getItem('vipSystemAnnouncements')) || [
    { id: 1, content: "æ­¡è¿ä½¿ç”¨VIPç³»çµ±ï¼", date: "2023-11-01T10:00:00" },
    { id: 2, content: "ç³»çµ±å°‡æ–¼æ¯é€±ä¸‰é€²è¡Œä¾‹è¡Œç¶­è­·", date: "2023-11-15T14:30:00" }
];

let currentUser = null;
let cart = [];
let aiChatHistory = [];

// ================= ç¯€æ…¶å…Œæ›ç¢¼åŠŸèƒ½ =================
function checkHolidayCodes() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    for (const holiday of TAIWAN_HOLIDAYS) {
        const holidayDate = new Date(holiday.date);
        holidayDate.setHours(0, 0, 0, 0);
        
        // æª¢æŸ¥ç¯€æ…¶ç•¶å¤©åŠå‰å¾Œä¸€å¤©
        const dayBefore = new Date(holidayDate);
        dayBefore.setDate(holidayDate.getDate() - 1);
        
        const dayAfter = new Date(holidayDate);
        dayAfter.setDate(holidayDate.getDate() + 1);
        
        if (today.getTime() === holidayDate.getTime() || 
            today.getTime() === dayBefore.getTime() || 
            today.getTime() === dayAfter.getTime()) {
            
            // ç”Ÿæˆç¯€æ…¶å…Œæ›ç¢¼
            const holidayCode = `HOLIDAY${holiday.name.replace(/\s+/g, '')}${Math.floor(1000 + Math.random() * 9000)}`;
            
            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„å…Œæ›ç¢¼
            const existingCode = REDEEM_CODES.find(c => c.code === holidayCode);
            if (!existingCode) {
                const points = Math.floor(500 + Math.random() * 1500); // 500-2000é»
                REDEEM_CODES.push({
                    code: holidayCode,
                    points: points,
                    usedBy: [],
                    isHoliday: true
                });
                
                // ç™¼å¸ƒå…¬å‘Š
                addAnnouncementFromSystem(`ç¯€æ…¶æ´»å‹•ï¼š${holiday.name}æœŸé–“ï¼Œè¼¸å…¥å…Œæ›ç¢¼ ${holidayCode} å¯ç²å¾— ${points} é»ï¼`);
                
                // åŒæ­¥åˆ°æœ¬åœ°å­˜å„²
                localStorage.setItem('vipSystemCodes', JSON.stringify(REDEEM_CODES));
            }
        }
    }
}

// ================= å…¬å‘ŠåŠŸèƒ½ =================
function updateAnnouncements() {
    const announcementList = document.getElementById('announcementsList');
    announcementList.innerHTML = '';
    
    announcements.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    announcements.forEach(announcement => {
        const announcementDiv = document.createElement('div');
        announcementDiv.className = 'announcement-item';
        
        const date = new Date(announcement.date);
        const formattedDate = date.toLocaleString('zh-TW', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        announcementDiv.innerHTML = `
            <div class="announcement-content">${announcement.content}</div>
            <div class="announcement-date">${formattedDate}</div>
        `;
        announcementList.appendChild(announcementDiv);
    });
}

function loadAnnouncementManagement() {
    const container = document.getElementById('announcementListForManagement');
    container.innerHTML = '';
    
    announcements.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    announcements.forEach(announcement => {
        const announcementDiv = document.createElement('div');
        announcementDiv.className = 'announcement-item';
        
        const date = new Date(announcement.date);
        const formattedDate = date.toLocaleString('zh-TW', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        announcementDiv.innerHTML = `
            <div class="announcement-content">${announcement.content}</div>
            <div class="announcement-date">${formattedDate}</div>
            <button onclick="deleteAnnouncement(${announcement.id})">åˆªé™¤</button>
        `;
        container.appendChild(announcementDiv);
    });
}

function addAnnouncement() {
    const content = document.getElementById('newAnnouncementContent').value.trim();
    if (!content) {
        alert("è«‹è¼¸å…¥å…¬å‘Šå…§å®¹ï¼");
        return;
    }
    
    const newId = announcements.length > 0 ? Math.max(...announcements.map(a => a.id)) + 1 : 1;
    const newAnnouncement = {
        id: newId,
        content: content,
        date: new Date().toISOString()
    };
    
    announcements.unshift(newAnnouncement);
    localStorage.setItem('vipSystemAnnouncements', JSON.stringify(announcements));
    
    document.getElementById('newAnnouncementContent').value = '';
    loadAnnouncementManagement();
    updateAnnouncements();
}

function addAnnouncementFromSystem(content) {
    const newId = announcements.length > 0 ? Math.max(...announcements.map(a => a.id)) + 1 : 1;
    const newAnnouncement = {
        id: newId,
        content: content,
        date: new Date().toISOString(),
        isSystem: true
    };
    
    announcements.unshift(newAnnouncement);
    localStorage.setItem('vipSystemAnnouncements', JSON.stringify(announcements));
    updateAnnouncements();
}

function deleteAnnouncement(id) {
    if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤å…¬å‘Šå—ï¼Ÿ")) return;
    
    announcements = announcements.filter(a => a.id !== id);
    localStorage.setItem('vipSystemAnnouncements', JSON.stringify(announcements));
    
    loadAnnouncementManagement();
    updateAnnouncements();
}

// ================= å…Œæ›ç¢¼åŠŸèƒ½ =================
function redeemCode() {
    const codeInput = document.getElementById('redeemCodeInput').value.trim().toUpperCase();
    const resultDiv = document.getElementById('redeemCodeResult');
    
    if (!codeInput) {
        resultDiv.innerHTML = "<p style='color:red'>è«‹è¼¸å…¥å…Œæ›ç¢¼</p>";
        return;
    }
    
    const redeemCode = REDEEM_CODES.find(c => c.code === codeInput);
    
    if (!redeemCode) {
        resultDiv.innerHTML = "<p style='color:red'>å…Œæ›ç¢¼ç„¡æ•ˆ</p>";
        return;
    }
    
    if (redeemCode.vipOnly && (!currentUser || currentUser.vipLevel <= 0)) {
        resultDiv.innerHTML = "<p style='color:red'>æ­¤å…Œæ›ç¢¼åƒ…é™VIPæœƒå“¡ä½¿ç”¨</p>";
        return;
    }
    
    if (redeemCode.usedBy.includes(currentUser.username)) {
        resultDiv.innerHTML = "<p style='color:red'>æ‚¨å·²ä½¿ç”¨éæ­¤å…Œæ›ç¢¼</p>";
        return;
    }
    
    // å…Œæ›æˆåŠŸ
    currentUser.points += redeemCode.points;
    redeemCode.usedBy.push(currentUser.username);
    users[currentUser.username] = currentUser;
    
    localStorage.setItem('vipSystemUsers', JSON.stringify(users));
    localStorage.setItem('vipSystemCodes', JSON.stringify(REDEEM_CODES));
    
    resultDiv.innerHTML = `<p style='color:green'>å…Œæ›æˆåŠŸï¼ç²å¾— ${redeemCode.points} é»</p>`;
    document.getElementById('redeemCodeInput').value = '';
    
    updateVipDisplay();
}

function loadCodeManagement() {
    const container = document.getElementById('codeListForManagement');
    container.innerHTML = '';
    
    REDEEM_CODES.forEach(code => {
        const codeDiv = document.createElement('div');
        codeDiv.className = 'redeem-code-container';
        
        const usedCount = code.usedBy ? code.usedBy.length : 0;
        const isHoliday = code.isHoliday ? ' (ç¯€æ…¶å…Œæ›ç¢¼)' : '';
        
        codeDiv.innerHTML = `
            <strong>${code.code}</strong> - ${code.points} é»${isHoliday}<br>
            å·²ä½¿ç”¨: ${usedCount} æ¬¡
            <button onclick="deleteCode('${code.code}')">åˆªé™¤</button>
        `;
        container.appendChild(codeDiv);
    });
}

function addCode() {
    const codeValue = document.getElementById('newCodeValue').value.trim().toUpperCase();
    const codePoints = parseInt(document.getElementById('newCodePoints').value);
    
    if (!codeValue || isNaN(codePoints)) {
        alert("è«‹å¡«å¯«å®Œæ•´çš„å…Œæ›ç¢¼è³‡è¨Šï¼");
        return;
    }
    
    if (REDEEM_CODES.some(c => c.code === codeValue)) {
        alert("æ­¤å…Œæ›ç¢¼å·²å­˜åœ¨ï¼");
        return;
    }
    
    REDEEM_CODES.push({
        code: codeValue,
        points: codePoints,
        usedBy: []
    });
    
    localStorage.setItem('vipSystemCodes', JSON.stringify(REDEEM_CODES));
    
    document.getElementById('newCodeValue').value = '';
    document.getElementById('newCodePoints').value = '';
    loadCodeManagement();
}

function deleteCode(code) {
    if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤å…Œæ›ç¢¼å—ï¼Ÿ")) return;
    
    REDEEM_CODES = REDEEM_CODES.filter(c => c.code !== code);
    localStorage.setItem('vipSystemCodes', JSON.stringify(REDEEM_CODES));
    loadCodeManagement();
}

// ================= AIå®¢æœåŠŸèƒ½ =================
function sendAiMessage() {
    const userInput = document.getElementById('aiUserInput').value.trim();
    if (!userInput) return;
    
    // æ·»åŠ ç”¨æˆ¶æ¶ˆæ¯
    addAiMessage(userInput, true);
    document.getElementById('aiUserInput').value = '';
    
    // æ¨¡æ“¬AIå›æ‡‰
    setTimeout(() => {
        let response = "";
        
        // ç°¡å–®çš„é—œéµè©åŒ¹é…
        if (userInput.includes("å•é¡Œ") || userInput.includes("éŒ¯èª¤")) {
            response = "å¾ˆæŠ±æ­‰çµ¦æ‚¨å¸¶ä¾†ä¸ä¾¿ã€‚æˆ‘å€‘å·²è¨˜éŒ„æ‚¨çš„å•é¡Œï¼Œä¸¦å°‡è´ˆé€æ‚¨ 500 é»ä½œç‚ºè£œå„Ÿã€‚";
            
            // è£œå„Ÿé»æ•¸
            if (currentUser) {
                currentUser.points += 500;
                users[currentUser.username] = currentUser;
                localStorage.setItem('vipSystemUsers', JSON.stringify(users));
                updateVipDisplay();
            }
        } 
        else if (userInput.includes("è¬è¬") || userInput.includes("æ„Ÿè¬")) {
            response = "æ„Ÿè¬æ‚¨çš„æ”¯æŒï¼å¦‚æœæœ‰ä»»ä½•å•é¡Œï¼Œè«‹éš¨æ™‚è¯ç¹«æˆ‘å€‘ã€‚";
        }
        else if (userInput.includes("å…Œæ›ç¢¼")) {
            response = "æ‚¨å¯ä»¥åœ¨VIPåŠŸèƒ½ç•Œé¢é»æ“Šã€Œè¼¸å…¥å…Œæ›ç¢¼ã€ä¾†ä½¿ç”¨å…Œæ›ç¢¼ã€‚ç¯€æ…¶æœŸé–“æœƒæœ‰ç‰¹åˆ¥å…Œæ›ç¢¼ç™¼æ”¾ï¼Œè«‹é—œæ³¨å…¬å‘Šï¼";
        }
        else {
            response = "æ„Ÿè¬æ‚¨çš„è©¢å•ã€‚æˆ‘å€‘å·²æ”¶åˆ°æ‚¨çš„æ¶ˆæ¯ï¼Œå°‡ç›¡å¿«ç‚ºæ‚¨è™•ç†ã€‚";
        }
        
        addAiMessage(response, false);
    }, 1000);
}

function addAiMessage(message, isUser) {
    const chatContainer = document.getElementById('aiChatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `ai-message ${isUser ? 'ai-user' : 'ai-bot'}`;
    messageDiv.textContent = message;
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    
    // ä¿å­˜èŠå¤©è¨˜éŒ„
    aiChatHistory.push({
        message: message,
        isUser: isUser,
        time: new Date().toISOString()
    });
}

// ================= å•†å“ç®¡ç†åŠŸèƒ½ =================
function loadItemManagement() {
    const container = document.getElementById('itemListForManagement');
    container.innerHTML = '';
    
    REDEEM_ITEMS.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'cart-item';
        
        itemDiv.innerHTML = `
            <strong>${item.name}</strong> - ${item.cost} é»
            ${item.vipOnly ? '(åƒ…é™VIP)' : ''}
            <button onclick="deleteItem(${item.id})">åˆªé™¤</button>
        `;
        container.appendChild(itemDiv);
    });
}

function addItem() {
    const name = document.getElementById('newItemName').value.trim();
    const cost = parseInt(document.getElementById('newItemCost').value);
    const vipOnly = document.getElementById('newItemVipOnly').value === 'true';
    
    if (!name || isNaN(cost)) {
        alert("è«‹å¡«å¯«å®Œæ•´çš„å•†å“è³‡è¨Šï¼");
        return;
    }
    
    const newId = REDEEM_ITEMS.length > 0 ? Math.max(...REDEEM_ITEMS.map(i => i.id)) + 1 : 1;
    
    REDEEM_ITEMS.push({
        id: newId,
        name: name,
        cost: cost,
        vipOnly: vipOnly
    });
    
    localStorage.setItem('vipSystemItems', JSON.stringify(REDEEM_ITEMS));
    
    document.getElementById('newItemName').value = '';
    document.getElementById('newItemCost').value = '';
    loadItemManagement();
}

function deleteItem(id) {
    if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤å•†å“å—ï¼Ÿ")) return;
    
    REDEEM_ITEMS = REDEEM_ITEMS.filter(i => i.id !== id);
    localStorage.setItem('vipSystemItems', JSON.stringify(REDEEM_ITEMS));
    loadItemManagement();
}

// ================= æ•¸æ“šåŒæ­¥åŠŸèƒ½ =================
function syncDataToServer() {
    // é€™è£¡æ‡‰è©²æ˜¯å¯¦éš›çš„APIèª¿ç”¨ï¼Œä»¥ä¸‹æ˜¯æ¨¡æ“¬å¯¦ç¾
    console.log("åŒæ­¥æ•¸æ“šåˆ°ä¼ºæœå™¨...");
    
    const dataToSync = {
        users: users,
        items: REDEEM_ITEMS,
        codes: REDEEM_CODES,
        announcements: announcements,
        version: SYSTEM_CONFIG.version
    };
    
    // å¯¦éš›æ‡‰ç”¨ä¸­æ‡‰è©²ä½¿ç”¨fetchç™¼é€æ•¸æ“š
    /*
    fetch(SYSTEM_CONFIG.syncUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(dataToSync)
    })
    .then(response => response.json())
    .then(data => {
        console.log("åŒæ­¥æˆåŠŸ:", data);
    })
    .catch(error => {
        console.error("åŒæ­¥éŒ¯èª¤:", error);
    });
    */
}

function syncDataFromServer() {
    // é€™è£¡æ‡‰è©²æ˜¯å¯¦éš›çš„APIèª¿ç”¨ï¼Œä»¥ä¸‹æ˜¯æ¨¡æ“¬å¯¦ç¾
    console.log("å¾ä¼ºæœå™¨åŒæ­¥æ•¸æ“š...");
    
    // æ¨¡æ“¬å¾ä¼ºæœå™¨ç²å–çš„æ•¸æ“š
    const mockServerData = {
        users: users,
        items: REDEEM_ITEMS,
        codes: REDEEM_CODES,
        announcements: announcements,
        version: SYSTEM_CONFIG.version
    };
    
    // å¯¦éš›æ‡‰ç”¨ä¸­æ‡‰è©²ä½¿ç”¨fetchç²å–æ•¸æ“š
    /*
    fetch(SYSTEM_CONFIG.syncUrl)
    .then(response => response.json())
    .then(data => {
        if (data.version > SYSTEM_CONFIG.version) {
            // æ›´æ–°æœ¬åœ°æ•¸æ“š
            users = data.users || users;
            REDEEM_ITEMS = data.items || REDEEM_ITEMS;
            REDEEM_CODES = data.codes || REDEEM_CODES;
            announcements = data.announcements || announcements;
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å„²
            localStorage.setItem('vipSystemUsers', JSON.stringify(users));
            localStorage.setItem('vipSystemItems', JSON.stringify(REDEEM_ITEMS));
            localStorage.setItem('vipSystemCodes', JSON.stringify(REDEEM_CODES));
            localStorage.setItem('vipSystemAnnouncements', JSON.stringify(announcements));
            
            // æ›´æ–°ç•Œé¢
            if (currentUser) {
                updateVipDisplay();
                updateAnnouncements();
            }
            
            console.log("æ•¸æ“šåŒæ­¥å®Œæˆ");
        }
    })
    .catch(error => {
        console.error("åŒæ­¥éŒ¯èª¤:", error);
    });
    */
}

// ================= ç¶²è·¯æ›´æ–°åŠŸèƒ½ =================
function checkForUpdates() {
    document.getElementById('updateStatus').textContent = "æ­£åœ¨æª¢æŸ¥æ›´æ–°...";
    document.getElementById('updateStatus').style.backgroundColor = "#fff3e0";
    
    // æ¨¡æ“¬ç¶²è·¯è«‹æ±‚ç²å–é…ç½®
    setTimeout(() => {
        try {
            // é€™è£¡å¯¦éš›æ‡‰è©²ä½¿ç”¨fetchå¾SYSTEM_CONFIG.configUrlç²å–æ•¸æ“š
            // ä»¥ä¸‹æ˜¯æ¨¡æ“¬æ•¸æ“š
            const mockConfig = {
                version: "1.5.1",
                lastUpdate: "2023-11-24",
                announcements: ["æ–°åŠŸèƒ½ä¸Šç·šï¼šAIå®¢æœç³»çµ±", "æ–°å¢ç¯€æ…¶å…Œæ›ç¢¼åŠŸèƒ½"]
            };
            
            const mockData = {
                levels: [
                    ...VIP_LEVELS,
                    { level: 11, name: "VIP éˆ¦é‡‘ç´š", points: 520000, color: "#878681", emoji: "ğŸ”˜", discount: 0.75, scratchPrice: 4 },
                    { level: 12, name: "VIP é‰‘é‡‘ç´š", points: 650000, color: "#e5e4e2", emoji: "ğŸ”³", discount: 0.72, scratchPrice: 3 }
                ],
                items: [
                    ...REDEEM_ITEMS,
                    { id: 6, name: "è±ªè¯SPAåˆ¸", cost: 800, vipOnly: true },
                    { id: 7, name: "é«˜çˆ¾å¤«é«”é©—", cost: 1500, vipOnly: true }
                ],
                codes: [
                    ...REDEEM_CODES,
                    { code: "UPDATE2023", points: 300, usedBy: [] }
                ]
            };
            
            // æ›´æ–°é…ç½®
            SYSTEM_CONFIG.version = mockConfig.version;
            SYSTEM_CONFIG.lastUpdate = mockConfig.lastUpdate;
            
            // æ›´æ–°æ•¸æ“š
            VIP_LEVELS = mockData.levels;
            REDEEM_ITEMS = mockData.items;
            REDEEM_CODES = mockData.codes;
            
            // æ·»åŠ æ–°å…¬å‘Š
            mockConfig.announcements.forEach(announcement => {
                addAnnouncementFromSystem(announcement);
            });
            
            document.getElementById('updateStatus').textContent = `å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ ${mockConfig.version}`;
            document.getElementById('updateStatus').style.backgroundColor = "#e6ffe6";
            
            // æ›´æ–°ç”¨æˆ¶ç•Œé¢
            if (currentUser) {
                updateVipDisplay();
                updateAnnouncements();
            }
            
            // ä¿å­˜æ›´æ–°å¾Œçš„æ•¸æ“šåˆ°æœ¬åœ°å­˜å„²
            localStorage.setItem('vipSystemConfig', JSON.stringify(SYSTEM_CONFIG));
            localStorage.setItem('vipSystemData', JSON.stringify({
                levels: VIP_LEVELS,
                items: REDEEM_ITEMS,
                codes: REDEEM_CODES
            }));
            
            // åŒæ­¥åˆ°ä¼ºæœå™¨
            syncDataToServer();
            
        } catch (error) {
            document.getElementById('updateStatus').textContent = "æ›´æ–°å¤±æ•—: " + error.message;
            document.getElementById('updateStatus').style.backgroundColor = "#ffe6e6";
        }
    }, 1500);
}

// å¾æœ¬åœ°å­˜å„²åŠ è¼‰æ›´æ–°
function loadUpdatesFromStorage() {
    const savedConfig = localStorage.getItem('vipSystemConfig');
    const savedData = localStorage.getItem('vipSystemData');
    const savedAnnouncements = localStorage.getItem('vipSystemAnnouncements');
    const savedCodes = localStorage.getItem('vipSystemCodes');
    
    if (savedConfig) {
        const config = JSON.parse(savedConfig);
        if (config.version > SYSTEM_CONFIG.version) {
            Object.assign(SYSTEM_CONFIG, config);
        }
    }
    
    if (savedData) {
        const data = JSON.parse(savedData);
        VIP_LEVELS = data.levels || VIP_LEVELS;
        REDEEM_ITEMS = data.items || REDEEM_ITEMS;
        REDEEM_CODES = data.codes || REDEEM_CODES;
    }
    
    if (savedAnnouncements) {
        announcements = JSON.parse(savedAnnouncements);
    }
    
    if (savedCodes) {
        REDEEM_CODES = JSON.parse(savedCodes);
    }
}

// ================= ç”¨æˆ¶ç•Œé¢åŠŸèƒ½ =================
function toggleVisibility(elementId, show) {
    document.getElementById(elementId).classList.toggle('hidden', !show);
}

function updateTime() {
    const now = new Date();
    const timeString = now.toLocaleString('zh-TW');
    document.querySelectorAll('#currentTime, #userTime').forEach(el => {
        if (el) el.textContent = timeString;
    });
    setTimeout(updateTime, 1000);
}

// ================= ç”¨æˆ¶åŠŸèƒ½ =================
function login(username, password, isVip = false, isAdmin = false) {
    if (!username || !password) {
        document.getElementById('loginError').textContent = "è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼ï¼";
        return false;
    }
    
    if (users[username] && users[username].password === password) {
        // æª¢æŸ¥VIPå’Œç®¡ç†å“¡æ¬Šé™
        if ((isVip && users[username].vipLevel <= 0 && !users[username].isAdmin) || 
            (isAdmin && !users[username].isAdmin)) {
            document.getElementById('loginError').textContent = "æ¬Šé™ä¸è¶³ï¼";
            return false;
        }
        
        currentUser = { username, ...users[username] };
        document.getElementById('loginOptionContainer').classList.add('hidden');
        document.getElementById('vipContainer').classList.remove('hidden');
        updateVipDisplay();
        updateAnnouncements();
        
        // å¦‚æœæ˜¯ç®¡ç†å“¡ï¼Œæ·»åŠ ç®¡ç†æŒ‰éˆ•
        if (currentUser.isAdmin) {
            const levelDescription = document.getElementById('levelDescription');
            
            // æ¸…é™¤ç¾æœ‰æŒ‰éˆ•
            levelDescription.querySelectorAll('button').forEach(btn => btn.remove());
            
            // å…¬å‘Šç®¡ç†æŒ‰éˆ•
            const announcementButton = document.createElement('button');
            announcementButton.textContent = "å…¬å‘Šç®¡ç†";
            announcementButton.onclick = function() {
                toggleVisibility('announcementManagementContainer', true);
                loadAnnouncementManagement();
            };
            levelDescription.appendChild(announcementButton);
            
            // å•†å“ç®¡ç†æŒ‰éˆ•
            const itemButton = document.createElement('button');
            itemButton.textContent = "å•†å“ç®¡ç†";
            itemButton.onclick = function() {
                toggleVisibility('itemManagementContainer', true);
                loadItemManagement();
            };
            levelDescription.appendChild(itemButton);
            
            // å…Œæ›ç¢¼ç®¡ç†æŒ‰éˆ•
            const codeButton = document.createElement('button');
            codeButton.textContent = "å…Œæ›ç¢¼ç®¡ç†";
            codeButton.onclick = function() {
                toggleVisibility('codeManagementContainer', true);
                loadCodeManagement();
            };
            levelDescription.appendChild(codeButton);
        }
        
        return true;
    } else {
        document.getElementById('loginError').textContent = "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ï¼";
        return false;
    }
}

function register() {
    const username = document.getElementById('newUsername').value.trim();
    const password = document.getElementById('newPassword').value.trim();
    const email = document.getElementById('newEmail').value.trim();
    
    if (!username || !password || !email) {
        alert("è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ï¼");
        return;
    }
    
    if (users[username]) {
        alert("ç”¨æˆ¶åå·²å­˜åœ¨ï¼");
        return;
    }
    
    users[username] = { 
        password, 
        email,
        points: 0,
        vipLevel: 0,
        lastCheckIn: null
    };
    
    localStorage.setItem('vipSystemUsers', JSON.stringify(users));
    alert("è¨»å†ŠæˆåŠŸï¼");
    toggleVisibility('registerContainer', false);
}

function logout() {
    currentUser = null;
    document.getElementById('vipContainer').classList.add('hidden');
    document.getElementById('loginOptionContainer').classList.remove('hidden');
    document.getElementById('normalUsername').value = "";
    document.getElementById('normalPassword').value = "";
    document.getElementById('loginError').textContent = "";
}

function changePassword() {
    const oldPassword = document.getElementById('oldPassword').value.trim();
    const newPassword = document.getElementById('newPassword').value.trim();
    const confirmPassword = document.getElementById('confirmPassword').value.trim();
    
    if (!oldPassword || !newPassword || !confirmPassword) {
        alert("è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ï¼");
        return;
    }
    
    if (newPassword !== confirmPassword) {
        alert("æ–°å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ç¬¦ï¼");
        return;
    }
    
    if (currentUser.password !== oldPassword) {
        alert("èˆŠå¯†ç¢¼éŒ¯èª¤ï¼");
        return;
    }
    
    currentUser.password = newPassword;
    users[currentUser.username] = currentUser;
    localStorage.setItem('vipSystemUsers', JSON.stringify(users));
    alert("å¯†ç¢¼æ›´æ”¹æˆåŠŸï¼");
    toggleVisibility('changePasswordContainer', false);
}

// ================= VIPåŠŸèƒ½ =================
function updateVipDisplay() {
    if (!currentUser) return;
    
    const userLevel = getUserLevel(currentUser.points);
    const nextLevel = VIP_LEVELS.find(level => level.level === userLevel.level + 1);
    
    document.getElementById('vipTitle').textContent = 
        `${userLevel.emoji} ${userLevel.name} ${currentUser.username} æ‚¨å¥½ï¼`;
    
    document.getElementById('vipLevelDisplay').innerHTML = `
        <span style="color: ${userLevel.color}">${userLevel.name} (ç­‰ç´š ${userLevel.level})</span><br>
        ç•¶å‰é»æ•¸: ${currentUser.points.toLocaleString()}
    `;
    
    if (nextLevel) {
        const progress = ((currentUser.points - userLevel.points) / (nextLevel.points - userLevel.points)) * 100;
        document.getElementById('pointsProgress').style.width = `${progress}%`;
        document.getElementById('pointsProgress').textContent = `${Math.floor(progress)}%`;
        
        document.getElementById('levelDescription').innerHTML = `
            <strong>ä¸‹ä¸€ç­‰ç´š:</strong> ${nextLevel.name} (éœ€è¦ ${(nextLevel.points - currentUser.points).toLocaleString()} é»)<br>
            <strong>æŠ˜æ‰£å„ªæƒ :</strong> ${Math.floor(userLevel.discount * 100)}æŠ˜<br>
            <strong>åˆ®åˆ®æ¨‚åƒ¹æ ¼:</strong> ${userLevel.scratchPrice} é»
        `;
        
        document.getElementById('scratchCardPrice').textContent = userLevel.scratchPrice;
    } else {
        document.getElementById('pointsProgress').style.width = "100%";
        document.getElementById('pointsProgress').textContent = "MAX";
        document.getElementById('levelDescription').innerHTML = `
            <strong>æ‚¨å·²é”åˆ°æœ€é«˜ç­‰ç´šï¼</strong><br>
            <strong>æŠ˜æ‰£å„ªæƒ :</strong> ${Math.floor(userLevel.discount * 100)}æŠ˜
        `;
    }
    
    // æ›´æ–°ç°½åˆ°æŒ‰éˆ•ç‹€æ…‹
    const checkInBtn = document.getElementById('checkInBtn');
    if (isCheckedInToday()) {
        checkInBtn.disabled = true;
        checkInBtn.textContent = "ä»Šæ—¥å·²ç°½åˆ°";
    } else {
        checkInBtn.disabled = false;
        checkInBtn.textContent = `æ¯æ—¥ç°½åˆ° (${Math.floor(userLevel.points * 0.02)} é»)`;
    }
}

function getUserLevel(points) {
    for (let i = VIP_LEVELS.length - 1; i >= 0; i--) {
        if (points >= VIP_LEVELS[i].points) {
            return VIP_LEVELS[i];
        }
    }
    return VIP_LEVELS[0];
}

function isCheckedInToday() {
    if (!currentUser.lastCheckIn) return false;
    const lastCheckIn = new Date(currentUser.lastCheckIn);
    const today = new Date();
    return lastCheckIn.toDateString() === today.toDateString();
}

function vipCheckIn() {
    if (isCheckedInToday()) {
        alert("ä»Šæ—¥å·²ç°½åˆ°ï¼");
        return;
    }
    
    const userLevel = getUserLevel(currentUser.points);
    const pointsToAdd = Math.floor(userLevel.points * 0.02); // ç²å¾—ç•¶å‰ç­‰ç´šæ‰€éœ€é»æ•¸çš„2%
    
    currentUser.points += pointsToAdd;
    currentUser.lastCheckIn = new Date().toISOString();
    currentUser.vipLevel = userLevel.level;
    
    users[currentUser.username] = currentUser;
    localStorage.setItem('vipSystemUsers', JSON.stringify(users));
    
    updateVipDisplay();
    alert(`ç°½åˆ°æˆåŠŸï¼ç²å¾— ${pointsToAdd.toLocaleString()} é»ï¼`);
}

// ================= å…Œæ›å•†å“åŠŸèƒ½ =================
function showRedeemItems() {
    const container = document.getElementById('redeemItemsList');
    container.innerHTML = "";
    
    REDEEM_ITEMS.forEach(item => {
        if (!item.vipOnly || (currentUser && currentUser.vipLevel > 0)) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'cart-item';
            itemDiv.innerHTML = `
                <strong>${item.name}</strong> - ${item.cost} é»
                <button class="addToCartBtn" data-id="${item.id}">åŠ å…¥è³¼ç‰©è»Š</button>
            `;
            container.appendChild(itemDiv);
        }
    });
    
    // ç‚ºæ‰€æœ‰åŠ å…¥è³¼ç‰©è»ŠæŒ‰éˆ•æ·»åŠ äº‹ä»¶ç›£è½
    document.querySelectorAll('.addToCartBtn').forEach(btn => {
        btn.addEventListener('click', function() {
            addToCart(parseInt(this.getAttribute('data-id')));
        });
    });
    
    updateCartDisplay();
}

function addToCart(itemId) {
    const item = REDEEM_ITEMS.find(i => i.id === itemId);
    if (!item) return;
    
    cart.push(item);
    updateCartDisplay();
}

function removeFromCart(index) {
    cart.splice(index, 1);
    updateCartDisplay();
}

function updateCartDisplay() {
    const container = document.getElementById('cartItems');
    container.innerHTML = "";
    
    if (cart.length === 0) {
        container.innerHTML = "<p>è³¼ç‰©è»Šæ˜¯ç©ºçš„</p>";
        return;
    }
    
    let total = 0;
    const userLevel = getUserLevel(currentUser.points);
    
    cart.forEach((item, index) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'cart-item';
        const discountedPrice = Math.floor(item.cost * userLevel.discount);
        itemDiv.innerHTML = `
            <strong>${item.name}</strong> - 
            åŸåƒ¹: ${item.cost} é» | 
            æŠ˜æ‰£åƒ¹: ${discountedPrice} é»
            <button class="removeFromCartBtn" data-index="${index}">ç§»é™¤</button>
        `;
        container.appendChild(itemDiv);
        total += discountedPrice;
    });
    
    // ç‚ºæ‰€æœ‰ç§»é™¤æŒ‰éˆ•æ·»åŠ äº‹ä»¶ç›£è½
    document.querySelectorAll('.removeFromCartBtn').forEach(btn => {
        btn.addEventListener('click', function() {
            removeFromCart(parseInt(this.getAttribute('data-index')));
        });
    });
    
    const totalDiv = document.createElement('div');
    totalDiv.innerHTML = `<strong>ç¸½è¨ˆ: ${total} é»</strong>`;
    container.appendChild(totalDiv);
}

function checkout() {
    if (cart.length === 0) {
        alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼");
        return;
    }
    
    const userLevel = getUserLevel(currentUser.points);
    let total = 0;
    
    cart.forEach(item => {
        total += Math.floor(item.cost * userLevel.discount);
    });
    
    if (currentUser.points < total) {
        alert("é»æ•¸ä¸è¶³ï¼");
        return;
    }
    
    currentUser.points -= total;
    users[currentUser.username] = currentUser;
    localStorage.setItem('vipSystemUsers', JSON.stringify(users));
    
    // ç”Ÿæˆæ¢ç¢¼æ”¶æ“š
    const barcodeData = `VIPCHECKOUT:${currentUser.username}:${new Date().getTime()}:${total}`;
    generateBarcode(barcodeData, 'cartItems');
    
    alert(`è³¼è²·æˆåŠŸï¼æ‰£é™¤ ${total} é»\næ¢ç¢¼å·²ç”Ÿæˆï¼Œè«‹å‡ºç¤ºçµ¦å·¥ä½œäººå“¡æƒæã€‚`);
    cart = [];
    updateCartDisplay();
    updateVipDisplay();
}

function generateBarcode(data, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = `<svg id="barcode"></svg>`;
    JsBarcode("#barcode", data, {
        format: "CODE128",
        displayValue: true,
        fontSize: 16,
        lineColor: "#000",
        width: 2,
        height: 50
    });
}

// ================= åˆ®åˆ®æ¨‚åŠŸèƒ½ =================
function playScratchCard() {
    const userLevel = getUserLevel(currentUser.points);
    const price = userLevel.scratchPrice;
    
    if (currentUser.points < price) {
        alert("é»æ•¸ä¸è¶³ï¼");
        return;
    }
    
    currentUser.points -= price;
    users[currentUser.username] = currentUser;
    localStorage.setItem('vipSystemUsers', JSON.stringify(users));
    
    // éš¨æ©Ÿçå‹µ (0.5x-5xåƒ¹æ ¼)
    const rewardMultiplier = 0.5 + Math.random() * 4.5;
    const reward = Math.floor(price * rewardMultiplier);
    currentUser.points += reward;
    
    users[currentUser.username] = currentUser;
    localStorage.setItem('vipSystemUsers', JSON.stringify(users));
    
    document.getElementById('scratchResult').innerHTML = `
        <h3>æ­å–œæ‚¨ï¼</h3>
        <p>ç²å¾— ${reward} é»çå‹µï¼</p>
        <p>ç•¶å‰é»æ•¸: ${currentUser.points.toLocaleString()}</p>
    `;
    
    updateVipDisplay();
}

// ================= VIPç­‰ç´šæŸ¥çœ‹ =================
function viewAllLevels() {
    document.getElementById('vipContainer').classList.add('hidden');
    document.getElementById('allLevelsContainer').classList.remove('hidden');
    
    const container = document.getElementById('levelsList');
    container.innerHTML = "";
    
    VIP_LEVELS.forEach(level => {
        const levelDiv = document.createElement('div');
        levelDiv.className = "level-description";
        levelDiv.style.borderLeft = `5px solid ${level.color}`;
        
        const isCurrentLevel = currentUser && getUserLevel(currentUser.points).level === level.level;
        const isNextLevel = currentUser && getUserLevel(currentUser.points).level + 1 === level.level;
        
        levelDiv.innerHTML = `
            <strong style="color: ${level.color}">${level.emoji} ${level.name}</strong>
            ${isCurrentLevel ? '<span style="color:red"> (ç•¶å‰ç­‰ç´š)</span>' : ''}
            ${isNextLevel ? '<span style="color:blue"> (ä¸‹ä¸€ç­‰ç´š)</span>' : ''}<br>
            ç­‰ç´š: ${level.level} | éœ€æ±‚é»æ•¸: ${level.points.toLocaleString()}<br>
            æŠ˜æ‰£: ${Math.floor(level.discount * 100)}æŠ˜ | åˆ®åˆ®æ¨‚: ${level.scratchPrice} é»
        `;
        container.appendChild(levelDiv);
    });
}

function backToVipPage() {
    document.getElementById('allLevelsContainer').classList.add('hidden');
    document.getElementById('vipContainer').classList.remove('hidden');
}

// ================= åˆå§‹åŒ–äº‹ä»¶ç›£è½ =================
function initEventListeners() {
    // ç™»éŒ„é¸é …æŒ‰éˆ•
    document.getElementById('vipLoginBtn').addEventListener('click', () => {
        toggleVisibility('loginOptionContainer', false);
        toggleVisibility('vipLoginContainer', true);
    });
    document.getElementById('normalLoginBtn').addEventListener('click', () => {
        toggleVisibility('loginOptionContainer', false);
        toggleVisibility('normalLoginContainer', true);
    });
    document.getElementById('adminLoginBtn').addEventListener('click', () => {
        toggleVisibility('loginOptionContainer', false);
        toggleVisibility('adminLoginContainer', true);
    });
    
    // è¿”å›æŒ‰éˆ•
    document.getElementById('vipBackBtn').addEventListener('click', () => backToLoginOptions());
    document.getElementById('normalBackBtn').addEventListener('click', () => backToLoginOptions());
    document.getElementById('adminBackBtn').addEventListener('click', () => backToLoginOptions());
    document.getElementById('registerBackBtn').addEventListener('click', () => {
        toggleVisibility('registerContainer', false);
        toggleVisibility('normalLoginContainer', true);
    });
    document.getElementById('redeemBackBtn').addEventListener('click', () => toggleVisibility('redeemContainer', false));
    document.getElementById('scratchBackBtn').addEventListener('click', () => toggleVisibility('scratchCardContainer', false));
    document.getElementById('changePasswordBackBtn').addEventListener('click', () => toggleVisibility('changePasswordContainer', false));
    document.getElementById('levelsBackBtn').addEventListener('click', () => backToVipPage());
    document.getElementById('announcementBackBtn').addEventListener('click', () => toggleVisibility('announcementManagementContainer', false));
    document.getElementById('redeemCodeBackBtn').addEventListener('click', () => toggleVisibility('redeemCodeContainer', false));
    document.getElementById('aiChatBackBtn').addEventListener('click', () => toggleVisibility('aiChatContainer', false));
    document.getElementById('itemBackBtn').addEventListener('click', () => toggleVisibility('itemManagementContainer', false));
    document.getElementById('codeBackBtn').addEventListener('click', () => toggleVisibility('codeManagementContainer', false));
    
    // ç™»éŒ„/è¨»å†ŠæŒ‰éˆ•
    document.getElementById('vipLoginSubmit').addEventListener('click', () => {
        const username = document.getElementById('vipUsername').value.trim();
        const password = document.getElementById('vipPassword').value.trim();
        login(username, password, true);
    });
    document.getElementById('normalLoginSubmit').addEventListener('click', () => {
        const username = document.getElementById('normalUsername').value.trim();
        const password = document.getElementById('normalPassword').value.trim();
        login(username, password);
    });
    document.getElementById('adminLoginSubmit').addEventListener('click', () => {
        const username = document.getElementById('adminUsername').value.trim();
        const password = document.getElementById('adminPassword').value.trim();
        login(username, password, false, true);
    });
    document.getElementById('normalRegisterBtn').addEventListener('click', () => {
        toggleVisibility('normalLoginContainer', false);
        toggleVisibility('registerContainer', true);
    });
    document.getElementById('registerSubmit').addEventListener('click', register);
    
    // VIPåŠŸèƒ½æŒ‰éˆ•
    document.getElementById('checkInBtn').addEventListener('click', vipCheckIn);
    document.getElementById('viewLevelsBtn').addEventListener('click', viewAllLevels);
    document.getElementById('redeemItemsBtn').addEventListener('click', () => {
        toggleVisibility('redeemContainer', true);
        showRedeemItems();
    });
    document.getElementById('scratchCardBtn').addEventListener('click', () => toggleVisibility('scratchCardContainer', true));
    document.getElementById('changePasswordBtn').addEventListener('click', () => toggleVisibility('changePasswordContainer', true));
    document.getElementById('redeemCodeBtn').addEventListener('click', () => toggleVisibility('redeemCodeContainer', true));
    document.getElementById('aiChatBtn').addEventListener('click', () => toggleVisibility('aiChatContainer', true));
    document.getElementById('checkUpdatesBtn').addEventListener('click', checkForUpdates);
    document.getElementById('logoutBtn').addEventListener('click', logout);
    
    // å…¶ä»–åŠŸèƒ½æŒ‰éˆ•
    document.getElementById('checkoutBtn').addEventListener('click', checkout);
    document.getElementById('playScratchBtn').addEventListener('click', playScratchCard);
    document.getElementById('changePasswordSubmit').addEventListener('click', changePassword);
    document.getElementById('addAnnouncementBtn').addEventListener('click', addAnnouncement);
    document.getElementById('redeemCodeSubmit').addEventListener('click', redeemCode);
    document.getElementById('sendAiMessageBtn').addEventListener('click', sendAiMessage);
    document.getElementById('addItemBtn').addEventListener('click', addItem);
    document.getElementById('addCodeBtn').addEventListener('click', addCode);
    
    // è¼¸å…¥æ¡†å›è»Šäº‹ä»¶
    document.getElementById('aiUserInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendAiMessage();
    });
    document.getElementById('redeemCodeInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') redeemCode();
    });
}

// ================= åˆå§‹åŒ– =================
function init() {
    loadUpdatesFromStorage();
    updateTime();
    updateAnnouncements();
    checkHolidayCodes();
    initEventListeners();
    
    // å¾ä¼ºæœå™¨åŒæ­¥æ•¸æ“š
    syncDataFromServer();
}

window.onload = init;
</script>
</body>
</html>
